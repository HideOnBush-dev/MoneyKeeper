{% extends "base.html" %} {% block content %}
<div class="pb-32 sm:pb-0">
  <div class="animate__animated animate__fadeIn max-w-lg mx-auto">
    <div
      class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-t-xl p-6"
    >
      <h1 class="text-2xl font-bold flex items-center">
        <svg
          class="w-6 h-6 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
          />
        </svg>
        Th√™m giao d·ªãch m·ªõi
      </h1>
    </div>

    <div class="bg-white rounded-b-xl shadow-lg">
      <form
        method="POST"
        enctype="multipart/form-data"
        class="divide-y divide-gray-200"
      >
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
          {{ form.hidden_tag() }}

          <div
            class="sticky top-0 z-10 bg-white -mx-4 px-4 py-2 sm:static sm:p-0"
          >
            <div class="flex rounded-lg bg-gray-100 p-1">
              <button
                type="button"
                onclick="toggleTransactionType('expense')"
                class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 expense-toggle active"
              >
                Chi ti√™u
              </button>
              <button
                type="button"
                onclick="toggleTransactionType('income')"
                class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 income-toggle"
              >
                Thu nh·∫≠p
              </button>
            </div>
            {{ form.is_expense(class="hidden") }}
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Ch·ªçn v√≠</label
            >
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-lg">üíº</span>
              </div>
              {{ form.wallet_id(class="pl-10 block w-full rounded-lg
              border-gray-300 focus:ring-green-500 focus:border-green-500 py-3")
              }}
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >S·ªë ti·ªÅn</label
            >
            <div class="relative rounded-lg shadow-sm">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500">‚Ç´</span>
              </div>
              {{ form.amount(class="pl-8 pr-12 block w-full text-xl rounded-lg
              border-gray-300 focus:ring-green-500 focus:border-green-500 py-4",
              placeholder="0", inputmode="decimal", pattern="[0-9]*.*[0-9]*",
              step="any") }}
              <button
                type="button"
                onclick="startVoiceInput()"
                class="absolute inset-y-0 right-0 px-4 flex items-center bg-gray-50 rounded-r-lg hover:bg-gray-100"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
            <button
              type="button"
              onclick="setAmount(20000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              20,000‚Ç´
            </button>
            <button
              type="button"
              onclick="setAmount(50000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              50,000‚Ç´
            </button>
            <button
              type="button"
              onclick="setAmount(100000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              100,000‚Ç´
            </button>
            <button
              type="button"
              onclick="setAmount(200000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              200,000‚Ç´
            </button>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Danh m·ª•c</label
            >
            <div class="grid grid-cols-4 gap-2 sm:grid-cols-4 sm:gap-3">
              {% for value, label in form.category.choices %}
              <button
                type="button"
                onclick="setCategory('{{ value }}')"
                class="category-btn flex flex-col items-center p-2 sm:p-4 rounded-lg border"
              >
                <span class="text-xl sm:text-2xl mb-1 sm:mb-2"
                  >{{ category_icons[value] }}</span
                >
                <span class="text-[10px] sm:text-xs">{{ label }}</span>
              </button>
              {% endfor %}
            </div>
            {{ form.category(class="hidden") }}
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Ghi ch√∫</label
            >
            <div class="relative">
              {{ form.description(class="block w-full rounded-lg border-gray-300
              focus:ring-green-500 focus:border-green-500 py-3", rows="3",
              placeholder="Th√™m ghi ch√∫...", autocapitalize="sentences") }}
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >H√≥a ƒë∆°n (t√πy ch·ªçn)</label
            >
            <div
              class="flex justify-center px-6 py-4 border-2 border-gray-300 border-dashed rounded-lg hover:border-green-500 transition-colors"
            >
              <div class="space-y-1 text-center">
                <div class="flex text-sm text-gray-600">
                  <label
                    class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500"
                  >
                    <span>T·∫£i ·∫£nh l√™n</span>
                    {{ form.receipt(class="sr-only", accept="image/*",
                    capture="environment") }}
                  </label>
                </div>
              </div>
            </div>

            <div
              id="receiptPreview"
              class="hidden mt-4 bg-green-50 border border-green-200 rounded-lg p-4"
            >
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <svg
                    class="h-5 w-5 text-green-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-green-800">
                    ƒê√£ qu√©t h√≥a ƒë∆°n th√†nh c√¥ng
                  </h3>
                  <div class="mt-2 text-sm text-green-700">
                    <p id="receiptAmount"></p>
                    <p id="receiptDate"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 sm:relative sm:border-t-0 sm:p-6 sm:bg-transparent"
        >
          <div class="flex gap-3 max-w-lg mx-auto">
            <a
              href="{{ url_for('main.expenses') }}"
              class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50"
            >
              H·ªßy
            </a>
            {{ form.submit(class="flex-1 py-3 px-4 border border-transparent
            rounded-lg text-white bg-green-600 hover:bg-green-700") }}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function formatMoney(input) {
    let value = input.replace(/\D/g, '');
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function parseMoney(str) {
    return parseInt(str.replace(/\./g, '')) || 0;
  }

  function setAmount(amount) {
    document.getElementById("amount").value = formatMoney(amount.toString());
    document.querySelectorAll(".amount-btn").forEach((btn) => {
      btn.classList.remove("bg-green-100", "text-green-800");
    });
    event.target.classList.add("bg-green-100", "text-green-800");
  }

  document.getElementById('amount').addEventListener('input', function(e) {
    let value = formatMoney(e.target.value);
    e.target.value = value;
  });

  document.querySelector('form').addEventListener('submit', function(e) {
    const amountInput = document.getElementById('amount');
    amountInput.value = parseMoney(amountInput.value);
  });

  function setCategory(category) {
    document.getElementById("category").value = category;
    document.querySelectorAll(".category-btn").forEach((btn) => {
      btn.classList.remove(
        "bg-green-100",
        "text-green-800",
        "border-green-500"
      );
    });
    event.target.classList.add(
      "bg-green-100",
      "text-green-800",
      "border-green-500"
    );
    updateCategoryIcon(category);
  }

  function updateCategoryIcon(category) {
    const icons = {
      food: "üçú",
      transport: "üöó",
      shopping: "üõçÔ∏è",
      entertainment: "üéÆ",
      bills: "üìÑ",
      health: "üíä",
      other: "üìù",
    };
    document.getElementById("categoryIcon").textContent =
      icons[category] || "üìù";
  }

  function startVoiceInput() {
    if ("webkitSpeechRecognition" in window) {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "vi-VN";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        const amountMatch = transcript.match(
          /(\d+(\s*ngh√¨n|\s*tri·ªáu|\s*t·ª∑)?)/i
        );
        if (amountMatch) {
          const amount = convertVietnameseCurrency(amountMatch[0]);
          document.getElementById("amount").value = formatMoney(amount.toString());
        }
      };

      recognition.start();
    } else {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠p gi·ªçng n√≥i");
    }
  }

  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function convertVietnameseCurrency(str) {
    str.toLowerCase().trim();
    let amount = parseFloat(str.replace(/[^\d]/g, ""));

    if (str.includes("ngh√¨n") || str.includes("ng√†n")) {
      amount *= 1000;
    } else if (str.includes("tri·ªáu")) {
      amount *= 1000000;
    } else if (str.includes("t·ª∑")) {
      amount *= 1000000000;
    }

    return amount;
  }

  document
    .getElementById("receipt")
    .addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("receipt", file);

      try:
        const response = await fetch("/process_receipt", {
          method: "POST",
          body:formData,
        });

        const data = await response.json();

        if (data.amount) {
          document.getElementById("amount").value = data.amount;
        }

        document.getElementById("receiptPreview").classList.remove("hidden");
        document.getElementById(
          "receiptAmount"
        ).textContent = `S·ªë ti·ªÅn: ${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(data.amount)}`;

        if (data.date) {
          document.getElementById(
            "receiptDate"
          ).textContent = `Ng√†y: ${new Date(data.date).toLocaleDateString(
            "vi-VN"
          )}`;
        }
      } catch (error) {
        console.error("Error processing receipt:", error);
      }
    });

  document
    .getElementById("description")
    .addEventListener("blur", async function (e) {
      const description = e.target.value;
      if (!description) return;

      try:
        const response = await fetch("/ai/suggest_category", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ description: description }),
        });

        const data = await response.json();
        if (data.category) {
          document.getElementById("category").value = data.category;
          showToast("ƒê√£ t·ª± ƒë·ªông ch·ªçn danh m·ª•c ph√π h·ª£p ü§ñ", "success");
        }
      } catch (error) {
        console.error("Error suggesting category:", error);
      }
    });

  document.getElementById("amount").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value;
  });

  document.getElementById("category").addEventListener("change", function (e) {
    updateCategoryIcon(e.target.value);
  });

  document.addEventListener("DOMContentLoaded", function () {
    updateCategoryIcon(document.getElementById("category").value);
  });

  function toggleTransactionType(type) {
    const isExpense = type === "expense";
    document.getElementById("is_expense").value = isExpense;

    const expenseBtn = document.querySelector(".expense-toggle");
    const incomeBtn = document.querySelector(".income-toggle");

    if (isExpense) {
      expenseBtn.classList.add("bg-green-100", "text-green-800");
      incomeBtn.classList.remove("bg-green-100", "text-green-800");
    } else {
      incomeBtn.classList.add("bg-green-100", "text-green-800");
      expenseBtn.classList.remove("bg-green-100", "text-green-800");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const isExpense = document.getElementById("is_expense").value === "True";
    toggleTransactionType(isExpense ? "expense" : "income");
  });
</script>
{% endblock %}
