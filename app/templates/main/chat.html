{% extends "base.html" %}

{% block content %}  <!-- THIS IS CRUCIAL: Make sure you have this line -->
{% if current_user.is_authenticated %}
<div class="animate__animated animate__fadeIn">
  <!-- Main container with proper desktop height -->
  <div class="fixed inset-0 md:static flex flex-col bg-gray-50 md:h-[85vh] md:mx-auto md:max-w-4xl md:rounded-xl md:shadow-lg">

    <!-- Header -->
    <div class="flex-none bg-white border-b border-gray-200 px-4 py-3 md:rounded-t-xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl font-semibold">
            AI
          </div>
          <div>
            <h2 class="font-semibold text-gray-800">MoneyKeeper AI</h2>
            <p class="text-sm text-gray-500">Tr·ª£ l√Ω t√†i ch√≠nh c·ªßa b·∫°n</p>
          </div>
        </div>
        <!-- Personality selector -->
        <select id="aiPersonality" onchange="updateSessionPersonality()"
          class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="friendly" {% if session.personality == 'friendly' %}selected{% endif %}>Th√¢n thi·ªán ü§ó</option>
          <option value="strict" {% if session.personality == 'strict' %}selected{% endif %}>Nghi√™m kh·∫Øc üò§</option>
          <option value="funny" {% if session.personality == 'funny' %}selected{% endif %}>H√†i h∆∞·ªõc üòé</option>
        </select>

      </div>
    </div>


      <!-- Chat Messages -->
    <div id="chatMessages" class="flex-1 overflow-y-auto space-y-3 px-4 pt-4 pb-[150px] md:pb-28 custom-scrollbar">
        {% for message in messages %}
        <div class="flex {% if message.is_user %}justify-end{% else %}justify-start{% endif %}">
            <div
                class="{% if message.is_user %}bg-blue-600 text-white rounded-bl-none {% else %}bg-gray-100 text-gray-800 rounded-br-none{% endif %} rounded-2xl px-4 py-2 max-w-[85%] md:max-w-[70%] shadow-sm message-bubble">
                {{ message.content }}  <!--  This is where the Markdown will be rendered -->
            </div>
        </div>
        {% endfor %}
    </div>

      <!-- Typing Indicator (moved outside chat messages) -->
    <div id="typingIndicator" class="hidden fixed bottom-[120px] md:bottom-[140px] left-0 right-0 px-4">
        <div class="flex justify-start">
            <div class="bg-white rounded-2xl px-4 py-2 shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                    </div>
                    <span class="text-sm text-gray-600">MoneyKeeper AI ƒëang tr·∫£ l·ªùi...</span>
                </div>
            </div>
        </div>
    </div>


    <!-- Fixed bottom container -->
    <div
      class="fixed inset-x-0 bottom-[56px] md:static bg-white border-t border-gray-200 z-50"
    >
      <!-- Quick actions with horizontal scroll -->
      <div
        class="overflow-x-auto flex gap-2 p-2 hide-scrollbar border-b border-gray-100"
      >
       <button
          onclick="askQuestion('Ph√¢n t√≠ch chi ti√™u c·ªßa t√¥i')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          üìä Ph√¢n t√≠ch chi ti√™u
        </button>
        <button
          onclick="askQuestion('L√†m sao ƒë·ªÉ ti·∫øt ki·ªám ti·ªÅn')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          üí∞ Ti·∫øt ki·ªám
        </button>
        <button
          onclick="askQuestion('D·ª± ƒëo√°n chi ti√™u th√°ng t·ªõi')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          üîÆ D·ª± ƒëo√°n
        </button>
          <!-- New Chat Button -->
        <button onclick="newChatSession()"
          class="whitespace-nowrap bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-green-100 transition-colors">
          + Phi√™n m·ªõi
        </button>
      </div>

      <!-- Input form with proper spacing -->
      <form id="chatForm" class="flex items-center gap-2 p-3 bg-white">
        <input
          type="text"
          id="messageInput"
          class="flex-1 border border-gray-300 rounded-full px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          autocomplete="off"
        />
        <button
          type="submit"
          class="bg-blue-600 text-white p-2.5 rounded-full hover:bg-blue-700 transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
            />
          </svg>
        </button>
      </form>
    </div>

        <!-- Chat Session List (Dropdown) -->
    <div class="absolute bottom-full right-0 mb-2 w-48 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 overflow-hidden"
        id="sessionList">
        <div class="py-1">
            <button onclick="newChatSession()"
              class="flex w-full items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
              Phi√™n m·ªõi
            </button>
            <div class="border-t border-gray-200 my-1"></div>
            {% for s in all_sessions %}
            <a href="#" onclick="switchSession({{ s.id }})"
            class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                Phi√™n {{ s.id }}  <!-- Basic ID for now; could use a title -->
                <button onclick="deleteSession(event, {{ s.id }})" class="ml-auto text-red-600 hover:text-red-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </a>
            {% endfor %}
        </div>
    </div>
  </div>
</div>

<style>
  /* Improve scrollbar appearance */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px; /* Width of the scrollbar */
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1; /* Track color */
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #888; /* Thumb color */
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #555; /* Thumb color on hover */
  }

  /* Remove rounded corners on opposing sides of message bubbles */
  .user-message {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }

  .ai-message {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
    /* Style for the typing indicator */
    #typingIndicator .animate-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes bounce {
      0%,
      100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
      }
      50% {
          transform: translateY(0);
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
      }
  }

    .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

    /* Ensure bottom spacing on mobile */
    @media (max-width: 768px) {
        .fixed.bottom-[70px] {
            bottom: 70px;  /* Space for bottom nav */
            z-index: 50;
        }
        #chatMessages{
            padding-bottom: 160px;
        }
          /* Ensure input is visible on all devices */
        #chatForm {
            padding-bottom: calc(env(safe-area-inset-bottom) + 1rem);
        }
    }

  /* Mobile-specific styles */
    @supports (padding: max(0px)) {
        .pb-safe {
            padding-bottom: max(.5rem, env(safe-area-inset-bottom));
        }
    }

  /* Mobile-specific adjustments */
  @supports (padding: env(safe-area-inset-bottom)) {
    .mb-safe {
      margin-bottom: env(safe-area-inset-bottom);
    }
    @media (max-width: 768px) {
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom);
            bottom: 0;
            margin-bottom: 0;
            background-color: white;
            border-top: 1px solid #e5e7eb;
        }
      #chatMessages {
        margin-bottom: calc(env(safe-area-inset-bottom) + 80px);
      }

    }
  }

    /* Ensure bottom nav doesn't overlap chat input */
    @media (max-width: 768px) {
        .fixed.bottom-0 {
            bottom: calc(env(safe-area-inset-bottom));
        }

        #chatMessages {
            padding-bottom: 120px;
        }
    }

   /* Desktop adjustments */
    @media (min-width: 769px) {
        .fixed.inset-0 {
            position: static;
            height: 85vh;
            margin: 0 auto;
            max-width: 48rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .fixed.bottom-[70px] {
            position: static;
        }
    }

      /* Mobile layout adjustments */
    @media (max-width: 768px) {
        #chatMessages {
            height: calc(100vh - 180px); /* Adjust height to account for header and input */
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
            margin-bottom: 0;
        }

        .fixed.bottom-[56px] {
            bottom: 56px; /* Height of bottom nav */
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
    }

    /* Desktop chat container */
    @media (min-width: 769px) {
        #chatMessages {
            height: calc(85vh - 180px);
            max-height: calc(85vh - 180px);
        }
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<!-- Include markdown-it library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const pageLoader = document.getElementById("pageLoader");
      if (pageLoader) {
        pageLoader.remove();
      }
    });
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const aiPersonality = document.getElementById("aiPersonality");
    const typingIndicator = document.getElementById("typingIndicator");

    let currentSessionId = {{ session.id }}; // Initial session ID

    const socket = io("/chat"); // Connect to the /chat namespace

    // Join room on connect
    socket.on("connect", () => {
      console.log("Connected to websocket");
      joinRoom(currentSessionId);
    });

   // Initialize markdown-it
    const md = window.markdownit({
        breaks: true, // Convert '\n' in paragraphs into <br>
        linkify: true,
        typographer: true,
    });

    // Function to switch to a different chat session
    function switchSession(sessionId) {
        // Leave the current room
        leaveRoom(currentSessionId);

        // Update the current session ID
        currentSessionId = sessionId;

        // Join the new room
        joinRoom(sessionId);

        // Clear current messages
        chatMessages.innerHTML = '';

        // Fetch and display messages for the new session
        fetch(`/api/chat/sessions/${sessionId}/messages`)
        .then(response => response.json())
        .then(data => {
            data.messages.forEach(msg => {
                // Apply Markdown rendering HERE, when loading history:
                addMessage(msg.content, msg.user);
            });
            scrollToBottom();
        });
        // Update the selected personality based on new session
        fetch(`/api/chat/sessions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "update", session_id: currentSessionId }),
        })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
              console.log(data)
          }
        });
    }
    function joinRoom(sessionId) {
      socket.emit('join', { room: String(sessionId) });
      console.log(`Joined room: ${sessionId}`);
    }

    function leaveRoom(sessionId) {
        socket.emit('leave', { room: String(sessionId) });
        console.log(`Left room: ${sessionId}`);
    }

    // Handle incoming messages (your messages and AI responses).
    socket.on("message", function (msg) {
      addMessage(msg.data, msg.user); // addMessage now handles Markdown
      scrollToBottom();
    });

    // S·ª≠a l·∫°i h√†m x·ª≠ l√Ω response
    socket.on("response", function (msg) {
      try {
        if (!msg || !msg.data) {
          console.error("Invalid response message:", msg);
          return;
        }

        // Decode HTML entities n·∫øu c·∫ßn
        const decodedMessage = msg.data
          .replace(/</g, "<")
          .replace(/>/g, ">");

        // Th√™m message v√†o UI
        appendResponseMessage(decodedMessage); // No change needed here, append handles it
        scrollToBottom();

        // N·∫øu ƒë√¢y l√† chunk cu·ªëi c√πng, ·∫©n typing indicator
        if (msg.done) {
          hideTyping();
        }
      } catch (error) {
        console.error("Error handling response:", error);
        hideTyping();
        addErrorMessage("C√≥ l·ªói x·∫£y ra khi hi·ªÉn th·ªã tin nh·∫Øn");
      }
    });

    // S·ª≠a l·∫°i h√†m appendResponseMessage
    function appendResponseMessage(messageChunk) {
        let lastMessage = chatMessages.lastElementChild;

        // If typing indicator, get the previous message
        if (lastMessage && lastMessage.id === "typingIndicator") {
            lastMessage = lastMessage.previousElementSibling;
        }

        // If the last message is from AI, append to it
        if (lastMessage && !lastMessage.querySelector(".bg-blue-600")) {
            let lastBubble = lastMessage.querySelector(".message-bubble"); // Use the class
            if (lastBubble) {
                lastBubble.innerHTML += md.render(messageChunk); // Render and append
                return;
            }
        }
      // If no existing AI message, create a new one
        addMessage(messageChunk, false);

    }

    // Handle errors from the server
    socket.on("error", function (msg) {
      addErrorMessage(msg.data); // Display error to the user
      hideTyping(); // Hide typing indicator in case of error.
      scrollToBottom();
    });


  function addMessage(message, isUser) {
    const messageContainer = document.createElement("div");
    messageContainer.classList.add(
        "flex",
        isUser ? "justify-end" : "justify-start",
        "animate__animated",
        "animate__fadeIn"
    );

    const messageBubble = document.createElement("div");
    messageBubble.classList.add(
        "message-bubble", // Keep this for common styles
        isUser ? "bg-blue-600" : "bg-gray-100",  // Use bg-gray-100 for AI
        isUser ? "text-white" : "text-gray-800", // Text color based on sender
        "rounded-2xl",
        "px-4",
        "py-2",
        "max-w-[85%]",
        "md:max-w-[70%]",
        "shadow-sm",
        isUser? "rounded-bl-none" : "rounded-br-none" // Remove the opposite rounded corner
    );

    // Render Markdown to HTML, and set it as innerHTML:
    messageBubble.innerHTML = md.render(message);
    messageContainer.appendChild(messageBubble);
    chatMessages.appendChild(messageContainer);
}


    // Function to add error messages to the chat
    function addErrorMessage(message) {
      const messageContainer = document.createElement("div");
      messageContainer.classList.add("flex", "justify-start"); // Error messages on the left

      const messageBubble = document.createElement("div");
      messageBubble.classList.add(
        "bg-red-100",
        "text-red-800",
        "rounded-2xl",
        "px-4",
        "py-2",
        "max-w-[85%]",
        "md:max-w-[70%]",
        "shadow-sm"
      );
      messageBubble.innerText = message;
      messageContainer.appendChild(messageBubble);
      chatMessages.appendChild(messageContainer);
    }

    // Handle form submission.
    document.getElementById("chatForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const message = messageInput.value;
      if (message.trim() !== "") {
        // Don't add message to the UI here, the 'message' event will handle it.
        socket.emit("message", {
          message: message,
          personality: aiPersonality.value,
        });
        messageInput.value = "";
        showTyping();
      }
    });

    function showTyping() {
      // Remove any existing indicator first
      const existingIndicator = document.getElementById("typingIndicator");
      if (existingIndicator) {
        existingIndicator.remove();
      }

      const indicator = document.createElement("div");
      indicator.id = "typingIndicator";
      indicator.classList.add("flex", "justify-start", "mb-4");
      indicator.innerHTML = `
              <div class="bg-white rounded-2xl px-4 py-2 shadow-sm">
                  <div class="flex items-center gap-2">
                      <div class="flex gap-1">
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                      </div>
                      <span class="text-sm text-gray-600">MoneyKeeper AI ƒëang tr·∫£ l·ªùi...</span>
                  </div>
              </div>
          `;

      // Find the last user message, or if none, add to the end
      const lastUserMessage = document.querySelector(
        "#chatMessages .flex.justify-end:last-child"
      );

      if (lastUserMessage) {
        // Insert *before* the last user message
        chatMessages.insertBefore(indicator, lastUserMessage.nextSibling);
      } else {
        // If no user messages, add to the end.
        chatMessages.appendChild(indicator);
      }

      scrollToBottom();
    }

    function hideTyping() {
      const existingIndicator = document.getElementById("typingIndicator");
      if (existingIndicator) {
        existingIndicator.remove();
      }
    }

    // Send message on button click (optional, if you have a send button).
    function askQuestion(question) {
      // Don't add message to the UI here, the 'message' event will handle it.
      socket.emit("message", {
        message: question,
        personality: aiPersonality.value,
      });
      showTyping();
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initial scroll on load
    scrollToBottom();

    // --- New Session, Delete Session, and Update Personality ---

    function newChatSession() {
        fetch('/api/chat/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ action: 'new' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.session_id) {
                switchSession(data.session_id);
                // Optionally, refresh the session list
                // fetch('/api/chat/sessions') ...
            }
        });
    }

    function deleteSession(event, sessionId) {
      event.preventDefault();
      event.stopPropagation();
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi√™n tr√≤ chuy·ªán n√†y?')) {
          fetch('/api/chat/sessions', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ action: 'delete', session_id: sessionId })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Remove the session from the list
                  const sessionElement = event.target.closest('a');
                  if (sessionElement) {
                      sessionElement.remove();
                  }

                  // If the deleted session is the current session, switch to a new one
                  if (currentSessionId === sessionId) {
                      newChatSession(); // Or redirect to a default/recent session
                  }
              }
          });
      }
    }

    function updateSessionPersonality() {
      fetch('/api/chat/sessions', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: "update",
            session_id: currentSessionId,
            personality: aiPersonality.value })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showToast("ƒê√£ thay ƒë·ªïi t√≠nh c√°ch AI.", 'success')
          }
      });
    }
</script>
{% else %}
<div class="text-center py-12">
  <p class="text-lg mb-6 text-gray-700 font-medium">
    Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng chat.
  </p>
  <a
    href="{{ url_for('auth.login') }}"
    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-md transition-all duration-200 inline-block"
  >
    ƒêƒÉng nh·∫≠p
  </a>
</div>
{% endif %}
{% endblock %}