{% extends "base.html" %}
{% block content %}
<div class="animate__animated animate__fadeIn max-w-lg mx-auto">
    <!-- Header Card -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-xl p-6">
        <h1 class="text-2xl font-bold flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Ch·ªânh s·ª≠a giao d·ªãch
        </h1>
    </div>

    <!-- Main Form -->
    <div class="bg-white rounded-b-xl shadow-lg p-6">
        <form method="POST" class="space-y-6">
            {{ form.hidden_tag() }}

            <!-- Transaction Type Toggle -->
            <div class="relative mb-6">
                <div class="flex rounded-lg bg-gray-100 p-1">
                    <button type="button" onclick="toggleTransactionType('expense')"
                        class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 expense-toggle {{ 'active' if form.is_expense.data }}">
                        Chi ti√™u
                    </button>
                    <button type="button" onclick="toggleTransactionType('income')"
                        class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 income-toggle {{ 'active' if not form.is_expense.data }}">
                        Thu nh·∫≠p
                    </button>
                </div>
                {{ form.is_expense(class="hidden") }}
            </div>

            <!-- Amount Input -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">S·ªë ti·ªÅn</label>
                <div class="relative rounded-lg shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500">‚Ç´</span>
                    </div>
                    {{ form.amount(class="pl-8 pr-12 block w-full text-xl rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 py-4",
                        placeholder="0", inputmode="decimal", pattern="[0-9]*.*[0-9]*", step="any") }}
                </div>
            </div>

            <!-- Quick Amount Buttons -->
            <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
                <button type="button" onclick="setAmount(20000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    20,000‚Ç´
                </button>
                <button type="button" onclick="setAmount(50000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    50,000‚Ç´
                </button>
                <button type="button" onclick="setAmount(100000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    100,000‚Ç´
                </button>
                <button type="button" onclick="setAmount(200000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    200,000‚Ç´
                </button>
            </div>

            <!-- Category Grid -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Danh m·ª•c</label>
                <div class="grid grid-cols-3 gap-3 sm:grid-cols-4">
                    {% for value, label in form.category.choices %}
                    <button type="button" onclick="setCategory('{{ value }}')"
                        class="category-btn flex flex-col items-center p-4 rounded-lg border hover:bg-blue-50 transition-all {{ 'bg-blue-50 border-blue-500' if form.category.data == value }}">
                        <span class="text-2xl mb-2">{{ category_icons[value] }}</span>
                        <span class="text-xs">{{ label }}</span>
                    </button>
                    {% endfor %}
                </div>
                {{ form.category(class="hidden") }}
            </div>

            <!-- Description -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Ghi ch√∫</label>
                {{ form.description(class="block w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 py-3",
                    rows="3", placeholder="Th√™m ghi ch√∫...", autocapitalize="sentences") }}
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
                <a href="{{ url_for('main.expenses') }}"
                    class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50">
                    H·ªßy
                </a>
                {{ form.submit(class="flex-1 py-3 px-4 border border-transparent rounded-lg text-white bg-blue-600 hover:bg-blue-700") }}
            </div>
        </form>
    </div>
</div>

<script>
  function setAmount(amount) {
    document.getElementById("amount").value = amount;
    document.querySelectorAll(".amount-btn").forEach((btn) => {
      btn.classList.remove("bg-blue-100", "text-blue-800");
    });
    event.target.classList.add("bg-blue-100", "text-blue-800");
  }

  function updateCategoryIcon(category) {
    const icons = {
      food: "üçú",
      transport: "üöó",
      shopping: "üõçÔ∏è",
      entertainment: "üéÆ",
      bills: "üìÑ",
      health: "üíä",
      other: "üìù",
    };
    document.getElementById("categoryIcon").textContent =
      icons[category] || "üìù";
  }

  // Add input validation
  document.getElementById("amount").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value;
  });

  // Initialize category icon
  document.getElementById("category").addEventListener("change", function (e) {
    updateCategoryIcon(e.target.value);
  });

  // Initialize on load
  document.addEventListener("DOMContentLoaded", function () {
    updateCategoryIcon(document.getElementById("category").value);
  });

  // Format number with commas while typing
  document.getElementById('amount').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
        e.target.value = formatNumber(parseInt(value));
    }
  });

  function toggleTransactionType(type) {
    const isExpense = type === 'expense';
    document.getElementById('is_expense').value = isExpense;
    
    // Toggle active state for buttons
    const expenseBtn = document.querySelector('.expense-toggle');
    const incomeBtn = document.querySelector('.income-toggle');
    
    if (isExpense) {
        expenseBtn.classList.add('bg-blue-100', 'text-blue-800');
        incomeBtn.classList.remove('bg-blue-100', 'text-blue-800');
    } else {
        incomeBtn.classList.add('bg-blue-100', 'text-blue-800');
        expenseBtn.classList.remove('bg-blue-100', 'text-blue-800');
    }
  }

  // Initialize toggle state on page load
  document.addEventListener('DOMContentLoaded', function() {
    const isExpense = document.getElementById('is_expense').value === 'True';
    toggleTransactionType(isExpense ? 'expense' : 'income');
  });

  // Format money with dots
  function formatMoney(input) {
      // Remove existing dots and non-digit characters
      let value = input.replace(/\D/g, '');
      // Format with dots
      return value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Parse money string to number
  function parseMoney(str) {
      return parseInt(str.replace(/\./g, '')) || 0;
  }

  // Add format to amount input
  document.getElementById('amount').addEventListener('input', function(e) {
      let value = formatMoney(e.target.value);
      e.target.value = value;
  });

  // Format initial value
  document.addEventListener('DOMContentLoaded', function() {
      const amountInput = document.getElementById('amount');
      amountInput.value = formatMoney(amountInput.value);
  });

  // Parse before form submit
  document.querySelector('form').addEventListener('submit', function(e) {
      const amountInput = document.getElementById('amount');
      amountInput.value = parseMoney(amountInput.value);
  });
</script>
{% endblock %}
