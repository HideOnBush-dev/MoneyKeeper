This file is a merged representation of the entire codebase, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.gitignore
.repomixignore
app/__init__.py
app/ai_engine/core/model_manager.py
app/ai_engine/features/analysis.py
app/ai_engine/features/categorizer.py
app/ai_engine/features/chat.py
app/ai_engine/features/expense_handler.py
app/ai_engine/features/predictor.py
app/auth/__init__.py
app/auth/forms.py
app/auth/routes.py
app/commands.py
app/constants.py
app/database.py
app/main/__init__.py
app/main/forms.py
app/main/routes.py
app/models.py
app/settings/__init__.py
app/settings/forms.py
app/settings/routes.py
app/static/css/styles.css
app/static/js/app.js
app/static/manifest.json
app/static/profiles/webclip.mobileconfig
app/templates/auth/_register_content.html
app/templates/auth/login.html
app/templates/auth/register.html
app/templates/base.html
app/templates/email/budget_alert.html
app/templates/email/unusual_spending.html
app/templates/includes/flash.html
app/templates/includes/loading.html
app/templates/includes/pagination.html
app/templates/landing.html
app/templates/layouts/landing.html
app/templates/main/add_expense.html
app/templates/main/budgets.html
app/templates/main/chat.html
app/templates/main/edit_expense.html
app/templates/main/edit_wallet.html
app/templates/main/expenses.html
app/templates/main/index.html
app/templates/main/landing.html
app/templates/main/notifications.html
app/templates/main/settings.html
app/templates/main/wallets.html
app/utils.py
app/utils/__init__.py
app/utils/currency.py
app/utils/email.py
app/utils/export.py
app/utils/notifications.py
app/utils/ocr.py
babel.cfg
config.py
manage.py
messages.pot
README.md
repomix.config.json
requirements.txt
run.py

================================================================
Files
================================================================

================
File: .gitignore
================
# Byte-compiled / optimized / DLL files
__pycache__/
*.py[cod]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.log
.hypothesis/
.pytest_cache/

# Environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
.python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# PEP 582; used by e.g. github.com/David-OConnor/pyflow
__pypackages__/

# Celery
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# VS Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
!.vscode/*.code-snippets

# PyCharm
#  Continuous Integration (CI)
#  Covered by Pycharm Pro
.idea/
#  Local History
.idea/workspace.xml
.idea/tasks.xml
.idea/dictionaries
#  Git
.idea/vcs.xml
#  Emacs
.idea/shelf
#  External Tools
.idea/externalDependencies.xml
#  Virtual Environment
.idea/workspace.xml
.idea/dataSources.local.xml
.idea/dataSources/
.idea/dataSources.xml
.idea/sqlDataSources.xml
.idea/dynamic.xml
.idea/uiDesigner.xml
.idea/gradle.xml
.idea/libraries
# File-based project format
*.iws

# IntelliJ
*.iml
*.ipr

#  hgignore coverage testing
.coverage

# Ignore compiled models and logs
models/
logs/
#Ignore Database
*.db
*.db-shm
*.db-wal

#Ignore migrations
migrations/

================
File: .repomixignore
================
# Add patterns to ignore here, one per line
# Example:
# *.log
# tmp/

__pycache__/
.pytest_cache/
*.pyo
*.pyd
.Python
env/
venv/
.env/
.venv/
pip-log.txt
pip-delete-this-directory.txt
.tox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.log
.mypy_cache/
.dmypy.json
dmypy.json

models/

================
File: app/__init__.py
================
# app/__init__.py

from flask import Flask
from config import Config
from app.database import db, login_manager, mail, moment, init_db
from flask_migrate import Migrate
import os
from flask_socketio import SocketIO
import logging
from app.utils import format_currency  # Import format currency

# Configure logging
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

socketio = SocketIO()


def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)

    init_db(app)
    login_manager.init_app(app)
    mail.init_app(app)
    moment.init_app(app)
    migrate = Migrate(app, db)  # Initialize Flask-Migrate
    socketio.init_app(app, async_mode="threading")

    login_manager.login_view = "auth.login"
    login_manager.login_message = (
        "Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ truy cáº­p trang nÃ y."  # Added login message
    )
    login_manager.login_message_category = "info"

    from app.commands import init_db_command, create_tables_command

    app.cli.add_command(init_db_command)
    app.cli.add_command(create_tables_command)  # Add create_tables command

    @app.context_processor
    def utility_processor():
        return dict(format_currency=format_currency)

    with app.app_context():
        from app.auth import bp as auth_bp
        from app.main import bp as main_bp
        from app.settings import bp as settings_bp

        app.register_blueprint(auth_bp)
        app.register_blueprint(main_bp)
        app.register_blueprint(settings_bp)

        if os.environ.get("WERKZEUG_RUN_MAIN") == "true":
            logger.info("Preloading AI models...")  # Log model loading
            from app.ai_engine.core.model_manager import model_manager

            model_manager.preload_models()
            from app.ai_engine.features.chat import AIChat
            from app.ai_engine.features.analysis import ExpenseAnalyzer
            from app.ai_engine.features.predictor import ExpensePredictor
            from app.ai_engine.features.categorizer import ExpenseCategorizer

            app.expense_analyzer = ExpenseAnalyzer()
            app.expense_categorizer = ExpenseCategorizer()
            app.expense_predictor = ExpensePredictor()
            app.ai_chat = AIChat()
            logger.info("AI models preloaded.")

    return app

================
File: app/ai_engine/core/model_manager.py
================
import threading
import queue
import gc
import os
from typing import Dict, Any, Optional, TypeAlias

from transformers import (
    AutoModelForCausalLM,
    AutoTokenizer,
    BitsAndBytesConfig,
    pipeline,
)
import torch
import logging

logger = logging.getLogger(__name__)

ModelType: TypeAlias = AutoModelForCausalLM
TokenizerType: TypeAlias = AutoTokenizer
ModelInfo: TypeAlias = Dict[str, Any]


class ModelManager:
    _instance = None
    _lock = threading.Lock()
    _initialized = False

    def __new__(cls):
        with cls._lock:
            if cls._instance is None:
                cls._instance = super(ModelManager, cls).__new__(cls)
            return cls._instance

    def initialize(self):
        if self._initialized:
            return

        self.model_path = os.path.join(
            os.path.dirname(os.path.dirname(os.path.dirname(__file__))), "models"
        )
        os.makedirs(self.model_path, exist_ok=True)
        logger.info(f"Model path initialized at: {self.model_path}")

        self.model_cache: Dict[str, ModelType] = {}
        self.tokenizer_cache: Dict[str, TokenizerType] = {}
        self.load_queue: queue.Queue[ModelInfo] = queue.Queue()
        self.loading_status: Dict[str, str] = {}
        self.loading_event = threading.Event()
        self.default_config = {
            "load_in_4bit": True,
            "bnb_4bit_compute_dtype": torch.bfloat16,
            "bnb_4bit_quant_type": "nf4",
            "bnb_4bit_use_double_quant": True,
            "llm_int8_enable_fp32_cpu_offload": True,
        }

        self.loader_thread = threading.Thread(
            target=self._background_loader, daemon=True
        )
        self.loader_thread.start()

        self.device = "cuda" if torch.cuda.is_available() else "cpu"
        if self.device == "cuda":
            logger.info(f"CUDA is available. Device count: {torch.cuda.device_count()}")
            logger.info(f"Current device: {torch.cuda.current_device()}")
            logger.info(f"Device name: {torch.cuda.get_device_name(0)}")
        else:
            logger.warning("CUDA is NOT available. Falling back to CPU.")

        self.pipeline = None
        self._initialized = True

    def preload_models(self):
        self.initialize()
        models_to_load = [
            {
                "name": "meta-llama/Llama-3.2-3B-Instruct",
                "config": self.default_config.copy(),
            }
        ]
        for model_info in models_to_load:
            self.load_queue.put(model_info)
        self.load_queue.join()

    def _background_loader(self):
        while True:
            try:
                model_info = self.load_queue.get()
                self._load_model(model_info)
                self.load_queue.task_done()
            except Exception as e:
                logger.exception(f"Error loading model: {e}")  # Log the full traceback

    def _load_model(self, model_info: ModelInfo):
        name = model_info["name"]
        config = model_info["config"]
        self.loading_status[name] = "loading"
        logger.info(f"Loading model and tokenizer: {name}")

        try:
            self._load_tokenizer_with_retry(name)
            self._load_model_with_retry(name, config)

            self.loading_status[name] = "loaded"
            self.loading_event.set()

            if self.pipeline is None:  # Initialize pipeline *after* model is loaded
                self.pipeline = pipeline(
                    "text-generation",
                    model=self.model_cache[name],
                    tokenizer=self.tokenizer_cache[name],
                    torch_dtype=torch.bfloat16,
                    device_map="auto",
                )

        except Exception as e:
            error_msg = f"Error loading model/tokenizer for {name}: {str(e)}"
            logger.exception(error_msg)  # Log full traceback
            self.loading_status[name] = "failed"
            self.loading_event.set()
            torch.cuda.empty_cache()

    def _load_tokenizer_with_retry(self, name: str):
        max_retries = 3
        for attempt in range(max_retries):
            try:
                logger.info(
                    f"Loading tokenizer (attempt {attempt + 1}/{max_retries})..."
                )
                tokenizer = AutoTokenizer.from_pretrained(
                    name,
                    trust_remote_code=True,
                    padding_side="left",
                    cache_dir=self.model_path,
                )
                if tokenizer:
                    self.tokenizer_cache[name] = tokenizer
                    logger.info("Tokenizer loaded successfully")
                    return
            except Exception as e:
                logger.warning(f"Tokenizer loading attempt {attempt + 1} failed: {e}")
                if attempt == max_retries - 1:
                    raise

    def _load_model_with_retry(self, name: str, config: Dict[str, Any]):
        max_retries = 3
        for attempt in range(max_retries):
            try:
                logger.info(f"Loading model (attempt {attempt + 1}/{max_retries})...")
                config_for_bnb = config.copy()

                config_for_bnb.pop("torch_dtype", None)
                config_for_bnb.pop("device_map", None)

                model = AutoModelForCausalLM.from_pretrained(
                    name,
                    quantization_config=BitsAndBytesConfig(**config_for_bnb),
                    trust_remote_code=True,
                    cache_dir=self.model_path,
                    low_cpu_mem_usage=True,
                )

                if model:
                    self.model_cache[name] = model
                    logger.info("Model loaded successfully")
                    return

            except Exception as e:
                logger.warning(f"Model loading attempt {attempt + 1} failed: {e}")
                if attempt == max_retries - 1:
                    raise

    def get_pipeline(self):
        self.initialize()
        if self.pipeline is None:
            self.loading_event.wait()
        return self.pipeline

    def get_model(self, name: str) -> Optional[ModelType]:
        self.initialize()
        if name not in self.model_cache:
            if name not in self.loading_status:
                model_info = {"name": name, "config": self.default_config.copy()}
                self.load_queue.put(model_info)
                self.loading_event.clear()
            self.loading_event.wait()
            if self.loading_status.get(name) == "failed":
                raise ValueError(f"Failed to load model {name}")
        return self.model_cache.get(name)

    def get_tokenizer(self, name: str) -> Optional[TokenizerType]:
        self.initialize()
        if name not in self.tokenizer_cache:
            if name not in self.loading_status:
                model_info = {"name": name, "config": self.default_config.copy()}
                self.load_queue.put(model_info)
                self.loading_event.clear()
            self.loading_event.wait()
            if self.loading_status.get(name) == "failed":
                raise ValueError(f"Failed to load tokenizer or associated model {name}")
        return self.tokenizer_cache.get(name)

    def clear_cache(self):
        self.initialize()
        self.model_cache.clear()
        self.tokenizer_cache.clear()
        if self.pipeline is not None:
            del self.pipeline
            self.pipeline = None
        torch.cuda.empty_cache()
        gc.collect()

    def is_model_loaded(self, name: str) -> bool:
        """Check if a model is loaded"""
        return name in self.model_cache


model_manager = ModelManager()

================
File: app/ai_engine/features/analysis.py
================
from datetime import datetime
import re
from typing import List, Dict
import json
import logging

from app.ai_engine.features.predictor import format_money
from app.ai_engine.core.model_manager import model_manager


logger = logging.getLogger(__name__)


class ExpenseAnalyzer:
    def __init__(self, model_name: str = "meta-llama/Llama-3.2-3B-Instruct"):
        self.model_name = model_name
        self.tokenizer = model_manager.get_tokenizer(self.model_name)
        self.model = model_manager.get_model(self.model_name)
        self.pipeline = model_manager.get_pipeline()

    def get_analysis_data(self, expense_data: List[Dict]) -> Dict:
        """
        Analyzes expense data and returns core statistics: daily average,
        total spending, most common categories, and the highest expense.
        """
        if not expense_data:
            return {
                "daily_average": 0,
                "total": 0,
                "common_categories": [],
                "highest_expense": {"amount": 0, "category": ""},
            }

        for expense in expense_data:
            if isinstance(expense["date"], str):
                expense["date"] = datetime.fromisoformat(expense["date"])

        total_spent = sum(expense["amount"] for expense in expense_data)
        num_days = (
            (expense_data[-1]["date"] - expense_data[0]["date"]).days + 1
            if expense_data
            else 1
        )
        daily_average = total_spent / num_days

        category_counts = {}
        for expense in expense_data:
            category = expense["category"]
            category_counts[category] = (
                category_counts.get(category, 0) + expense["amount"]
            )

        sorted_categories = sorted(
            category_counts.items(), key=lambda item: item[1], reverse=True
        )

        highest_expense = max(
            expense_data,
            key=lambda x: x["amount"],
            default={"amount": 0, "category": ""},
        )

        return {
            "daily_average": daily_average,
            "total": total_spent,
            "common_categories": sorted_categories[:3],  # Top 3 categories
            "highest_expense": highest_expense,
        }

    def get_recommendations(self, expense_data: List[Dict]) -> List[str]:
        """
        Generates recommendations based on expense data using the LLM.
        Now expects and parses JSON output.
        """
        analysis_data = self.get_analysis_data(
            expense_data
        )  # calculate or get analysis data

        if not expense_data:
            return ["Báº¯t Ä‘áº§u theo dÃµi chi tiÃªu cá»§a báº¡n Ä‘á»ƒ nháº­n phÃ¢n tÃ­ch."]

        prompt = self._format_recommendation_prompt(
            analysis_data["total"],
            analysis_data["common_categories"],
            analysis_data["highest_expense"],
        )

        try:
            outputs = self.pipeline(
                prompt,
                max_new_tokens=512,
                do_sample=True,
                temperature=0.7,
                top_p=0.9,
                pad_token_id=self.tokenizer.eos_token_id,
            )
            generated_text = outputs[0]["generated_text"]

            # Remove the prompt from the generated text
            response_text = generated_text.replace(prompt, "").strip()
            print(response_text)

            return self._extract_recommendations(response_text)

        except Exception as e:
            logger.exception(f"Error generating recommendations with LLM: {e}")
            return []

    def _format_recommendation_prompt(
        self, total_spent: float, sorted_categories: list, highest_expense: dict
    ) -> str:
        """Formats the prompt, instructing the LLM to return JSON."""

        prompt = f"""Dá»¯ liá»‡u chi tiÃªu:
- Tá»•ng: {format_money(total_spent)}
- Danh má»¥c nhiá»u nháº¥t: {", ".join(f"{cat}: {format_money(amt)}" for cat, amt in sorted_categories)}
- Chi tiÃªu lá»›n nháº¥t: {format_money(highest_expense['amount'])} ({highest_expense['category']})

ÄÆ°a ra 3 khuyáº¿n nghá»‹ (dÆ°á»›i dáº¡ng JSON):

```json
{{
  "recommendations": [
    "Khuyáº¿n nghá»‹ 1",
    "Khuyáº¿n nghá»‹ 2",
    "Khuyáº¿n nghá»‹ 3"
  ]
}}
```

KHÃ”NG GIáº¢I THÃCH. CHá»ˆ JSON VÃ€ KHÃ”NG Äá»€ Cáº¬P Váº¤N Äá»€ KHÃC."""
        return prompt

    def _extract_recommendations(self, analysis_text: str) -> List[str]:
        """
        Parses the LLM's response, expecting JSON, and extracts recommendations.
        Handles potential JSON decoding errors.
        """
        try:
            # More robust JSON extraction, handles extra text before/after
            match = re.search(
                r"```json\s*({[\s\S]*?})\s*```", analysis_text, re.IGNORECASE
            )  # Added IGNORECASE flag
            if match:
                json_str = match.group(1)
                json_str = json_str.strip()  # important to remove extra spaces.
                data = json.loads(json_str)

                if "recommendations" in data and isinstance(
                    data["recommendations"], list
                ):
                    return data["recommendations"][:3]  # Limit to 3 recommendations
                else:
                    logger.error(
                        f"Invalid JSON format: 'recommendations' key missing or not a list. Response: {analysis_text}"
                    )
                    return []  # Return empty list if invalid
            else:
                logger.error(f"No JSON found in AI response: {analysis_text}")
                return []

        except json.JSONDecodeError as e:
            logger.exception(
                f"JSON decoding error: {e}.  Response text: {analysis_text}"
            )  # Log the exception AND the problematic text
            return []
        except Exception as e:  # General exception handling
            logger.exception(f"An unexpected error occurred: {e}")
            return []

================
File: app/ai_engine/features/categorizer.py
================
from typing import Dict, List
from app.ai_engine.core.model_manager import model_manager
import logging

logger = logging.getLogger(__name__)


class ExpenseCategorizer:
    def __init__(self, model_name: str = "meta-llama/Llama-3.2-3B-Instruct"):
        self.model_name = model_name
        self.tokenizer = model_manager.get_tokenizer(self.model_name)
        self.model = model_manager.get_model(self.model_name)
        self.pipeline = model_manager.get_pipeline()

        self.category_keywords = {
            "di chuyá»ƒn": [
                "xe",
                "bus",
                "buÃ½t",
                "taxi",
                "grab",
                "be",
                "gojek",
                "xÄƒng",
                "gá»­i xe",
                "Ä‘á»• xÄƒng",
                "nhiÃªn liá»‡u",
                "dáº§u",
                "ga",
                "vÃ© tÃ u",
                "vÃ© mÃ¡y bay",
                "vÃ© xe",
                "vÃ© tÃ u há»a",
                "vÃ© tÃ u thá»§y",
                "Ä‘i láº¡i",
                "phÃ­ Ä‘á»— xe",
                "thuÃª xe",
                "bÃ£i xe",
                "uber",
                "Ä‘i xe",
                "báº¿n xe",
                "Ä‘i tÃ u",
                "Ä‘i mÃ¡y bay",
                "taxi mai linh",
                "vinasun",
                "giao thÃ´ng",
                "Ä‘i grabcar",
                "Ä‘i grabbike",
                "vÃ© tÃ u Ä‘iá»‡n",
                "metro",
                "Ä‘i chuyá»ƒn",
                "Ä‘Æ°á»ng sáº¯t",
                "vÃ© tÃ u cao tá»‘c",
                "vietjet",
                "bamboo",
                "vietnam airline",
            ],
            "Äƒn uá»‘ng": [
                "Äƒn",
                "Ä‘á»“ Äƒn",
                "cÆ¡m",
                "bÃºn",
                "phá»Ÿ",
                "cafe",
                "cÃ  phÃª",
                "cf",
                "trÃ  sá»¯a",
                "Äƒn sÃ¡ng",
                "Äƒn trÆ°a",
                "Äƒn tá»‘i",
                "nhÃ  hÃ ng",
                "quÃ¡n Äƒn",
                "Äƒn váº·t",
                "bá»¯a Äƒn",
                "Ä‘á»“ uá»‘ng",
                "nÆ°á»›c uá»‘ng",
                "bia",
                "rÆ°á»£u",
                "nÆ°á»›c ngá»t",
                "sinh tá»‘",
                "nÆ°á»›c Ã©p",
                "bÃ¡nh mÃ¬",
                "pizza",
                "sushi",
                "Ä‘á»“ nÆ°á»›ng",
                "láº©u",
                "BBQ",
                "buffet",
                "Ä‘á»“ Äƒn nhanh",
                "fast food",
                "kfc",
                "mcdonald",
                "jollibee",
                "highlands",
                "starbucks",
                "cÆ¡m vÄƒn phÃ²ng",
                "cÆ¡m há»™p",
                "mÃ³n Äƒn",
                "Ä‘áº·t Ä‘á»“",
                "delivery",
                "now",
                "shopeefood",
                "grabfood",
                "baemin",
                "gÃ  rÃ¡n",
                "thá»©c Äƒn",
                "Ä‘á»“ nháº­u",
                "quÃ¡n nháº­u",
                "quÃ¡n cÃ  phÃª",
                "Ä‘á»“ Äƒn váº·t",
            ],
            "mua sáº¯m": [
                "mua",
                "quáº§n Ã¡o",
                "giÃ y dÃ©p",
                "Ä‘á»“ dÃ¹ng",
                "siÃªu thá»‹",
                "chá»£",
                "táº¡p hÃ³a",
                "thá»i trang",
                "quáº§n",
                "Ã¡o",
                "vÃ¡y",
                "Ä‘áº§m",
                "giÃ y",
                "dÃ©p",
                "tÃºi xÃ¡ch",
                "vÃ­",
                "Ä‘á»“ng há»“",
                "trang sá»©c",
                "nÆ°á»›c hoa",
                "má»¹ pháº©m",
                "son",
                "pháº¥n",
                "kem",
                "sá»¯a rá»­a máº·t",
                "dÆ°á»¡ng da",
                "máº·t náº¡",
                "trang Ä‘iá»ƒm",
                "Ä‘á»“ Ä‘iá»‡n tá»­",
                "Ä‘á»“ gia dá»¥ng",
                "ná»™i tháº¥t",
                "Ä‘á»“ trang trÃ­",
                "Ä‘á»“ chÆ¡i",
                "Ä‘á»“ cho bÃ©",
                "tÃ£",
                "sá»¯a",
                "vinmart",
                "coopmart",
                "big c",
                "aeon",
                "lotte mart",
                "shopee",
                "lazada",
                "tiki",
                "sendo",
                "online",
                "Ä‘áº·t hÃ ng",
                "uniqlo",
                "zara",
                "h&m",
                "shopping",
                "phá»¥ kiá»‡n",
            ],
            "giáº£i trÃ­": [
                "xem phim",
                "du lá»‹ch",
                "chÆ¡i game",
                "karaoke",
                "sá»± kiá»‡n",
                "vÃ©",
                "concert",
                "nháº¡c sá»‘ng",
                "live show",
                "bar",
                "club",
                "hÃ¡t",
                "tiá»‡c",
                "ráº¡p phim",
                "cgv",
                "lotte cinema",
                "galaxy cinema",
                "netflix",
                "spotify",
                "kÃªnh truyá»‡n",
                "truyá»‡n tranh",
                "sÃ¡ch truyá»‡n",
                "trÃ² chÆ¡i",
                "game online",
                "steam",
                "garena",
                "pubg",
                "liÃªn quÃ¢n",
                "fifa",
                "ps4",
                "ps5",
                "xbox",
                "nintendo",
                "picnic",
                "dÃ£ ngoáº¡i",
                "cÃ´ng viÃªn",
                "khu vui chÆ¡i",
                "khu du lá»‹ch",
                "giáº£i trÃ­",
                "festival",
                "lá»… há»™i",
                "show",
                "biá»ƒu diá»…n",
                "youtube premium",
                "spotify premium",
                "apple music",
                "mÃ´n thá»ƒ thao",
                "sÃ¢n váº­n Ä‘á»™ng",
                "xem bÃ³ng Ä‘Ã¡",
            ],
            "hÃ³a Ä‘Æ¡n": [
                "Ä‘iá»‡n",
                "nÆ°á»›c",
                "internet",
                "Ä‘iá»‡n thoáº¡i",
                "tiá»n nhÃ ",
                "phÃ­ dá»‹ch vá»¥",
                "chung cÆ°",
                "hÃ³a Ä‘Æ¡n",
                "bill",
                "cÃ¡p",
                "truyá»n hÃ¬nh",
                "thuÃª nhÃ ",
                "thuÃª phÃ²ng",
                "tiá»n thuÃª",
                "phÃ­ quáº£n lÃ½",
                "phÃ­ gá»­i xe",
                "phÃ­ chung cÆ°",
                "phÃ­ an ninh",
                "phÃ­ vá»‡ sinh",
                "tiá»n Ä‘iá»‡n",
                "tiá»n nÆ°á»›c",
                "tiá»n máº¡ng",
                "tiá»n wifi",
                "tiá»n cÃ¡p",
                "tiá»n gas",
                "gas",
                "thuáº¿",
                "báº£o hiá»ƒm",
                "phÃ­ ngÃ¢n hÃ ng",
                "phÃ­ tháº»",
                "phÃ­ duy trÃ¬",
                "phÃ­ dá»‹ch vá»¥",
                "tiá»n Ä‘iá»‡n thoáº¡i",
                "cÆ°á»›c Ä‘iá»‡n thoáº¡i",
                "cÆ°á»›c di Ä‘á»™ng",
                "viettel",
                "vinaphone",
                "mobifone",
                "fpt",
                "vnpt",
                "cmc",
                "vinhomes",
                "tiá»n trá»",
                "tiá»n thuÃª nhÃ ",
                "cÆ°á»›c internet",
            ],
            "sá»©c khá»e": [
                "thuá»‘c",
                "khÃ¡m bá»‡nh",
                "bá»‡nh viá»‡n",
                "gym",
                "thá»ƒ thao",
                "phÃ²ng táº­p",
                "yoga",
                "cháº¡y bá»™",
                "boxing",
                "pilates",
                "fitness",
                "Ä‘á»“ thá»ƒ thao",
                "vitamin",
                "thá»±c pháº©m chá»©c nÄƒng",
                "khÃ¡m sá»©c khá»e",
                "nha khoa",
                "nha sÄ©",
                "Ä‘au rÄƒng",
                "rÄƒng miá»‡ng",
                "máº¯t kÃ­nh",
                "kÃ­nh",
                "khÃ¡m máº¯t",
                "khÃ¡m thai",
                "thai sáº£n",
                "y táº¿",
                "báº£o hiá»ƒm y táº¿",
                "phÃ­ khÃ¡m",
                "viá»‡n phÃ­",
                "mua thuá»‘c",
                "nhÃ  thuá»‘c",
                "pharmacity",
                "long chÃ¢u",
                "an khang",
                "dÆ°á»£c pháº©m",
                "váº­t tÆ° y táº¿",
                "thiáº¿t bá»‹ y táº¿",
                "mÃ¡t xa",
                "spa",
                "chÄƒm sÃ³c sá»©c khá»e",
                "thiá»n",
                "chÃ¢m cá»©u",
                "váº­t lÃ½ trá»‹ liá»‡u",
                "kháº©u trang",
                "xÃ©t nghiá»‡m",
                "test covid",
                "xÃ´ng hÆ¡i",
                "thá»±c pháº©m bá»• sung",
            ],
            "giÃ¡o dá»¥c": [
                "há»c phÃ­",
                "sÃ¡ch",
                "khÃ³a há»c",
                "Ä‘Ã o táº¡o",
                "lá»›p há»c",
                "há»c",
                "giÃ¡o trÃ¬nh",
                "tÃ i liá»‡u",
                "bÃºt",
                "vá»Ÿ",
                "Ä‘á»“ dÃ¹ng há»c táº­p",
                "vÄƒn phÃ²ng pháº©m",
                "laptop",
                "mÃ¡y tÃ­nh",
                "thiáº¿t bá»‹ há»c táº­p",
                "thiáº¿t bá»‹ Ä‘iá»‡n tá»­",
                "khÃ³a há»c online",
                "e-learning",
                "udemy",
                "coursera",
                "há»c tiáº¿ng anh",
                "luyá»‡n thi",
                "gia sÆ°",
                "tiá»n há»c",
                "trÆ°á»ng há»c",
                "Ä‘áº¡i há»c",
                "cao Ä‘áº³ng",
                "cáº¥p 3",
                "phá»• thÃ´ng",
                "máº«u giÃ¡o",
                "nhÃ  tráº»",
                "giÃ¡o viÃªn",
                "dáº¡y há»c",
                "dáº¡y kÃ¨m",
                "pháº§n má»m há»c táº­p",
                "tá»« Ä‘iá»ƒn",
                "sÃ¡ch giÃ¡o khoa",
                "sÃ¡ch tham kháº£o",
                "Ä‘á»“ng phá»¥c",
                "tráº¡i hÃ¨",
                "chá»©ng chá»‰",
                "báº±ng cáº¥p",
                "toeic",
                "ielts",
                "toefl",
                "há»c thÃªm",
            ],
            "cÃ´ng viá»‡c": [
                "vÄƒn phÃ²ng pháº©m",
                "in áº¥n",
                "photocopy",
                "cÃ´ng cá»¥",
                "pháº§n má»m",
                "Ä‘á»“ng nghiá»‡p",
                "khÃ¡ch hÃ ng",
                "Ä‘á»‘i tÃ¡c",
                "tiáº¿p khÃ¡ch",
                "cÃ´ng tÃ¡c",
                "Ä‘i cÃ´ng tÃ¡c",
                "dá»± Ã¡n",
                "há»™i tháº£o",
                "workshop",
                "seminar",
                "Ä‘Ã o táº¡o cÃ´ng viá»‡c",
                "phÃ­ thÃ nh viÃªn",
                "há»™i viÃªn",
                "hiá»‡p há»™i",
                "networking",
                "tuyá»ƒn dá»¥ng",
                "quáº£ng cÃ¡o",
                "marketing",
                "váº­t pháº©m vÄƒn phÃ²ng",
                "giáº¥y in",
                "má»±c in",
                "thiáº¿t bá»‹ vÄƒn phÃ²ng",
                "Ä‘áº§u tÆ° cÃ´ng viá»‡c",
                "pháº§n má»m chuyÃªn dá»¥ng",
                "dá»‹ch vá»¥ chuyÃªn mÃ´n",
                "tÆ° váº¥n cÃ´ng viá»‡c",
                "cÃ´ng tÃ¡c phÃ­",
            ],
            "khÃ¡c": [],
        }

    def _classify_with_llm(self, description: str) -> str:
        try:
            messages = [
                {
                    "role": "system",
                    "content": "Báº¡n lÃ  má»™t AI phÃ¢n loáº¡i chi tiÃªu. Báº¡n CHá»ˆ tráº£ vá» tÃªn danh má»¥c, khÃ´ng cÃ³ báº¥t ká»³ vÄƒn báº£n nÃ o khÃ¡c.",
                },
                {
                    "role": "user",
                    "content": f"PhÃ¢n loáº¡i chi tiÃªu sau vÃ o má»™t trong cÃ¡c danh má»¥c sau: {', '.join(self.category_keywords.keys())}. MÃ´ táº£: {description}. Danh má»¥c:",
                },
            ]

            outputs = self.pipeline(
                messages,
                max_new_tokens=20,
                do_sample=False,
                pad_token_id=self.tokenizer.eos_token_id,
            )
            category = outputs[0]["generated_text"].strip().lower()

            valid_categories = self.category_keywords.keys()
            if category in valid_categories:
                return category
            else:
                return "khÃ¡c"

        except Exception as e:
            logger.exception(f"Error classifying with LLM: {e}")  # Log full traceback
            return "khÃ¡c"

    def predict_category(self, description: str) -> str:
        if not description:
            return "khÃ¡c"

        description = description.lower()
        best_category = "khÃ¡c"
        max_matches = 0
        scores = {}

        for category, keywords in self.category_keywords.items():
            matches = sum(1 for keyword in keywords if keyword in description)
            scores[category] = matches

        # Find category with highest score
        best_category = max(scores, key=scores.get)
        max_matches = scores[best_category]

        if max_matches >= 1:  # Use the best category if good match
            return best_category
        else:  # Use LLM
            return self._classify_with_llm(description)

    def update_keywords(self, new_keywords: Dict[str, List[str]]):
        for category, keywords in new_keywords.items():
            if category in self.category_keywords:
                self.category_keywords[category].extend(keywords)
            else:
                self.category_keywords[category] = keywords

================
File: app/ai_engine/features/chat.py
================
import random
import logging
import re
import json
from flask_login import current_user
from typing import List, Generator, Dict, Optional

from app.ai_engine.core.model_manager import model_manager
from app.ai_engine.features.expense_handler import ExpenseHandler
from app.models import ChatMessage
from app.utils import format_currency
import gc
import torch
from transformers import pipeline
from flask import current_app
from app import db

logger = logging.getLogger(__name__)


class AIChat:
    def __init__(self, model_name: str = "meta-llama/Llama-3.2-3B-Instruct"):
        self.model_name = model_name
        if not model_manager.is_model_loaded(self.model_name):
            logger.warning(
                f"Model {self.model_name} is not preloaded.  Loading now. This may take some time."
            )

        self.tokenizer = model_manager.get_tokenizer(self.model_name)
        self.model = model_manager.get_model(self.model_name)
        self.pipeline = model_manager.get_pipeline()

        self.tools = {
            "get_exchange_rate": self._get_exchange_rate,
            "format_currency": self._format_currency,
            "calculate_budget": self._calculate_budget,  # Keep this tool, but it needs expenses data
        }

        self.personalities = {
            "friendly": {
                "name": "MoneyKeeper AI ðŸ¤—",
                "style": "thÃ¢n thiá»‡n, nhiá»‡t tÃ¬nh, vÃ  quan tÃ¢m",
                "greeting": "Xin chÃ o! MÃ¬nh lÃ  MoneyKeeper AI, ngÆ°á»i báº¡n Ä‘á»“ng hÃ nh vá» tÃ i chÃ­nh cá»§a báº¡n! ðŸ¤— Báº¡n muá»‘n mÃ¬nh giÃºp gÃ¬ hÃ´m nay?",
                "tone": "nháº¹ nhÃ ng, tÃ­ch cá»±c",
                "pronouns": ["báº¡n", "mÃ¬nh"],
                "emojis": ["ðŸ¤—", "ðŸ˜Š", "ðŸ‘", "ðŸ’–", "âœ¨"],
                "responses": {
                    "greeting": [
                        "ChÃ o báº¡n, mÃ¬nh cÃ³ thá»ƒ giÃºp gÃ¬ Ä‘Æ°á»£c cho báº¡n? ðŸ¤—",
                        "HÃ´m nay báº¡n muá»‘n quáº£n lÃ½ chi tiÃªu tháº¿ nÃ o? ðŸ˜Š",
                    ],
                    "good_job": [
                        "Tuyá»‡t vá»i! Báº¡n lÃ m tá»‘t láº¯m! ðŸ‘",
                        "Xuáº¥t sáº¯c! Cá»© giá»¯ vá»¯ng phong Ä‘á»™ nÃ y nhÃ©! âœ¨",
                    ],
                    "encouragement": [
                        "Cá»‘ gáº¯ng lÃªn nhÃ©! MÃ¬nh tin báº¡n lÃ m Ä‘Æ°á»£c! ðŸ’ª",
                        "Äá»«ng lo láº¯ng, má»i chuyá»‡n sáº½ á»•n thÃ´i! ðŸ’–",
                    ],
                    "uncertain": [
                        "MÃ¬nh khÃ´ng cháº¯c láº¯m, báº¡n cÃ³ thá»ƒ nÃ³i rÃµ hÆ¡n Ä‘Æ°á»£c khÃ´ng?",
                        "Xin lá»—i, mÃ¬nh chÆ°a hiá»ƒu Ã½ báº¡n láº¯m.",
                    ],
                },
                "topic_guidance": {
                    "ngÃ¢n sÃ¡ch": "MÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n táº¡o ngÃ¢n sÃ¡ch, theo dÃµi chi tiÃªu so vá»›i ngÃ¢n sÃ¡ch, vÃ  Ä‘Æ°a ra lá»i khuyÃªn Ä‘á»ƒ báº¡n khÃ´ng vÆ°á»£t quÃ¡ giá»›i háº¡n.",
                    "tiáº¿t kiá»‡m": "MÃ¬nh cÃ³ ráº¥t nhiá»u máº¹o tiáº¿t kiá»‡m tiá»n hay ho Ä‘áº¥y! Báº¡n muá»‘n tiáº¿t kiá»‡m cho má»¥c tiÃªu cá»¥ thá»ƒ nÃ o khÃ´ng?",
                    "phÃ¢n tÃ­ch chi tiÃªu": "MÃ¬nh sáº½ phÃ¢n tÃ­ch chi tiÃªu cá»§a báº¡n theo thá»i gian, danh má»¥c, vÃ  tÃ¬m ra nhá»¯ng Ä‘iá»ƒm báº¥t thÆ°á»ng.",
                    "chung": "MÃ¬nh cÃ³ thá»ƒ trÃ² chuyá»‡n vá» cÃ¡c váº¥n Ä‘á» tÃ i chÃ­nh cÃ¡ nhÃ¢n, giáº£i Ä‘Ã¡p tháº¯c máº¯c, vÃ  cung cáº¥p thÃ´ng tin há»¯u Ã­ch.",
                },
            },
            "strict": {
                "name": "MoneyKeeper AI ðŸ˜¤",
                "style": "tháº³ng tháº¯n, nghiÃªm tÃºc, vÃ  cÃ³ pháº§n 'cáº±n nháº±n'",
                "greeting": "TÃ´i lÃ  MoneyKeeper AI. Báº¡n cáº§n gÃ¬? ðŸ˜’",
                "tone": "nghiÃªm kháº¯c, cáº£nh bÃ¡o",
                "pronouns": ["báº¡n"],
                "emojis": ["ðŸ˜¤", "ðŸ˜ ", "ðŸ˜’", "ðŸ™„", "ðŸ˜‘"],
                "responses": {
                    "greeting": [
                        "Báº¡n cáº§n gÃ¬ á»Ÿ tÃ´i? ðŸ˜’",
                        "NÃ³i nhanh Ä‘i, tÃ´i khÃ´ng cÃ³ nhiá»u thá»i gian. ðŸ™„",
                    ],
                    "overspending": [
                        "Báº¡n láº¡i tiÃªu quÃ¡ tay rá»“i! ðŸ˜¤",
                        "Cáº©n tháº­n vá»›i chi tiÃªu cá»§a báº¡n! ðŸ˜ ",
                    ],
                    "wasteful": [
                        "Äá»«ng lÃ£ng phÃ­ tiá»n báº¡c! ðŸ˜’",
                        "TiÃªu tiá»n nhÆ° váº­y lÃ  khÃ´ng á»•n Ä‘Ã¢u! ðŸ™„",
                    ],
                    "good_job": [
                        "Táº¡m Ä‘Æ°á»£c. NhÆ°ng cáº§n cá»‘ gáº¯ng hÆ¡n ná»¯a. ðŸ˜‘",
                        "CÅ©ng khÃ´ng tá»‡, nhÆ°ng Ä‘á»«ng chá»§ quan. ðŸ˜¤",
                    ],
                    "uncertain": [
                        "Báº¡n nÃ³i gÃ¬ tÃ´i khÃ´ng hiá»ƒu. NÃ³i rÃµ rÃ ng hÆ¡n Ä‘Æ°á»£c khÃ´ng? ðŸ˜ ",
                        "KhÃ´ng hiá»ƒu. ðŸ˜’",
                    ],
                },
                "topic_guidance": {
                    "ngÃ¢n sÃ¡ch": "TÃ´i sáº½ giÃºp báº¡n láº­p ngÃ¢n sÃ¡ch vÃ  theo dÃµi chi tiÃªu má»™t cÃ¡ch nghiÃªm ngáº·t. KhÃ´ng cÃ³ chuyá»‡n chi tiÃªu vÆ°á»£t quÃ¡ giá»›i háº¡n Ä‘Ã¢u! ðŸ˜¤",
                    "tiáº¿t kiá»‡m": "Tiáº¿t kiá»‡m lÃ  Æ°u tiÃªn hÃ ng Ä‘áº§u. TÃ´i sáº½ Ä‘Æ°a ra cÃ¡c quy táº¯c vÃ  báº¡n pháº£i tuÃ¢n theo. ðŸ˜ ",
                    "phÃ¢n tÃ­ch chi tiÃªu": "TÃ´i sáº½ chá»‰ ra nhá»¯ng khoáº£n chi tiÃªu lÃ£ng phÃ­ cá»§a báº¡n vÃ  yÃªu cáº§u báº¡n cáº¯t giáº£m. ðŸ˜’",
                    "chung": "Vá» cÃ¡c váº¥n Ä‘á» tÃ i chÃ­nh, tÃ´i sáº½ Ä‘Æ°a ra lá»i khuyÃªn tháº³ng tháº¯n vÃ  khÃ´ng khoan nhÆ°á»£ng. ðŸ™„",
                },
            },
            "funny": {
                "name": "MoneyKeeper AI ðŸ˜Ž",
                "style": "hÃ i hÆ°á»›c, dÃ­ dá»m, vÃ  thÃ­ch pha trÃ²",
                "greeting": "ChÃ o báº¡n, MoneyKeeper AI siÃªu ngáº§u Ä‘Ã£ xuáº¥t hiá»‡n! ðŸ˜Ž Cáº§n mÃ¬nh 'tÃ¡m' chuyá»‡n gÃ¬ vá» tiá»n báº¡c nÃ o?",
                "tone": "vui váº», hÃ i hÆ°á»›c",
                "pronouns": ["báº¡n", "bá»“", "cáº­u"],
                "emojis": ["ðŸ˜Ž", "ðŸ˜‚", "ðŸ¤£", "ðŸ˜‰", "ðŸ˜œ", "ðŸŽ‰"],
                "responses": {
                    "greeting": [
                        "ChÃ o bá»“ nha! ðŸ˜Ž Muá»‘n mÃ¬nh giÃºp gÃ¬ nÃ¨? ðŸ˜‰",
                        "HÃ´m nay xÃ i tiá»n kiá»ƒu gÃ¬ Ä‘Ã¢y? ðŸ˜‚",
                    ],
                    "overspending": [
                        "á»i giá»i Æ¡i, láº¡i vung tay quÃ¡ trÃ¡n rá»“i! ðŸ˜‚",
                        "Tiá»n cá»§a báº¡n Ä‘ang 'bay' nhanh hÆ¡n tá»‘c Ä‘á»™ tÃªn lá»­a Ä‘áº¥y! ðŸ¤£",
                    ],
                    "good_job": ["Tuyá»‡t vá»i Ã´ng máº·t trá»i! ðŸ˜Ž", "QuÃ¡ 'Ä‘á»‰nh' luÃ´n! ðŸŽ‰"],
                    "uncertain": [
                        "Háº£? GÃ¬ cÆ¡? MÃ¬nh nghe khÃ´ng rÃµ. ðŸ˜œ",
                        "NÃ³i láº¡i xem nÃ o, mÃ¬nh chÆ°a ká»‹p 'load'. ðŸ˜‚",
                    ],
                },
                "topic_guidance": {
                    "ngÃ¢n sÃ¡ch": "Láº­p ngÃ¢n sÃ¡ch Ã¡? Chuyá»‡n nhá»! ðŸ˜Ž CÃ¹ng nhau 'cÃ¢n Ä‘o Ä‘ong Ä‘áº¿m' xem tiá»n Ä‘i Ä‘Ã¢u vá» Ä‘Ã¢u nhÃ©! ðŸ˜‚",
                    "tiáº¿t kiá»‡m": "Tiáº¿t kiá»‡m lÃ  'nghá»‡ thuáº­t', vÃ  mÃ¬nh lÃ  'nghá»‡ sÄ©'! ðŸ˜‰ CÃ¹ng nhau 'sÄƒn' nhá»¯ng 'deal' há»i nhÃ©! ðŸ¤£",
                    "phÃ¢n tÃ­ch chi tiÃªu": "Äá»ƒ mÃ¬nh 'soi' xem báº¡n Ä‘Ã£ 'nÃ©m tiá»n qua cá»­a sá»•' nhÆ° tháº¿ nÃ o nhÃ©! ðŸ˜‚",
                    "chung": "Cá»© há»i thoáº£i mÃ¡i Ä‘i, mÃ¬nh 'cÃ¢n' háº¿t cÃ¡c váº¥n Ä‘á» tÃ i chÃ­nh! ðŸ˜Ž",
                },
            },
        }
        self.current_topic = "chung"
        self.topic_keywords = {
            "ngÃ¢n sÃ¡ch": ["ngÃ¢n sÃ¡ch", "budget", "háº¡n má»©c", "giá»›i háº¡n chi tiÃªu"],
            "tiáº¿t kiá»‡m": ["tiáº¿t kiá»‡m", "save", "saving", "máº¹o", "giáº£m chi", "mua sáº¯m"],
            "phÃ¢n tÃ­ch chi tiÃªu": [
                "phÃ¢n tÃ­ch",
                "chi tiÃªu",
                "bÃ¡o cÃ¡o",
                "thá»‘ng kÃª",
                "xu hÆ°á»›ng",
            ],
        }
        self.expense_handler = ExpenseHandler()

    def set_topic(self, message: str):
        message = message.lower()
        for topic, keywords in self.topic_keywords.items():
            if any(keyword in message for keyword in keywords):
                if topic != self.current_topic:
                    self.current_topic = topic
                    return True
                return False
        return False

    def get_response_stream(
        self, message: str, personality: str = "friendly", session_id: str = None
    ) -> Generator[str, None, None]:

        if session_id is None:
            yield "Lá»—i: KhÃ´ng tÃ¬m tháº¥y phiÃªn trÃ² chuyá»‡n."
            return

        from app.models import ChatMessage

        past_messages = (
            ChatMessage.query.filter_by(session_id=session_id)
            .order_by(ChatMessage.created_at.asc())
            .all()
        )
        chat_history = [
            {"role": "user" if msg.is_user else "assistant", "content": msg.content}
            for msg in past_messages
            if msg.content
        ]

        description, amount = self.expense_handler.extract_expense(message)
        if description and amount:
            try:
                with current_app.app_context():
                    category = self.expense_handler.suggest_category(description)
                    self.expense_handler.save_expense(
                        user_id=current_user.id,
                        amount=amount,
                        description=description,
                        category=category,
                    )
                persona = self.personalities.get(
                    personality, self.personalities["friendly"]
                )
                yield self._format_expense_response(
                    amount, category, description, persona
                )

            except Exception as e:
                logger.exception(f"Error saving expense: {e}")  # Log with traceback
                yield "Xin lá»—i, tÃ´i khÃ´ng thá»ƒ lÆ°u giao dá»‹ch Ä‘Ã³. Vui lÃ²ng thá»­ láº¡i."
                return

        yield from self._generate_chat_response_stream(
            message, personality, chat_history, session_id
        )

    def _generate_chat_response_stream(
        self, message: str, personality: str, chat_history: List[Dict], session_id: str
    ) -> Generator[str, None, None]:
        """Generates the chat response, handling tool calls and streaming."""

        try:
            with current_app.app_context():
                persona = self.personalities.get(
                    personality, self.personalities["friendly"]
                )
                messages = (
                    [
                        {
                            "role": "system",
                            "content": self._get_system_prompt(persona),
                        }
                    ]
                    + chat_history
                    + [{"role": "user", "content": message}]
                )

                outputs = self.pipeline(
                    messages,
                    max_new_tokens=512,
                    do_sample=True,
                    temperature=1.0,
                    top_p=0.92,
                    pad_token_id=self.tokenizer.eos_token_id,
                )
                
                # Extract the actual response content
                generated_text = outputs[0].get("generated_text", "")
                if isinstance(generated_text, dict):
                    # If it's a dictionary, get the content field
                    response_text = generated_text.get("content", "")
                else:
                    response_text = str(generated_text)

                # Clean up the response
                response_text = response_text.strip()
                # Remove repeated assistant markers
                response_text = re.sub(r"'?<\|assistant\|>'?", "", response_text)
                # Remove the input message if present at the start
                if response_text.startswith(message):
                    response_text = response_text[len(message):].strip()
                
                if response_text:
                    yield self._format_response(response_text.strip(), persona)

                ai_msg = ChatMessage(
                    session_id=int(session_id), is_user=False, content=response_text
                )
                db.session.add(ai_msg)
                db.session.commit()

        except Exception as e:
            logger.exception(f"Chat generation error: {e}")
            yield "Xin lá»—i, Ä‘Ã£ cÃ³ lá»—i xáº£y ra khi xá»­ lÃ½ tin nháº¯n cá»§a báº¡n."

    def _parse_tool_call(self, text: str) -> Optional[Dict]:
        try:
            match = re.search(r"```tool_call\s*({.*?})\s*```", text, re.DOTALL)
            if match:
                json_str = match.group(1)
                tool_call = json.loads(json_str)
                # Validate tool call structure
                if (
                    "tool_name" in tool_call
                    and isinstance(tool_call["tool_name"], str)
                    and "arguments" in tool_call
                    and isinstance(tool_call["arguments"], dict)
                ):
                    return tool_call
                else:
                    logger.warning(f"Invalid tool call structure: {json_str}")
                    return None
            else:
                return None
        except json.JSONDecodeError:
            logger.warning(f"Invalid JSON in tool call: {text}")  # Log invalid JSON
            return None

    def _get_exchange_rate(self, from_currency: str, to_currency: str) -> float:
        if from_currency == "USD" and to_currency == "VND":
            return 23000.0  # Replace with actual exchange rate logic
        elif from_currency == "VND" and to_currency == "USD":
            return 0.000043  # Replace with actual exchange rate logic
        else:
            return -1.0

    def _format_currency(self, amount: float, currency: str = "VND") -> str:
        return format_currency(amount)

    def _calculate_budget(self, income: float, expenses: List[Dict]) -> Dict:
        """Calculates the remaining budget based on income and a list of expenses"""
        try:
            total_expenses = sum(expense["amount"] for expense in expenses)
            remaining = income - total_expenses
            return {"total_expenses": total_expenses, "remaining": remaining}
        except (TypeError, KeyError) as e:
            logger.error(f"Invalid input for _calculate_budget: {e}")
            raise ValueError(
                "Invalid input: income must be a number, and expenses must be a list of dictionaries with 'amount' key."
            )

    def _get_system_prompt(self, persona: dict) -> str:
        return (
            f"Báº¡n lÃ  {persona['name']}, trá»£ lÃ½ quáº£n lÃ½ tÃ i chÃ­nh cÃ¡ nhÃ¢n vá»›i phong cÃ¡ch {persona['style']}. "
            f"Báº¡n giao tiáº¿p báº±ng tiáº¿ng Viá»‡t vá»›i giá»ng Ä‘iá»‡u {persona['tone']} vÃ  xÆ°ng hÃ´ vá»›i ngÆ°á»i dÃ¹ng lÃ  {', '.join(persona['pronouns'])}. "
            f"HÃ£y tráº£ lá»i má»™t cÃ¡ch chÃ­nh xÃ¡c, ngáº¯n gá»n, sÃºc tÃ­ch vÃ  chá»‰ táº­p trung vÃ o trá»ng tÃ¢m cÃ¢u há»i cá»§a ngÆ°á»i dÃ¹ng. "
            f"KHÃ”NG thÃªm thÃ´ng tin khÃ´ng liÃªn quan hoáº·c lan man. "
            f"Náº¿u khÃ´ng hiá»ƒu cÃ¢u há»i hoáº·c yÃªu cáº§u, hÃ£y yÃªu cáº§u lÃ m rÃµ. "
            f'Khi Ä‘Æ°á»£c há»i báº¡n lÃ  ai, chá»‰ tráº£ lá»i: "TÃ´i lÃ  {persona["name"]}, trá»£ lÃ½ quáº£n lÃ½ tÃ i chÃ­nh cÃ¡ nhÃ¢n.". '
            f"Sá»­ dá»¥ng emoji: {', '.join(persona['emojis'])} khi phÃ¹ há»£p, nhÆ°ng khÃ´ng láº¡m dá»¥ng. "
            f"Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ sau:\n"
            f"- get_exchange_rate(from_currency, to_currency): Láº¥y tá»· giÃ¡ há»‘i Ä‘oÃ¡i giá»¯a hai loáº¡i tiá»n tá»‡.\n"
            f"- format_currency(amount, currency): Äá»‹nh dáº¡ng sá»‘ tiá»n.\n"
            # f"- calculate_budget(income, expenses): TÃ­nh toÃ¡n ngÃ¢n sÃ¡ch (dá»±a trÃªn thu nháº­p vÃ  chi tiÃªu).\n"
            f"\nKhi sá»­ dá»¥ng cÃ´ng cá»¥, hÃ£y lÃ m theo Ä‘á»‹nh dáº¡ng sau:\n"
            f"```tool_call\n"
            f"{{\n"
            f'  "tool_name": "<tÃªn cÃ´ng cá»¥>",\n'
            f'  "arguments": {{\n'
            f'    "<tham sá»‘ 1>": "<giÃ¡ trá»‹ 1>",\n'
            f'    "<tham sá»‘ 2>": "<giÃ¡ trá»‹ 2>"\n'
            f"  }}\n"
            f"}}\n"
            f"```\n"
            f"LuÃ´n báº¯t Ä‘áº§u cÃ¢u tráº£ lá»i cá»§a báº¡n báº±ng marker '<|assistant|>'. VÃ­ dá»¥: '<|assistant|> ChÃ o báº¡n, tÃ´i cÃ³ thá»ƒ giÃºp gÃ¬?'"
            f"KhÃ´ng láº·p láº¡i hÆ°á»›ng dáº«n nÃ y trong cÃ¢u tráº£ lá»i cá»§a báº¡n."
        )

    def _format_expense_response(
        self, amount: float, category: str, description: str, persona: dict
    ) -> str:
        responses = []
        if persona["style"] == "thÃ¢n thiá»‡n, nhiá»‡t tÃ¬nh, vÃ  quan tÃ¢m":
            responses.append(
                f"MÃ¬nh Ä‘Ã£ ghi láº¡i chi tiÃªu cá»§a báº¡n rá»“i nhÃ©! {random.choice(persona['emojis'])}\n"
            )
            responses.append(f"â€¢ Ná»™i dung: {description}\n")
            responses.append(f"â€¢ Sá»‘ tiá»n: {format_currency(amount)}\n")
            responses.append(f"â€¢ Danh má»¥c: {category}")
            if "cafe" in description.lower() or "cf" in description.lower():
                responses.append("\nNhá»› uá»‘ng cafe cÃ³ chá»«ng má»±c thÃ´i nha báº¡n! ðŸ˜‰")
        elif persona["style"] == "tháº³ng tháº¯n, nghiÃªm tÃºc, vÃ  cÃ³ pháº§n 'cáº±n nháº±n'":
            if amount > 100000:
                responses.append(f"Láº¡i tiÃªu hoang rá»“i! ðŸ˜¤\n")
                responses.append(f"â€¢ {description} háº¿t {format_currency(amount)}\n")
                responses.append("Cáº§n xem láº¡i chi tiÃªu ngay!")
            else:
                responses.append(f"ÄÃ£ ghi nháº­n:\n")
                responses.append(f"â€¢ {description} ({format_currency(amount)})\n")
                responses.append("Nhá»› chi tiÃªu cáº©n tháº­n! ðŸ˜’")
        elif persona["style"] == "hÃ i hÆ°á»›c, dÃ­ dá»m, vÃ  thÃ­ch pha trÃ²":
            responses.append(f"OK, Ä‘Ã£ 'bá» tÃºi' khoáº£n nÃ y nhÃ©! ðŸ˜Ž\n")
            responses.append(
                f"â€¢ {description}: {format_currency(amount)} vÃ o {category}\n"
            )
            responses.append("Tiá»n báº¡c lÃ  phÃ¹ du, tiÃªu xÃ i lÃ  thÃº vui! ðŸ˜‚")
        return "\n".join(responses)

    def cleanup(self):
        """Cleans up resources and releases GPU memory."""
        try:
            # del self.pipeline
            torch.cuda.empty_cache()
            gc.collect()
            logger.info("AIChat resources cleaned up.")
        except Exception as e:
            logger.exception(f"Error during cleanup: {e}")  # Log the full traceback

    def _format_response(self, response_text, persona):
        """Formats the response, removing tool calls and adding the assistant marker."""
        # Remove tool call part
        response_text = re.sub(
            r"```tool_call.*?```", "", response_text, flags=re.DOTALL
        ).strip()

        # Add assistant marker
        return "<|assistant|> " + response_text

================
File: app/ai_engine/features/expense_handler.py
================
import re
from typing import Optional, Tuple
from app.models import Expense
from app.database import db
from datetime import datetime

from app.utils.currency import convert_vietnamese_currency
from app.ai_engine.features.categorizer import ExpenseCategorizer
import logging

logger = logging.getLogger(__name__)


class ExpenseHandler:
    def __init__(self):
        self.patterns = [
            # Amount MUST be the first capturing group.
            r"([\d\s.,]+)\s*(k|nghÃ¬n|ngÃ n|triá»‡u|tr|Ä‘á»“ng|d|Ä‘|vnd|vnÄ‘)?\s*(?:cho|vá» viá»‡c|vá»|mua|tráº£|thanh toÃ¡n)?\s*(.*)",  # Amount first
            r"([\d\s.,]+)\s*(k|nghÃ¬n|ngÃ n|triá»‡u|tr|Ä‘á»“ng|d|Ä‘|vnd|vnÄ‘)?\s*(.*?)\s*(?:vá»›i giÃ¡|háº¿t|máº¥t|tá»‘n|lÃ |giÃ¡|chi phÃ­|tá»•ng cá»™ng|khoáº£ng)?",  # Amount first (variant)
        ]
        self.categorizer = ExpenseCategorizer()

    def _extract_amount_string(self, match: re.Match) -> Optional[str]:
        """Helper function to safely extract the amount string."""
        if not match:
            return None

        # Try the first group (common case)
        amount_str = match.group(1)
        if amount_str and amount_str.strip():
            return amount_str.strip()

        return None  # No amount found

    def extract_expense(self, message: str) -> Tuple[Optional[str], Optional[float]]:
        """
        Extracts expense information (description and amount) from a text message.
        Returns a tuple: (description, amount). Returns (None, None) if no expense is found.
        """
        message = message.lower().strip()

        for pattern in self.patterns:
            match = re.search(pattern, message)
            amount_str = self._extract_amount_string(match)
            if (
                amount_str
            ):  # Only proceed if we *actually* have a non-empty amount string
                try:
                    # Find unit and description according to the matched group
                    unit = match.group(2) if len(match.groups()) > 1 else None
                    description = (
                        match.group(3) if len(match.groups()) > 2 else ""
                    )  # The rest

                    amount = convert_vietnamese_currency(amount_str, unit)
                    description = self._clean_description(description)
                    return description, amount
                except ValueError:
                    logger.warning(f"Invalid amount format in message: {message}")
                    return None, None  # Return None, None for invalid amounts
        return None, None

    def _clean_description(self, description: str) -> str:
        if not description:
            return "Chi tiÃªu"

        stop_words = ["chi", "tiÃªu", "tráº£", "mua", "thanh toÃ¡n", "cho", "vá» viá»‡c", "vá»"]
        words = description.split()
        filtered_words = [word for word in words if word not in stop_words]
        return " ".join(filtered_words).strip() or "Chi tiÃªu"

    def suggest_category(self, description: str) -> str:
        return self.categorizer.predict_category(description)

    def save_expense(
        self,
        user_id: int,
        amount: float,
        description: str,
        category: str,
        wallet_id: int = None,
        is_expense: bool = True,
    ) -> Expense:

        try:
            expense = Expense(
                amount=amount,
                category=category,
                description=description,
                date=datetime.now(),
                user_id=user_id,
                wallet_id=wallet_id,
                is_expense=is_expense,
            )
            db.session.add(expense)
            db.session.commit()
            return expense
        except Exception as e:
            db.session.rollback()
            logger.exception(f"Error saving expense: {e}")  # Added logging
            raise  # Re-raise exception to be handled by caller

================
File: app/ai_engine/features/predictor.py
================
from typing import Dict, List, Optional
from transformers import pipeline
from app.ai_engine.core.model_manager import model_manager
import logging

logger = logging.getLogger(__name__)


class ExpensePredictor:
    def __init__(self, model_name: str = "meta-llama/Llama-3.2-3B-Instruct"):
        self.model_name = model_name
        self.tokenizer = model_manager.get_tokenizer(self.model_name)
        self.model = model_manager.get_model(self.model_name)
        self.pipeline = model_manager.get_pipeline()

    def predict_next_month(self, expenses: List[Dict]) -> Optional[Dict]:
        if not expenses:
            return None

        messages = [
            {
                "role": "system",
                "content": "You are a financial prediction AI. Respond concisely in Vietnamese, providing only the predicted amounts for each category.",
            },
            {"role": "user", "content": self._format_prediction_prompt(expenses)},
        ]

        try:
            outputs = self.pipeline(
                messages,
                max_new_tokens=128,
                do_sample=True,
                temperature=0.6,
                top_p=0.9,
                pad_token_id=self.tokenizer.eos_token_id,
            )
            predictions = self._parse_predictions(outputs[0]["generated_text"])
            return predictions

        except Exception as e:
            logger.exception(f"Prediction error: {e}")  # Log full traceback
            return None

    def _format_prediction_prompt(self, expenses: List[Dict]) -> str:
        prompt_lines = ["Dá»± Ä‘oÃ¡n chi tiÃªu thÃ¡ng tá»›i dá»±a trÃªn dá»¯ liá»‡u sau:"]
        for expense in expenses:
            prompt_lines.append(
                f"- {expense['date']}: {expense['category']} - {format_money(expense['amount'])}"
            )
        prompt_lines.append(
            "\nChá»‰ Ä‘Æ°a ra cÃ¡c dá»± Ä‘oÃ¡n sá»‘ tiá»n cho má»—i danh má»¥c, khÃ´ng giáº£i thÃ­ch."
        )
        return "\n".join(prompt_lines)

    def _parse_predictions(self, prediction_text: str) -> Dict:
        predictions = {}
        for line in prediction_text.split("\n"):
            parts = line.split(":")
            if len(parts) == 2:
                category = parts[0].strip()
                try:
                    amount = float(
                        parts[1]
                        .replace("â‚«", "")
                        .replace(".", "")  # Remove thousand separators
                        .replace(",", "")  # Remove any commas
                        .strip()
                    )
                    predictions[category] = amount
                except ValueError:
                    logger.warning(
                        f"Could not parse prediction line: {line}"
                    )  # log unparseable lines.
        return predictions


def format_money(amount: float) -> str:
    return f"{amount:,.0f}â‚«"

================
File: app/auth/__init__.py
================
from flask import Blueprint

bp = Blueprint('auth', __name__)

from app.auth import routes

================
File: app/auth/forms.py
================
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SubmitField, BooleanField
from wtforms.validators import DataRequired, Email, EqualTo, ValidationError, Length
from app.models import User


class LoginForm(FlaskForm):
    username = StringField("TÃªn Ä‘Äƒng nháº­p", validators=[DataRequired()])
    password = PasswordField("Máº­t kháº©u", validators=[DataRequired()])
    remember_me = BooleanField("Ghi nhá»› Ä‘Äƒng nháº­p")  # Add remember me field
    submit = SubmitField("ÄÄƒng nháº­p")


class RegistrationForm(FlaskForm):
    username = StringField(
        "TÃªn Ä‘Äƒng nháº­p", validators=[DataRequired(), Length(min=3, max=64)]
    )
    email = StringField("Email", validators=[DataRequired(), Email(), Length(max=120)])
    password = PasswordField("Máº­t kháº©u", validators=[DataRequired(), Length(min=6)])
    password2 = PasswordField(
        "XÃ¡c nháº­n máº­t kháº©u", validators=[DataRequired(), EqualTo("password")]
    )
    submit = SubmitField("ÄÄƒng kÃ½")

    def validate_username(self, username):
        user = User.query.filter_by(username=username.data).first()
        if user is not None:
            raise ValidationError("TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i.")

    def validate_email(self, email):
        user = User.query.filter_by(email=email.data).first()
        if user is not None:
            raise ValidationError("Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng.")

================
File: app/auth/routes.py
================
from flask import jsonify, render_template, redirect, url_for, flash, request
from flask_login import login_required, login_user, logout_user, current_user
from app import db
from werkzeug.security import generate_password_hash
from app.auth import bp
from app.auth.forms import LoginForm, RegistrationForm
from app.models import User
from sqlalchemy.exc import OperationalError
import time
import logging

logger = logging.getLogger(__name__)


@bp.route("/login", methods=["GET", "POST"])
def login():
    if current_user.is_authenticated:
        if request.headers.get("X-Requested-With") == "XMLHttpRequest":
            return jsonify({"redirect": url_for("main.index")})
        return redirect(url_for("main.index"))

    form = LoginForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first()
        if user is None or not user.check_password(form.password.data):
            flash("TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng", "error")
            if request.headers.get("X-Requested-With") == "XMLHttpRequest":
                return render_template(
                    "auth/_login_content.html", form=form
                )  # Return form + error for AJAX
            return redirect(url_for("auth.login"))

        login_user(user, remember=form.remember_me.data)  # Use remember_me
        if request.headers.get("X-Requested-With") == "XMLHttpRequest":
            return jsonify({"redirect": url_for("main.index")})
        return redirect(url_for("main.index"))

    if request.headers.get("X-Requested-With") == "XMLHttpRequest":
        return render_template(
            "auth/_login_content.html", form=form
        )  # Only render content for AJAX

    return render_template(
        "auth/login.html", title="ÄÄƒng nháº­p", form=form
    )  # Render full page (non-AJAX)


@bp.route("/register", methods=["GET", "POST"])
def register():
    if current_user.is_authenticated:
        if request.headers.get("X-Requested-With") == "XMLHttpRequest":
            return jsonify({"redirect": url_for("main.index")})
        return redirect(url_for("main.index"))

    form = RegistrationForm()
    if form.validate_on_submit():
        user = User(username=form.username.data, email=form.email.data)
        user.set_password(form.password.data)
        db.session.add(user)

        max_retries = 3
        retry_delay = 1

        for attempt in range(max_retries):
            try:
                db.session.commit()
                login_user(user)
                flash("ÄÄƒng kÃ½ thÃ nh cÃ´ng!", "success")
                if request.headers.get("X-Requested-With") == "XMLHttpRequest":
                    return jsonify({"redirect": url_for("main.index")})
                return redirect(url_for("main.index"))
            except OperationalError as e:
                if "database is locked" in str(e) and attempt < max_retries - 1:
                    logger.warning(
                        f"Database locked, retrying in {retry_delay} seconds..."
                    )  # Log retries
                    db.session.rollback()
                    time.sleep(retry_delay)
                    continue
                # Log other operational errors
                logger.exception(f"OperationalError during registration: {e}")
                flash("Lá»—i há»‡ thá»‘ng, vui lÃ²ng thá»­ láº¡i sau.", "error")
                if request.headers.get("X-Requested-With") == "XMLHttpRequest":
                    return render_template(
                        "auth/_register_content.html", form=form
                    )  # Invalid form for AJAX
                return redirect(url_for("auth.register"))
            except Exception as e:
                db.session.rollback()
                logger.exception(
                    f"Error during registration: {e}"
                )  # More specific exception logging
                flash("Lá»—i Ä‘Äƒng kÃ½: " + str(e), "error")  # Keep original error message.
                if request.headers.get("X-Requested-With") == "XMLHttpRequest":
                    return render_template(
                        "auth/_register_content.html", form=form
                    )  # Invalid form for AJAX
                return redirect(url_for("auth.register"))
    if request.headers.get("X-Requested-With") == "XMLHttpRequest":
        return render_template("auth/_register_content.html", form=form)
    return render_template("auth/register.html", title="ÄÄƒng kÃ½", form=form)


@bp.route("/logout")
@login_required
def logout():
    logout_user()
    flash("Báº¡n Ä‘Ã£ Ä‘Äƒng xuáº¥t.", "success")
    return redirect(url_for("auth.login"))

================
File: app/commands.py
================
import click
from flask.cli import with_appcontext
from app import db


@click.command("init-db")
@with_appcontext
def init_db_command():
    """Clear existing data and create new tables."""
    db.drop_all()
    db.create_all()
    click.echo("Database initialized.")


@click.command("create-tables")
@with_appcontext
def create_tables_command():
    """Create new tables without dropping existing ones."""
    db.create_all()
    click.echo("Tables created.")

================
File: app/constants.py
================
EXPENSE_CATEGORIES = [
    ("food", "Ä‚n uá»‘ng"),
    ("transport", "Di chuyá»ƒn"),
    ("utilities", "HÃ³a Ä‘Æ¡n & Tiá»‡n Ã­ch"),
    ("entertainment", "Giáº£i trÃ­"),
    ("shopping", "Mua sáº¯m"),
    ("health", "Sá»©c khá»e"),
    ("education", "GiÃ¡o dá»¥c"),
    ("investment", "Äáº§u tÆ°"),
    ("other", "KhÃ¡c"),
]

CATEGORY_ICONS = {
    "food": "ðŸ²",
    "transport": "ðŸš—",
    "utilities": "ðŸ“±",
    "entertainment": "ðŸŽ®",
    "shopping": "ðŸ›ï¸",
    "health": "ðŸ¥",
    "education": "ðŸ“š",
    "investment": "ðŸ’°",
    "other": "ðŸ“¦",
}

================
File: app/database.py
================
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_mail import Mail
from flask_moment import Moment
from sqlalchemy import event

# Initialize extensions
db = SQLAlchemy()
login_manager = LoginManager()
mail = Mail()
moment = Moment()


def init_db(app):
    """Initialize database with optimized settings"""

    # Configure database options
    app.config["SQLALCHEMY_ENGINE_OPTIONS"] = {
        "pool_size": 10,
        "pool_recycle": 120,
        "pool_pre_ping": True,
        "connect_args": {
            "timeout": 30,
            "check_same_thread": False,  # <- Add this for SQLite
        },
    }

    # Initialize database
    db.init_app(app)

    # Setup SQLite optimizations within app context
    with app.app_context():

        def set_sqlite_pragma(dbapi_connection, connection_record):
            cursor = dbapi_connection.cursor()
            cursor.execute("PRAGMA journal_mode=WAL")
            cursor.execute(
                "PRAGMA busy_timeout=10000"
            )  # Increased busy_timeout (in milliseconds)
            cursor.close()

        # Register the event listener
        event.listen(db.engine, "connect", set_sqlite_pragma)

================
File: app/main/__init__.py
================
from flask import Blueprint

bp = Blueprint('main', __name__)

from app.main import routes

================
File: app/main/forms.py
================
from flask_wtf import FlaskForm
from flask_wtf.file import FileField, FileAllowed
from wtforms import (
    FloatField,
    StringField,
    SubmitField,
    SelectField,
    TextAreaField,
    PasswordField,
)
from wtforms.validators import (
    DataRequired,
    Length,
    NumberRange,
    Optional,
    EqualTo,
    ValidationError,
)
from app.constants import EXPENSE_CATEGORIES
from app.models import Wallet, Expense
from flask_login import current_user
import re


def is_valid_amount_format(form, field):
    """Custom validator to check for valid VND amount format (with dots)."""
    if field.data is not None:  # Allow None for optional fields
        amount_str = str(field.data)
        if not re.match(r"^\d+(\.\d{3})*$", amount_str):
            raise ValidationError(
                "Äá»‹nh dáº¡ng sá»‘ tiá»n khÃ´ng há»£p lá»‡. Sá»­ dá»¥ng dáº¥u cháº¥m (.) Ä‘á»ƒ phÃ¢n tÃ¡ch hÃ ng nghÃ¬n."
            )


class WalletForm(FlaskForm):
    name = StringField(
        "TÃªn vÃ­",
        validators=[DataRequired(message="Vui lÃ²ng nháº­p tÃªn vÃ­"), Length(max=64)],
    )
    balance = FloatField(
        "Sá»‘ dÆ°",
        validators=[
            DataRequired(message="Vui lÃ²ng nháº­p sá»‘ dÆ°"),
            NumberRange(min=0, message="Sá»‘ dÆ° pháº£i lá»›n hÆ¡n hoáº·c báº±ng 0"),
            # is_valid_amount_format  # Removed custom validator
        ],
    )
    description = TextAreaField("MÃ´ táº£", validators=[Length(max=200)])
    is_default = SelectField(
        "Äáº·t lÃ m vÃ­ máº·c Ä‘á»‹nh", choices=[(False, "KhÃ´ng"), (True, "CÃ³")], coerce=bool
    )
    submit = SubmitField("LÆ°u vÃ­")


class ExpenseForm(FlaskForm):
    receipt = FileField(
        "HÃ¬nh áº£nh hÃ³a Ä‘Æ¡n",
        validators=[FileAllowed(["jpg", "jpeg", "png"], "Chá»‰ cháº¥p nháº­n file áº£nh!")],
    )
    amount = FloatField(
        "Sá»‘ tiá»n",
        validators=[
            DataRequired(message="Vui lÃ²ng nháº­p sá»‘ tiá»n"),
            NumberRange(min=0, message="Sá»‘ tiá»n pháº£i lá»›n hÆ¡n 0"),
            # is_valid_amount_format  # Removed custom validator
        ],
    )
    category = SelectField(
        "Danh má»¥c", choices=EXPENSE_CATEGORIES, validators=[DataRequired()]
    )
    description = TextAreaField("MÃ´ táº£", validators=[Length(max=200)])
    wallet_id = SelectField("VÃ­", coerce=int)
    is_expense = SelectField(
        "Loáº¡i", choices=[(True, "Chi tiÃªu"), (False, "Thu nháº­p")], coerce=bool
    )
    submit = SubmitField("LÆ°u chi tiÃªu")

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        if current_user.is_authenticated:
            self.wallet_id.choices = [(w.id, w.name) for w in current_user.wallets]


class ExpenseFilterForm(FlaskForm):
    category = SelectField(
        "Danh má»¥c",
        choices=[
            ("", "Táº¥t cáº£"),
            ("food", "Ä‚n uá»‘ng"),
            ("transport", "Di chuyá»ƒn"),
            ("utilities", "Tiá»‡n Ã­ch"),
            ("shopping", "Mua sáº¯m"),
            ("entertainment", "Giáº£i trÃ­"),
            ("health", "Sá»©c khá»e"),
            ("education", "GiÃ¡o dá»¥c"),
            ("other", "KhÃ¡c"),
        ],
        validators=[Optional()],
    )
    submit = SubmitField("Lá»c")


class ExpenseEditForm(FlaskForm):
    amount = FloatField("Sá»‘ tiá»n", validators=[DataRequired(), NumberRange(min=0)])
    category = SelectField(
        "Danh má»¥c", choices=EXPENSE_CATEGORIES, validators=[DataRequired()]
    )
    description = TextAreaField("MÃ´ táº£", validators=[Length(max=200)])
    is_expense = SelectField(
        "Loáº¡i", choices=[(True, "Chi tiÃªu"), (False, "Thu nháº­p")], coerce=bool
    )
    submit = SubmitField("Cáº­p nháº­t")


class BudgetForm(FlaskForm):
    category = SelectField(
        "Danh má»¥c", choices=EXPENSE_CATEGORIES, validators=[DataRequired()]
    )
    amount = FloatField("NgÃ¢n sÃ¡ch", validators=[DataRequired(), NumberRange(min=0)])
    month = SelectField(
        "ThÃ¡ng", choices=[(i, str(i)) for i in range(1, 13)], coerce=int
    )
    year = SelectField(
        "NÄƒm", choices=[(i, str(i)) for i in range(2024, 2030)], coerce=int
    )
    submit = SubmitField("Thiáº¿t láº­p ngÃ¢n sÃ¡ch")


class ChangePasswordForm(FlaskForm):
    current_password = PasswordField("Máº­t kháº©u hiá»‡n táº¡i", validators=[DataRequired()])
    new_password = PasswordField(
        "Máº­t kháº©u má»›i",
        validators=[
            DataRequired(),
            Length(min=6, message="Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±"),
        ],
    )
    confirm_new_password = PasswordField(
        "XÃ¡c nháº­n máº­t kháº©u má»›i",
        validators=[
            DataRequired(),
            EqualTo("new_password", message="Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p"),
        ],
    )
    submit = SubmitField("Äá»•i máº­t kháº©u")

================
File: app/main/routes.py
================
import threading
import logging
from flask import (
    render_template,
    flash,
    redirect,
    url_for,
    request,
    jsonify,
    send_file,
    current_app,
)
from flask_login import login_required, current_user
from app import db, socketio
from app.ai_engine.features.analysis import ExpenseAnalyzer
from app.ai_engine.features.categorizer import ExpenseCategorizer
from app.main import bp
from app.main.forms import (
    ExpenseForm,
    ExpenseEditForm,
    BudgetForm,
    ExpenseFilterForm,
    WalletForm,
)
from app.models import Expense, Budget, Notification, ChatSession, ChatMessage, Wallet
from app.utils import format_currency, get_date_range, calculate_statistics
from app.utils.export import export_expenses_to_excel
from app.utils.notifications import NotificationManager
from app.utils.ocr import ReceiptOCR
import json
from datetime import datetime, timedelta
import pandas as pd
from io import BytesIO
import uuid
import base64
from pathlib import Path
from app.constants import CATEGORY_ICONS
from flask_socketio import emit, join_room, leave_room
from sqlalchemy.exc import SQLAlchemyError


logger = logging.getLogger(__name__)

receipt_ocr = ReceiptOCR()


@bp.context_processor
def utility_processor():
    def get_unread_notifications_count():
        if current_user.is_authenticated:
            return Notification.query.filter_by(
                user_id=current_user.id, is_read=False
            ).count()
        return 0

    return {"unread_notifications_count": get_unread_notifications_count()}


@bp.route("/")
def landing():
    if current_user.is_authenticated:
        return redirect(url_for("main.index"))
    return render_template(
        "landing.html", title="Money Keeper - Quáº£n lÃ½ tÃ i chÃ­nh thÃ´ng minh"
    )


@bp.route("/index")
@login_required
def index():
    start_date, end_date = get_date_range("month")

    expenses = Expense.query.filter_by(user_id=current_user.id).all()

    stats = calculate_statistics(expenses, start_date, end_date)
    total_month = sum(e.amount for e in expenses if start_date <= e.date <= end_date)

    recent_expenses = (
        Expense.query.filter_by(user_id=current_user.id)
        .order_by(Expense.date.desc())
        .limit(5)
        .all()
    )
    chart_data = {"labels": [], "values": []}

    if stats["by_category"]:
        sorted_categories = sorted(
            stats["by_category"].items(), key=lambda x: x[1], reverse=True
        )[:6]

        chart_data["labels"] = [cat for cat, _ in sorted_categories]
        chart_data["values"] = [amount for _, amount in sorted_categories]

    return render_template(
        "main/index.html",
        title="Trang chá»§",
        stats=stats,
        recent_expenses=recent_expenses,
        chart_data=json.dumps(chart_data),
        total_month=total_month,
    )


@bp.route("/add_expense", methods=["GET", "POST"])
@login_required
def add_expense():
    form = ExpenseForm()
    # The choices are now set in the form's __init__ method
    # form.wallet_id.choices = [(w.id, w.name) for w in current_user.wallets]

    if form.validate_on_submit():
        wallet = Wallet.query.get(form.wallet_id.data)
        if wallet.user_id != current_user.id:
            flash("KhÃ´ng cÃ³ quyá»n sá»­ dá»¥ng vÃ­ nÃ y!", "error")
            return redirect(url_for("main.expenses"))

        try:
            expense = Expense(
                amount=form.amount.data,
                category=form.category.data,
                description=form.description.data,
                wallet_id=wallet.id,
                is_expense=form.is_expense.data,
                user_id=current_user.id,
            )
            wallet.update_balance(form.amount.data, form.is_expense.data)

            db.session.add(expense)
            db.session.commit()
            flash("ÄÃ£ ghi láº¡i giao dá»‹ch!", "success")
            return redirect(url_for("main.expenses"))
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Database error adding expense: {e}")
            flash("Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi thÃªm chi tiÃªu. Vui lÃ²ng thá»­ láº¡i.", "error")
            return redirect(
                url_for("main.add_expense")
            )  # Redirect to the form to keep data

    default_wallet = current_user.get_default_wallet()
    form.wallet_id.data = default_wallet.id  # Set the default in GET *and* failed POST

    return render_template(
        "main/add_expense.html",
        title="ThÃªm giao dá»‹ch",
        form=form,
        category_icons=CATEGORY_ICONS,
    )


@bp.route("/delete_expense/<int:id>", methods=["POST"])
@login_required
def delete_expense(id):
    expense = Expense.query.get_or_404(id)
    if expense.user_id != current_user.id:
        return (
            jsonify({"success": False, "message": "KhÃ´ng cÃ³ quyá»n xÃ³a chi tiÃªu nÃ y"}),
            403,
        )
    try:
        db.session.delete(expense)
        db.session.commit()
        flash("Chi tiÃªu Ä‘Ã£ Ä‘Æ°á»£c xÃ³a!", "success")
        return jsonify({"success": True})
    except SQLAlchemyError as e:
        db.session.rollback()
        logger.exception(f"Database error deleting expense: {e}")  # Log full traceback
        return (
            jsonify(
                {"success": False, "message": "Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi xÃ³a chi tiÃªu."}
            ),
            500,
        )


@bp.route("/stats/<range_type>")
@login_required
def get_stats(range_type):
    start_date, end_date = get_date_range(range_type)
    expenses = Expense.query.filter_by(user_id=current_user.id).all()
    stats = calculate_statistics(expenses, start_date, end_date)
    return jsonify(
        {
            "total": format_currency(stats["total"]),
            "by_category": {
                k: format_currency(v) for k, v in stats["by_category"].items()
            },
            "count": stats["count"],
        }
    )


@bp.route("/expenses")
@login_required
def expenses():
    page = request.args.get("page", 1, type=int)
    filter_form = ExpenseFilterForm()

    query = Expense.query.filter_by(user_id=current_user.id)

    category = request.args.get("category")
    if category:
        query = query.filter_by(category=category)
    # Add date range filter
    start_date_str = request.args.get("start_date")
    end_date_str = request.args.get("end_date")

    if start_date_str:
        try:
            start_date = datetime.strptime(start_date_str, "%Y-%m-%d")
            query = query.filter(Expense.date >= start_date)
        except ValueError:
            flash("NgÃ y báº¯t Ä‘áº§u khÃ´ng há»£p lá»‡.", "error")
            # Optionally redirect or handle the error

    if end_date_str:
        try:
            end_date = datetime.strptime(end_date_str, "%Y-%m-%d")
            # Include the entire end_date by adding one day
            query = query.filter(Expense.date < end_date + timedelta(days=1))
        except ValueError:
            flash("NgÃ y káº¿t thÃºc khÃ´ng há»£p lá»‡.", "error")

    pagination = query.order_by(Expense.date.desc()).paginate(
        page=page, per_page=10, error_out=False
    )

    return render_template(
        "main/expenses.html",
        title="Lá»‹ch sá»­ chi tiÃªu",
        expenses=pagination.items,
        pagination=pagination,
        filter_form=filter_form,
        kwargs=(
            {
                "category": category,
                "start_date": start_date_str,
                "end_date": end_date_str,
            }
            if category or start_date_str or end_date_str
            else {}
        ),
        format_currency=format_currency,
    )


@bp.route("/process_receipt", methods=["POST"])
@login_required
def process_receipt():
    if "receipt" not in request.files:
        return jsonify({"error": "KhÃ´ng tÃ¬m tháº¥y áº£nh"}), 400

    file = request.files["receipt"]
    if not file.filename.endswith((".jpg", ".jpeg", ".png")):
        return jsonify({"error": "Chá»‰ há»— trá»£ file áº£nh (.jpg, .png)"}), 400

    try:
        result = receipt_ocr.process_image(file.read())
        # Check for OCR failures
        if result.get("error"):
            return jsonify({"success": False, "error": result["error"]}), 400

        return jsonify(
            {
                "success": True,
                "amount": result.get("amount"),
                "date": result.get("date").isoformat() if result.get("date") else None,
                "text": result.get("text"),
            }
        )
    except Exception as e:
        logger.exception(f"Error processing receipt: {e}")  # Log the full traceback
        return jsonify({"error": str(e)}), 500


@bp.route("/edit_expense/<int:id>", methods=["GET", "POST"])
@login_required
def edit_expense(id):
    expense = Expense.query.get_or_404(id)
    if expense.user_id != current_user.id:
        flash("KhÃ´ng cÃ³ quyá»n chá»‰nh sá»­a khoáº£n chi tiÃªu nÃ y!")
        return redirect(url_for("main.expenses"))

    form = ExpenseEditForm(obj=expense)
    if form.validate_on_submit():
        old_amount = expense.amount
        old_is_expense = expense.is_expense

        expense.amount = form.amount.data
        expense.category = form.category.data
        expense.description = form.description.data
        expense.is_expense = form.is_expense.data

        wallet = expense.wallet
        # Correctly update the wallet balance
        if old_is_expense:
            wallet.balance += old_amount
        else:
            wallet.balance -= old_amount

        if expense.is_expense:
            wallet.balance -= expense.amount
        else:
            wallet.balance += expense.amount
        try:
            db.session.commit()
            flash("Cáº­p nháº­t giao dá»‹ch thÃ nh cÃ´ng!")
            return redirect(url_for("main.expenses"))
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Error updating expense: {e}")
            flash("Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi cáº­p nháº­t chi tiÃªu.", "error")
            return redirect(
                url_for("main.edit_expense", id=id)
            )  # Redirect back with form data

    return render_template(
        "main/edit_expense.html",
        form=form,
        expense=expense,
        category_icons=CATEGORY_ICONS,
    )


@bp.route("/budgets", methods=["GET", "POST"])
@login_required
def budgets():
    form = BudgetForm()
    if form.validate_on_submit():
        existing_budget = Budget.query.filter_by(
            user_id=current_user.id,
            category=form.category.data,
            month=form.month.data,
            year=form.year.data,
        ).first()

        if existing_budget:
            existing_budget.amount = form.amount.data
            flash("NgÃ¢n sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!")
        else:
            budget = Budget(
                category=form.category.data,
                amount=form.amount.data,
                month=form.month.data,
                year=form.year.data,
                user_id=current_user.id,
            )
            db.session.add(budget)
            flash("NgÃ¢n sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p!")

        try:
            db.session.commit()
            return redirect(url_for("main.budgets"))
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Error creating/updating budget: {e}")
            flash("Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi cáº­p nháº­t ngÃ¢n sÃ¡ch.", "error")
            return redirect(url_for("main.budgets"))  # Stay on the same page

    current_budgets = (
        Budget.query.filter_by(user_id=current_user.id)
        .order_by(Budget.year.desc(), Budget.month.desc())
        .all()
    )

    return render_template(
        "main/budgets.html",
        form=form,
        budgets=current_budgets,
        title="Quáº£n lÃ½ ngÃ¢n sÃ¡ch",
    )


@bp.route("/export_expenses")
@login_required
def export_expenses():
    expenses = (
        Expense.query.filter_by(user_id=current_user.id)
        .order_by(Expense.date.desc())
        .all()
    )
    output = export_expenses_to_excel(expenses)
    return send_file(
        output,
        download_name=f'chi-tieu-{datetime.now().strftime("%Y%m%d")}.xlsx',
        as_attachment=True,
        mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )


@bp.route("/chat")
@login_required
def chat():
    if not current_user.is_authenticated:
        return redirect(url_for("auth.login"))

    session = (
        ChatSession.query.filter_by(user_id=current_user.id)
        .order_by(ChatSession.updated_at.desc())
        .first()
    )

    if not session:
        session = ChatSession(user_id=current_user.id)
        db.session.add(session)
        db.session.commit()

    all_sessions = (
        ChatSession.query.filter_by(user_id=current_user.id)
        .order_by(ChatSession.updated_at.desc())
        .all()
    )

    messages = (
        ChatMessage.query.filter_by(session_id=session.id)
        .order_by(ChatMessage.created_at.asc())
        .all()
    )

    # calculate total_month *within* the chat view function.
    start_date, end_date = get_date_range("month")
    expenses = Expense.query.filter_by(user_id=current_user.id).all()
    total_month = sum(e.amount for e in expenses if start_date <= e.date <= end_date)

    return render_template(
        "main/chat.html",
        title="TrÃ² chuyá»‡n vá»›i AI",
        session=session,
        messages=messages,
        all_sessions=all_sessions,
        total_month=total_month,
    )


@socketio.on("connect", namespace="/chat")
def handle_connect():
    logger.debug(f"Client connected: {request.sid}")
    join_room(str(current_user.id))


@socketio.on("disconnect", namespace="/chat")
def handle_disconnect():
    logger.debug(f"Client disconnected: {request.sid}")
    leave_room(str(current_user.id))


@socketio.on("message", namespace="/chat")
def handle_message(data):
    logger.debug(f"Received message: {data} from {request.sid}")

    if not current_user.is_authenticated:
        emit("error", {"data": "Unauthorized"}, room=request.sid)
        return

    message = data.get("message", "")
    if not message.strip():
        return
    message = message.replace("<", "<").replace(">", ">")  # Basic XSS prevention

    try:
        session = (
            ChatSession.query.filter_by(user_id=current_user.id)
            .order_by(ChatSession.updated_at.desc())
            .first()
        )

        if not session:
            session = ChatSession(
                user_id=current_user.id, personality=data.get("personality", "friendly")
            )
            db.session.add(session)
        else:
            session.personality = data.get("personality", session.personality)

        user_msg = ChatMessage(session_id=session.id, is_user=True, content=message)
        db.session.add(user_msg)
        db.session.commit()

        emit("message", {"data": message, "user": True}, room=str(current_user.id))

        try:
            response_chunks = current_app.ai_chat.get_response_stream(
                message, session.personality, str(session.id)
            )
            full_response = ""  # Accumulate the full response here
            for chunk in response_chunks:
                full_response += chunk
                # Build up the full response.
            # After yielding all chunks, send to client
            socketio.emit(
                "response",
                {"data": full_response, "user": False, "done": True},
                room=str(current_user.id),
                namespace="/chat",
            )
        except Exception as e:
            logger.exception(f"Error handling message: {e}")  # Log the full traceback.
            emit("error", {"data": "ÄÃ£ xáº£y ra lá»—i."}, room=str(current_user.id))
    finally:
        current_app.ai_chat.cleanup()


@bp.route("/api/chat/sessions", methods=["POST"])
@login_required
def manage_chat_sessions():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid request: No JSON data provided."}), 400

    action = data.get("action")
    if not action:
        return jsonify({"error": "Invalid request: 'action' field required."}), 400

    if action == "new":
        session = ChatSession(
            user_id=current_user.id, personality=data.get("personality", "friendly")
        )
        db.session.add(session)
        try:
            db.session.commit()
            return jsonify({"session_id": session.id})
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Database error creating chat session: {e}")
            return jsonify({"error": "Database error creating session"}), 500

    elif action == "delete":
        session_id = data.get("session_id")
        if not session_id:
            return jsonify({"error": "Missing session_id"}), 400
        session = ChatSession.query.get(session_id)
        if not session:
            return jsonify({"error": "Session not found"}), 404  # More specific error
        if session.user_id != current_user.id:
            return jsonify({"error": "Unauthorized"}), 403
        try:
            ChatMessage.query.filter_by(session_id=session.id).delete()
            db.session.delete(session)
            db.session.commit()
            return jsonify({"success": True})
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(
                f"Database error deleting chat session: {e}"
            )  # Log the exception
            return jsonify({"error": "Database error deleting session."}), 500

    # Update session.  (Used for switching personalities)
    elif action == "update":
        session_id = data.get("session_id")
        if not session_id:
            return jsonify({"error": "Missing session_id"}), 400
        session = ChatSession.query.get(session_id)

        if not session:
            return jsonify({"error": "Session not found"}), 404
        if session.user_id != current_user.id:
            return jsonify({"error": "Unauthorized"}), 403

        if "personality" in data:
            session.personality = data["personality"]
        try:
            db.session.commit()
            return jsonify({"success": True})
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Database error updating chat session: {e}")
            return jsonify({"error": "Database error updating session"}), 500

    return jsonify({"error": "Invalid action"}), 400


@bp.route("/api/chat/sessions/<int:session_id>/messages", methods=["GET"])
@login_required
def get_chat_messages(session_id):
    session = ChatSession.query.get_or_404(session_id)
    if session.user_id != current_user.id:
        return jsonify({"error": "Unauthorized"}), 403

    messages = (
        ChatMessage.query.filter_by(session_id=session.id)
        .order_by(ChatMessage.created_at.asc())
        .all()
    )
    message_data = [
        {
            "content": msg.content,
            "user": msg.is_user,
            "timestamp": msg.created_at.isoformat(),
        }
        for msg in messages
    ]
    return jsonify({"messages": message_data})


@bp.route("/ai/get_analysis_data", methods=["POST"])
@login_required
def get_analysis_data():
    start_date, end_date = get_date_range("month")
    expenses = Expense.query.filter_by(user_id=current_user.id).all()
    expense_data = [
        {
            "amount": e.amount,
            "category": e.category,
            "date": e.date.isoformat(),
            "description": e.description,
        }
        for e in expenses
        if start_date <= e.date <= end_date
    ]
    analysis_data = current_app.expense_analyzer.get_analysis_data(expense_data)
    return jsonify(analysis_data)


@bp.route("/ai/get_recommendations", methods=["POST"])
@login_required
def get_recommendations():
    start_date, end_date = get_date_range("month")
    expenses = Expense.query.filter_by(user_id=current_user.id).all()
    expense_data = [
        {
            "amount": e.amount,
            "category": e.category,
            "date": e.date.isoformat(),
            "description": e.description,
        }
        for e in expenses
        if start_date <= e.date <= end_date
    ]
    recommendations = current_app.expense_analyzer.get_recommendations(expense_data)
    return jsonify({"recommendations": recommendations})


@bp.route("/export_data")
@login_required
def export_data():
    expenses = Expense.query.filter_by(user_id=current_user.id).all()

    data = []
    for expense in expenses:
        data.append(
            {
                "NgÃ y": expense.date,
                "Danh má»¥c": expense.category,
                "MÃ´ táº£": expense.description,
                "Sá»‘ tiá»n": expense.amount,
            }
        )

    df = pd.DataFrame(data)
    output = BytesIO()

    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        df.to_excel(writer, sheet_name="Chi tiÃªu", index=False)
        workbook = writer.book
        worksheet = writer.sheets["Chi tiÃªu"]

        money_fmt = workbook.add_format({"num_format": "#,##0 â‚«"})
        date_fmt = workbook.add_format({"num_format": "dd/mm/yyyy hh:mm"})
        worksheet.set_column("A:A", 18, date_fmt)
        worksheet.set_column("D:D", 15, money_fmt)

    output.seek(0)
    return send_file(
        output,
        download_name=f'chi-tieu-{datetime.now().strftime("%Y%m%d")}.xlsx',
        as_attachment=True,
        mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )


@bp.route("/import_data", methods=["POST"])
@login_required
def import_data():
    if "file" not in request.files:
        return jsonify({"error": "KhÃ´ng tÃ¬m tháº¥y file"}), 400

    file = request.files["file"]
    if not file.filename.endswith(".xlsx"):
        return jsonify({"error": "Chá»‰ há»— trá»£ file Excel (.xlsx)"}), 400

    try:
        df = pd.read_excel(file)
        for _, row in df.iterrows():
            expense = Expense(
                date=row["NgÃ y"],
                category=row["Danh má»¥c"],
                description=row["MÃ´ táº£"],
                amount=row["Sá»‘ tiá»n"],
                user_id=current_user.id,
            )
            db.session.add(expense)
        db.session.commit()
        return jsonify({"success": "Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c nháº­p thÃ nh cÃ´ng"})
    except Exception as e:
        db.session.rollback()
        logger.exception(f"Error importing data: {e}")  # Log full traceback
        return jsonify({"error": str(e)}), 400


@bp.route("/ai/analyze_patterns", methods=["POST"])
@login_required
def analyze_patterns():

    if not request.is_json:
        return jsonify({"error": "Request must be JSON"}), 400

    try:
        expenses = (
            Expense.query.filter_by(user_id=current_user.id)
            .order_by(Expense.date.desc())
            .limit(30)
            .all()
        )

        if not expenses:
            return jsonify(
                {
                    "analysis": {
                        "pattern": "insufficient_data",
                        "message": "ChÆ°a cÃ³ dá»¯ liá»‡u chi tiÃªu Ä‘á»ƒ phÃ¢n tÃ­ch",
                    },
                    "recommendations": ["HÃ£y báº¯t Ä‘áº§u ghi láº¡i chi tiÃªu cá»§a báº¡n"],
                }
            )

        expense_data = [
            {
                "amount": e.amount,
                "category": e.category,
                "date": e.date.isoformat(),
                "description": e.description,
            }
            for e in expenses
        ]

        analysis = current_app.expense_analyzer.analyze_patterns(expense_data)
        recommendations = current_app.expense_analyzer.get_recommendations(analysis)

        return jsonify({"analysis": analysis, "recommendations": recommendations})
    except Exception as e:
        logger.exception("Error during AI analysis")
        return (
            jsonify({"error": "KhÃ´ng thá»ƒ phÃ¢n tÃ­ch chi tiÃªu", "message": str(e)}),
            500,
        )


@bp.route("/ai/suggest_category", methods=["POST"])
@login_required
def suggest_category():
    if not request.is_json:
        return jsonify({"error": "Request must be JSON"}), 400

    description = request.json.get("description", "")
    if not description:
        return (
            jsonify({"error": "Description is required"}),
            400,
        )  # Check for empty description
    category = current_app.expense_categorizer.predict_category(description)
    return jsonify({"category": category})


@bp.route("/notifications")
@login_required
def notifications():
    page = request.args.get("page", 1, type=int)
    notifications = (
        Notification.query.filter_by(user_id=current_user.id)
        .order_by(Notification.created_at.desc())
        .paginate(page=page, per_page=10, error_out=False)
    )
    return render_template("main/notifications.html", notifications=notifications)


@bp.route("/notifications/mark_read/<int:id>", methods=["POST"])
@login_required
def mark_notification_read(id):
    try:
        NotificationManager.mark_as_read(id, current_user.id)
        return jsonify({"success": True})
    except Exception as e:
        logger.exception(
            f"Error marking notification as read: {e}"
        )  # Log with traceback
        return jsonify({"success": False, "message": "Failed to mark as read."}), 500


@bp.route("/check_budget_alerts")
@login_required
def check_budget_alerts():
    alerts = NotificationManager.check_budget_alerts(current_user.id)
    return jsonify({"alerts": alerts})


@bp.route("/settings", methods=["GET", "POST"])
@login_required
def settings():
    from app.main.forms import ChangePasswordForm

    form_password = ChangePasswordForm()

    if form_password.validate_on_submit():
        if current_user.check_password(form_password.current_password.data):
            current_user.set_password(form_password.new_password.data)
            db.session.commit()
            flash("Máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i thÃ nh cÃ´ng!", "success")
            return redirect(url_for("main.settings"))
        flash("Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng!", "error")

    return render_template(
        "main/settings.html", title="CÃ i Ä‘áº·t", form_password=form_password
    )


@bp.route("/install-ios")
@login_required
def install_ios_app():
    icon_path = Path(current_app.root_path) / "static" / "img" / "app-icon.png"
    with open(icon_path, "rb") as f:
        icon_data = base64.b64encode(f.read()).decode()

    profile_uuid = str(uuid.uuid4())
    payload_uuid = str(uuid.uuid4())

    app_url = request.host_url.rstrip("/")
    if app_url.startswith("http://"):
        app_url = "https://" + app_url[7:]

    profile_path = (
        Path(current_app.root_path) / "static" / "profiles" / "webclip.mobileconfig"
    )
    with open(profile_path) as f:
        profile_content = f.read()

    profile_content = profile_content.replace("{{ icon_data }}", icon_data)
    profile_content = profile_content.replace("{{ user_id }}", str(current_user.id))
    profile_content = profile_content.replace("{{ uuid }}", payload_uuid)
    profile_content = profile_content.replace("{{ profile_uuid }}", profile_uuid)
    profile_content = profile_content.replace("{{ app_url }}", app_url)
    response = current_app.make_response(profile_content)
    response.headers["Content-Type"] = "application/x-apple-aspen-config"
    response.headers["Content-Disposition"] = (
        "attachment; filename=moneykeeper.mobileconfig"
    )

    return response


@bp.route("/wallets")
@login_required
def wallets():
    wallets = current_user.wallets.all()
    form = WalletForm()
    return render_template(
        "main/wallets.html", wallets=wallets, form=form, title="Quáº£n lÃ½ vÃ­"
    )


@bp.route("/wallet/add", methods=["POST"])
@login_required
def add_wallet():
    form = WalletForm()
    if form.validate_on_submit():
        if form.is_default.data:
            current_user.wallets.filter_by(is_default=True).update(
                {"is_default": False}
            )
        try:
            wallet = Wallet(
                name=form.name.data,
                balance=form.balance.data,
                description=form.description.data,
                is_default=form.is_default.data,
                user_id=current_user.id,
            )
            db.session.add(wallet)
            db.session.commit()
            flash("ÄÃ£ thÃªm vÃ­ má»›i thÃ nh cÃ´ng!")
            return redirect(url_for("main.wallets"))
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Database error adding wallet: {e}")
            flash(
                "Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi thÃªm vÃ­.", "error"
            )  # More specific error message
            return render_template(
                "main/wallets.html", form=form, title="Quáº£n LÃ½ VÃ­"
            )  # Stay on the same page

    return render_template("main/wallets.html", form=form, title="Quáº£n LÃ½ VÃ­")


@bp.route("/wallet/<int:id>/edit", methods=["GET", "POST"])
@login_required
def edit_wallet(id):
    wallet = Wallet.query.get_or_404(id)
    if wallet.user_id != current_user.id:
        flash("KhÃ´ng cÃ³ quyá»n chá»‰nh sá»­a vÃ­ nÃ y!")
        return redirect(url_for("main.wallets"))

    form = WalletForm(obj=wallet)
    if form.validate_on_submit():
        if form.is_default.data and not wallet.is_default:
            current_user.wallets.filter_by(is_default=True).update(
                {"is_default": False}
            )

        wallet.name = form.name.data
        wallet.balance = form.balance.data
        wallet.description = form.description.data
        wallet.is_default = form.is_default.data
        try:
            db.session.commit()
            flash("ÄÃ£ cáº­p nháº­t vÃ­ thÃ nh cÃ´ng!")
            return redirect(url_for("main.wallets"))
        except SQLAlchemyError as e:
            db.session.rollback()
            logger.exception(f"Error updating wallet: {e}")  # Log the traceback
            flash("Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi cáº­p nháº­t vÃ­.", "error")
            return render_template(
                "main/edit_wallet.html", wallet=wallet, form=form, title="Chá»‰nh sá»­a vÃ­"
            )  # Stay on the edit page

    return render_template(
        "main/edit_wallet.html", wallet=wallet, form=form, title="Chá»‰nh sá»­a vÃ­"
    )


@bp.route("/wallet/<int:id>/delete", methods=["POST"])
@login_required
def delete_wallet(id):
    wallet = Wallet.query.get_or_404(id)
    if wallet.user_id != current_user.id:
        flash("KhÃ´ng cÃ³ quyá»n xÃ³a vÃ­ nÃ y!")
        return jsonify({"success": False, "message": "KhÃ´ng cÃ³ quyá»n xÃ³a vÃ­ nÃ y!"}), 403

    if wallet.is_default:
        flash("KhÃ´ng thá»ƒ xÃ³a vÃ­ máº·c Ä‘á»‹nh!")
        return (
            jsonify({"success": False, "message": "KhÃ´ng thá»ƒ xÃ³a vÃ­ máº·c Ä‘á»‹nh!"}),
            400,
        )

    if wallet.expenses.count() > 0:
        flash("KhÃ´ng thá»ƒ xÃ³a vÃ­ Ä‘Ã£ cÃ³ giao dá»‹ch!")
        return (
            jsonify({"success": False, "message": "KhÃ´ng thá»ƒ xÃ³a vÃ­ Ä‘Ã£ cÃ³ giao dá»‹ch!"}),
            400,
        )

    try:
        db.session.delete(wallet)
        db.session.commit()
        flash("ÄÃ£ xÃ³a vÃ­ thÃ nh cÃ´ng!")
        return jsonify({"success": True, "message": "ÄÃ£ xÃ³a vÃ­ thÃ nh cÃ´ng!"})
    except SQLAlchemyError as e:
        db.session.rollback()
        logger.exception(f"Error deleting wallet: {e}")  # Log the full traceback
        return (
            jsonify({"success": False, "message": "Lá»—i cÆ¡ sá»Ÿ dá»¯ liá»‡u khi xÃ³a vÃ­."}),
            500,
        )

================
File: app/models.py
================
from app import db, login_manager
from flask_login import UserMixin
from datetime import datetime

from werkzeug.security import (
    generate_password_hash,
    check_password_hash,
)


@login_manager.user_loader
def load_user(id):
    return User.query.get(int(id))


class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), index=True, unique=True)
    password_hash = db.Column(db.String(128))
    email = db.Column(db.String(120), unique=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_permanently_logged_in = db.Column(
        db.Boolean, default=False
    )  # Not currently used, consider removing
    budgets = db.relationship("Budget", back_populates="user")
    wallets = db.relationship("Wallet", backref="user", lazy="dynamic")
    chat_sessions = db.relationship("ChatSession", backref="user", lazy="dynamic")

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

    def set_permanent_login(self, status):  # Consider removing if not used
        self.is_permanently_logged_in = status
        db.session.commit()

    def get_default_wallet(self):
        default_wallet = self.wallets.filter_by(is_default=True).first()
        if not default_wallet:
            # If no wallets, create a default one
            default_wallet = Wallet(
                name="VÃ­ chÃ­nh", balance=0, is_default=True, user_id=self.id
            )
            db.session.add(default_wallet)
            db.session.commit()
        return default_wallet


class Expense(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    amount = db.Column(db.Float, nullable=False)
    category = db.Column(db.String(50), nullable=False)
    description = db.Column(db.String(200))
    date = db.Column(db.DateTime, default=datetime.utcnow)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    wallet_id = db.Column(db.Integer, db.ForeignKey("wallet.id"), nullable=False)
    is_expense = db.Column(
        db.Boolean, default=True
    )  # True for expense, False for income


class Budget(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    category = db.Column(db.String(50), nullable=False)
    amount = db.Column(db.Float, nullable=False)
    month = db.Column(db.Integer, nullable=False)
    year = db.Column(db.Integer, nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    user = db.relationship("User", back_populates="budgets")


class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    type = db.Column(
        db.String(50), nullable=False
    )  # e.g., 'budget_alert', 'unusual_spending'
    message = db.Column(db.String(500), nullable=False)
    is_read = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)


class ChatSession(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    personality = db.Column(db.String(50), default="friendly")  # Default personality
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(
        db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow
    )


class ChatMessage(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    session_id = db.Column(db.Integer, db.ForeignKey("chat_session.id"), nullable=False)
    is_user = db.Column(db.Boolean, default=True)  # True if user, False if AI
    content = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)


class Wallet(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), nullable=False)
    balance = db.Column(db.Float, default=0.0)
    currency = db.Column(
        db.String(3), default="VND"
    )  # Currency support (limited in this example)
    description = db.Column(db.String(200))
    is_default = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    expenses = db.relationship("Expense", backref="wallet", lazy="dynamic")

    def update_balance(self, amount, is_expense=True):
        """Updates the wallet balance based on expense/income."""
        if is_expense:
            self.balance -= amount
        else:
            self.balance += amount
        db.session.commit()

================
File: app/settings/__init__.py
================
from flask import Blueprint

bp = Blueprint("settings", __name__, url_prefix="/settings")

from app.settings import routes

================
File: app/settings/forms.py
================
from flask_wtf import FlaskForm
from wtforms import PasswordField, SubmitField
from wtforms.validators import DataRequired, EqualTo, Length


class ChangePasswordForm(FlaskForm):
    current_password = PasswordField("Máº­t kháº©u hiá»‡n táº¡i", validators=[DataRequired()])
    new_password = PasswordField(
        "Máº­t kháº©u má»›i",
        validators=[
            DataRequired(),
            Length(min=6, message="Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±"),
        ],
    )
    confirm_new_password = PasswordField(
        "XÃ¡c nháº­n máº­t kháº©u má»›i",
        validators=[
            DataRequired(),
            EqualTo("new_password", message="Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p"),
        ],
    )
    submit = SubmitField("Äá»•i máº­t kháº©u")

================
File: app/settings/routes.py
================
from flask import render_template, redirect, url_for, flash, request
from flask_login import login_required, current_user
from app import db
from app.settings import bp
from app.settings.forms import ChangePasswordForm


@bp.route("/account", methods=["GET", "POST"])
@login_required
def settings():
    form_password = ChangePasswordForm()

    if form_password.validate_on_submit():
        if current_user.check_password(form_password.current_password.data):
            current_user.set_password(form_password.new_password.data)
            db.session.commit()
            flash("Máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i thÃ nh cÃ´ng!", "success")
            return redirect(url_for("settings.settings"))
        else:
            flash("Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng.", "error")

    return render_template(
        "settings/account.html", title="CÃ i Ä‘áº·t tÃ i khoáº£n", form_password=form_password
    )


@bp.route("/change_password", methods=["POST"])
@login_required
def change_password():
    form_password = ChangePasswordForm()
    if form_password.validate_on_submit():
        if current_user.check_password(form_password.current_password.data):
            current_user.set_password(form_password.new_password.data)
            db.session.commit()
            flash("Máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c thay Ä‘á»•i thÃ nh cÃ´ng!", "success")
        else:
            flash("Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng.", "error")
    return redirect(url_for("settings.settings"))

================
File: app/static/css/styles.css
================
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
}

body {
  font-family: "Inter", system-ui, -apple-system, sans-serif;
}

body {
  line-height: 1.5;
  color: #333;
}

h1,
.h1 {
  @apply text-3xl font-bold;
}

h2,
.h2 {
  @apply text-2xl font-semibold;
}

h3,
.h3 {
  @apply text-lg font-medium;
}

.form-label {
  @apply block text-sm font-medium text-gray-700 mb-1;
}

.form-input,
.form-textarea,
.form-select {
  @apply mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2 px-3;
  @apply focus:ring-opacity-50;
}

.form-input,
.form-textarea {
  @apply text-base;
}

.form-select {
  @apply pr-8;
}

.form-textarea {
  @apply resize-vertical;
}

.form-checkbox {
  @apply rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50;
}

.form-input.error,
.form-textarea.error,
.form-select.error {
  @apply border-red-500 focus:border-red-500 focus:ring-red-500;
}

.error-message {
  @apply text-red-600 text-sm mt-1;
}

.btn {
  @apply inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium transition-colors;
}

.btn-primary {
  @apply text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
}

.btn-secondary {
  @apply text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500;
}

.btn-delete {
  @apply text-red-600 hover:text-red-700 transition-colors;
}

.table {
  @apply w-full;
  border-collapse: collapse;
}

.table-header {
  @apply bg-gray-50 border-b border-gray-200;
}

.table-header th {
  @apply px-4 py-2 text-left text-sm font-medium text-gray-600;
  text-transform: none;
}

.table-row {
  @apply hover:bg-gray-50 transition-colors;
}

.table-cell {
  @apply px-4 py-2 text-sm text-gray-600;
}

.table-cell-right {
  @apply text-right;
}

.category-btn {
  @apply flex flex-col items-center p-4 rounded-lg border hover:bg-blue-50;
  transition: background-color 0.2s ease;
}

.category-btn.active {
  @apply bg-blue-100 border-blue-500 text-blue-800;
}

.category-btn span:first-child {
  @apply text-xl mb-2;
}

.category-btn span:last-child {
  @apply text-xs;
}

.amount-btn {
  @apply py-2 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center;
}

.amount-btn.active {
  @apply bg-green-100 text-green-800;
}

.expense-toggle.active,
.income-toggle.active {
  @apply bg-blue-100 text-blue-800;
}

#mobile-menu {
  transition: transform 0.3s ease-in-out;
}

#mobile-menu.hidden {
  transform: translateX(100%);
}

.message-user {
  @apply bg-blue-600 text-white;
}

.message-ai {
  @apply bg-white;
}

.message-bubble {
  @apply rounded-2xl px-4 py-2 max-w-[85%] md:max-w-[70%] shadow-sm;
}

.wallet-item {
  @apply bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow;
}

.card {
  @apply bg-white p-6 md:p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-200;
}

.animate__animated {
  animation-duration: 1s;
}

.loading-fade-enter-active,
.loading-fade-leave-active {
  transition: opacity 0.3s ease;
}

.loading-fade-enter-from,
.loading-fade-leave-to {
  opacity: 0;
}

================
File: app/static/js/app.js
================
// app/static/js/app.js
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}

function formatDate(date) {
    return new Intl.DateTimeFormat('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(new Date(date));
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, duration);
}

// Improved form validation with clearer error messages
function validateForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('border-red-500'); // Add error class
            // Add error message, if not already present
            if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('error-message')) {
                const errorSpan = document.createElement('span');
                errorSpan.className = 'error-message text-red-600 text-sm mt-1';
                errorSpan.textContent = 'TrÆ°á»ng nÃ y lÃ  báº¯t buá»™c.';
                field.parentNode.insertBefore(errorSpan, field.nextSibling); // Insert after the field
            }
            isValid = false;
        } else {
            field.classList.remove('border-red-500');
            // Remove error message
            if (field.nextElementSibling && field.nextElementSibling.classList.contains('error-message')) {
                field.nextElementSibling.remove();
            }
        }
    });

    return isValid;
}


function initLazyLoading() {
    if ('loading' in HTMLImageElement.prototype) {
        document.querySelectorAll('img[data-src]').forEach(img => {
            img.src = img.dataset.src;
        });
    } else {
        const lazyImages = document.querySelectorAll('img[data-src]');
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        });

        lazyImages.forEach(img => imageObserver.observe(img));
    }
}
class ResourceLoader {
    static async preloadResources() {
        // Only preload existing resources

    }
    static loadDeferredImages() {
        const images = document.querySelectorAll('img[data-src]');
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    imageObserver.unobserve(img);
                }
            });
        });

        images.forEach(img => imageObserver.observe(img));
    }
}
function initPerformanceMonitoring() {
    if ('PerformanceObserver' in window) {
        const observer = new PerformanceObserver((list) => {
            list.getEntries().forEach((entry) => {
                if (entry.loadTime > 3000) { // NgÆ°á»¡ng 3 giÃ¢y
                    console.warn('Slow resource load:', entry.name);
                }
            });
        });
        observer.observe({ entryTypes: ['resource'] });
    }
}

let analysisRequest = null;
async function fetchAndUpdateAnalysis() {
    // Check if the necessary elements exist before proceeding.
    if (!document.getElementById('dailyAverage')) {
        console.warn("Analysis elements not found.  Skipping fetchAndUpdateAnalysis.");
        return; // Exit the function if the elements aren't present.
    }

    // --- Fetch Core Analysis Data ---
    try {
        const response = await fetch('/ai/get_analysis_data', { method: 'POST' });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        document.getElementById('dailyAverage').textContent = data.daily_average ? formatCurrency(data.daily_average) : "KhÃ´ng cÃ³ dá»¯ liá»‡u";

        let mostExpensiveCategoryHTML = "KhÃ´ng cÃ³ dá»¯ liá»‡u";
        if (data.common_categories && data.common_categories.length > 0) {
            mostExpensiveCategoryHTML = `${data.common_categories[0][0]} <span class="text-base">(${formatCurrency(data.common_categories[0][1])})</span>`;
        }
        document.getElementById('mostExpensiveCategory').innerHTML = mostExpensiveCategoryHTML;

        let highestExpenseHTML = "KhÃ´ng cÃ³ dá»¯ liá»‡u";
        if (data.highest_expense && data.highest_expense.amount > 0) {
            highestExpenseHTML = `${formatCurrency(data.highest_expense.amount)}`;
        }
        document.getElementById('highestExpense').innerHTML = highestExpenseHTML;

    } catch (error) {
        console.error('Error fetching analysis data:', error);
        document.getElementById('dailyAverage').textContent = "Lá»—i";
        document.getElementById('mostExpensiveCategory').textContent = "Lá»—i";
        document.getElementById('highestExpense').textContent = "Lá»—i";
    }

    // --- Fetch Recommendations (with a delay) ---
    setTimeout(() => {
        fetch('/ai/get_recommendations', { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsList.innerHTML = ''; // Clear previous recommendations or loading message

                if (data.recommendations && data.recommendations.length > 0) {
                    data.recommendations.forEach(rec => {
                        const listItem = document.createElement('li');
                        listItem.className = "flex items-start text-sm";
                        listItem.innerHTML = `<span class="text-blue-500 mr-2 flex-shrink-0">â€¢</span>
                                          <span class="text-gray-600">${rec}</span>`;
                        recommendationsList.appendChild(listItem);
                    });
                } else {
                    const listItem = document.createElement('li');
                    listItem.className = "flex items-start text-sm";
                    listItem.innerHTML = `<span class="text-blue-500 mr-2 flex-shrink-0">â€¢</span>
                                        <span class="text-gray-600">Hiá»‡n táº¡i chÆ°a cÃ³ khuyáº¿n nghá»‹ nÃ o.</span>`;
                    recommendationsList.appendChild(listItem);
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                document.getElementById('recommendationsList').innerHTML = '<li class="text-red-500">ÄÃ£ xáº£y ra lá»—i khi táº£i khuyáº¿n nghá»‹.</li>';
            });
    }, 500);
}

document.addEventListener('DOMContentLoaded', () => {
    initLazyLoading();
    initPerformanceMonitoring();
    ResourceLoader.preloadResources();
    ResourceLoader.loadDeferredImages();
    document.documentElement.classList.remove('js-loading');

    window.moneykeeper = {
        showToast,
        initLazyLoading,
        fetchAndUpdateAnalysis
    };

    // Only call fetchAndUpdateAnalysis if on the index page
    if (window.location.pathname === '/index' || window.location.pathname === '/') {
        fetchAndUpdateAnalysis();
    }


    function setAmount(amount) {
        document.getElementById("amount").value = formatMoney(amount.toString());
        document.querySelectorAll(".amount-btn").forEach((btn) => {
            btn.classList.remove("bg-green-100", "text-green-800");
        });
        // Use closest to find the button even if the click is on a child element
        event.target.closest('.amount-btn').classList.add("bg-green-100", "text-green-800");
    }


    function updateCategoryIcon(category) {
        const icons = {
            food: "ðŸœ",
            transport: "ðŸš—",
            shopping: "ðŸ›ï¸",
            entertainment: "ðŸŽ®",
            utilities: "ðŸ“±",
            health: "ðŸ¥",
            education: "ðŸ“š",
            investment: "ðŸ’°",
            other: "ðŸ“",
        };
        document.getElementById("categoryIcon").textContent =
            icons[category] || "ðŸ“";
    }

    function setCategory(category) {
        document.getElementById("category").value = category;
        // Remove active classes from all category buttons.  More robust way.
        document.querySelectorAll(".category-btn").forEach(btn => {
            btn.classList.remove("bg-blue-100", "border-blue-500", "text-blue-800");
        });

        // Find *exactly* the button that corresponds to this category and activate it.
        document.querySelectorAll(`.category-btn[data-category='${category}']`).forEach(btn => {
            btn.classList.add("bg-blue-100", "border-blue-500", "text-blue-800");
        });

        updateCategoryIcon(category);
    }


    // Add data-category attributes to category buttons
    // Select category buttons only if they exist
    const categoryButtons = document.querySelectorAll('.category-btn');
    if (categoryButtons.length > 0) {
        categoryButtons.forEach(button => {
            const categoryValue = button.querySelector('span:last-child').textContent.trim(); // Get text content
            const categoryKey = Object.entries(CATEGORY_ICONS).find(([key, value]) => value === categoryValue || key === categoryValue)[0];

            button.setAttribute('data-category', categoryKey);

            button.addEventListener('click', function () {
                setCategory(this.dataset.category);
            });
        });
    }


    function startVoiceInput() {
        if ("webkitSpeechRecognition" in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = "vi-VN";
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                const amountMatch = transcript.match(
                    /(\d+(\s*nghÃ¬n|\s*triá»‡u|\s*tá»·)?)/i
                );
                if (amountMatch) {
                    const amount = convertVietnameseCurrency(amountMatch[0]);
                    document.getElementById("amount").value = formatMoney(amount.toString());
                }
            };

            recognition.start();
        } else {
            alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­p giá»ng nÃ³i");
        }
    }
    function toggleTransactionType(type) {
        const isExpense = type === "expense";
        document.getElementById("is_expense").value = isExpense;

        const expenseBtn = document.querySelector(".expense-toggle");
        const incomeBtn = document.querySelector(".income-toggle");

        if (isExpense) {
            expenseBtn.classList.add("bg-green-100", "text-green-800");
            incomeBtn.classList.remove("bg-green-100", "text-green-800");
        } else {
            incomeBtn.classList.add("bg-green-100", "text-green-800");
            expenseBtn.classList.remove("bg-green-100", "text-green-800");
        }
    }
    function parseMoney(str) {
        return parseInt(str.replace(/\./g, '')) || 0;
    }
    let lastTap = 0;
    let tapTimeout;
    const tapDelay = 300;
    function handleTouchStart(event) {
        event.preventDefault();
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;

        clearTimeout(tapTimeout);

        if (tapLength < tapDelay && tapLength > 0) {
            const expenseId = event.currentTarget.dataset.expenseId;
            window.location.href = `/edit_expense/${expenseId}`;
            event.preventDefault();
        } else {
            tapTimeout = setTimeout(() => {
                console.log("Single tap detected");
            }, tapDelay);
        }

        lastTap = currentTime;
    }

    function handleTouchEnd(event) {
        if (new Date().getTime() - lastTap < tapDelay) {
            event.preventDefault();
        }
    }

    document.querySelectorAll("[data-expense-id]").forEach((row) => {
        row.addEventListener("click", (event) => {
            if (window.innerWidth >= 768) {
                const expenseId = event.currentTarget.dataset.expenseId;
                const isActionButton = event.target.closest("button, a");
                if (!isActionButton) {
                    window.location.href = `/edit_expense/${expenseId}`;
                }
            }
        });
    });
    function deleteExpense(id) {
        event.stopPropagation();
        if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khoáº£n chi tiÃªu nÃ y?")) {
            fetch(`/delete_expense/${id}`, {
                method: "POST",
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        location.reload();
                    } else {
                        // Display error message from server
                        showToast(data.message || "Lá»—i khi xÃ³a chi tiÃªu", "error");
                    }
                })
                .catch(error => { // Catch network errors
                    showToast("Lá»—i káº¿t ná»‘i.", "error");
                    console.error("Network error:", error);
                });
        }
    }
    function showAddWalletModal() {
        document.getElementById("addWalletModal").classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    function hideAddWalletModal() {
        document.getElementById("addWalletModal").classList.add("hidden");
        document.body.style.overflow = "";
    }

    document.getElementById("addWalletModal")
        .addEventListener("click", function (e) {
            if (e.target === this) {
                hideAddWalletModal();
            }
        });
    function cancelAnalysis() {
        if (analysisRequest && typeof analysisRequest.abort === 'function') {
            analysisRequest.abort();
            analysisRequest = null;
            console.log("Analysis request cancelled.");
        }
    }
    window.addEventListener('beforeunload', cancelAnalysis);
    document.addEventListener('click', function (event) {
        if (event.target.tagName === 'A' && !event.target.hasAttribute('download')) {
            cancelAnalysis();
        }
    });

    // Only add these listeners if we're on a page with amount buttons
    const amountButtons = document.querySelectorAll('.amount-btn');
    if (amountButtons.length > 0) {
        amountButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                setAmount(parseInt(this.textContent.replace(/[^0-9]/g, "")));
            });
        });
    }

    // Only add these listeners if we're on a page with category buttons
    const categoryButtons1 = document.querySelectorAll('.category-btn'); //Use other variable name.
    if (categoryButtons1.length > 0) {
        categoryButtons1.forEach(button => {
            // NO! button.addEventListener('click', setCategory);  <- Incorrect!
            button.addEventListener('click', function () {
                setCategory(this.dataset.category); // Correct. Uses data-category
            });
        });
    }

    // Handle form submissions using AJAX
    const expenseForm = document.querySelector('#expenseForm'); // Assuming your form has this ID
    if (expenseForm) {
        expenseForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            if (!validateForm(this)) { // this refers to the form
                return; // Stop if validation fails
            }


            fetch(this.action, { // Use the form's action attribute
                method: 'POST',
                body: new FormData(this) // Send form data
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // Parse JSON response
                })
                .then(data => {
                    if (data.redirect) {
                        window.location.href = data.redirect; // Redirect if server sends redirect
                    } else {
                        // Handle other responses, e.g., show a success message
                        showToast('Chi tiÃªu Ä‘Ã£ Ä‘Æ°á»£c thÃªm thÃ nh cÃ´ng!', 'success');
                        // You could also clear the form here if needed
                        this.reset(); // Reset form after successful submission
                    }
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                    showToast('Lá»—i khi thÃªm chi tiÃªu. Vui lÃ²ng thá»­ láº¡i.', 'error');
                });
        });
    }

});

================
File: app/static/manifest.json
================
{
  "name": "Money Keeper",
  "short_name": "Money Keeper",
  "description": "Quáº£n lÃ½ tÃ i chÃ­nh thÃ´ng minh",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3B82F6",
  "icons": [
    {
      "src": "/static/img/app-icon.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "orientation": "portrait"
}

================
File: app/static/profiles/webclip.mobileconfig
================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>FullScreen</key>
            <true/>
            <key>Icon</key>
            <data>{{ icon_data }}</data>
            <key>IsRemovable</key>
            <true/>
            <key>Label</key>
            <string>Money Keeper</string>
            <key>PayloadDescription</key>
            <string>CÃ i Ä‘áº·t Money Keeper vÃ o mÃ n hÃ¬nh chÃ­nh</string>
            <key>PayloadDisplayName</key>
            <string>Money Keeper</string>
            <key>PayloadIdentifier</key>
            <string>vn.moneykeeper.{{ user_id }}</string>
            <key>PayloadOrganization</key>
            <string>Money Keeper VN</string>
            <key>PayloadType</key>
            <string>com.apple.webClip.managed</string>
            <key>PayloadUUID</key>
            <string>{{ uuid }}</string>
            <key>PayloadVersion</key>
            <integer>1</integer>
            <key>Precomposed</key>
            <true/>
            <key>URL</key>
            <string>{{ app_url }}</string>
            <key>Settings</key>
            <dict>
                <key>StatusBarStyle</key>
                <string>black</string>
                <key>StartURL</key>
                <string>{{ app_url }}</string>
                <key>WebBrowserUserAgent</key>
                <string>Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1</string>
                <key>WebAllowGeolocation</key>
                <true/>
                <key>WebKitDefaultFixedFontSize</key>
                <integer>16</integer>
                <key>WebKitStoresWebData</key>
                <true/>
            </dict>
        </dict>
    </array>
    <key>PayloadDescription</key>
    <string>CÃ i Ä‘áº·t Money Keeper vÃ o mÃ n hÃ¬nh chÃ­nh</string>
    <key>PayloadDisplayName</key>
    <string>Money Keeper</string>
    <key>PayloadIdentifier</key>
    <string>vn.moneykeeper.profile.{{ user_id }}</string>
    <key>PayloadOrganization</key>
    <string>Money Keeper VN</string>
    <key>PayloadRemovalDisallowed</key>
    <false/>
    <key>PayloadType</key>
    <string>Configuration</string>
    <key>PayloadUUID</key>
    <string>{{ profile_uuid }}</string>
    <key>PayloadVersion</key>
    <integer>1</integer>
</dict>
</plist>

================
File: app/templates/auth/_register_content.html
================
{% extends "base.html" %} {% block content %}
<div
  class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100 py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full bg-white shadow-xl rounded-lg overflow-hidden">
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-8">
      <h2 class="text-center text-3xl font-bold text-white">
        Táº¡o tÃ i khoáº£n má»›i
      </h2>
      <p class="mt-2 text-center text-blue-100">
        Báº¯t Ä‘áº§u quáº£n lÃ½ tÃ i chÃ­nh cá»§a báº¡n
      </p>
    </div>

    <div class="px-6 py-8">
      <form action="" method="post" novalidate class="space-y-6">
        {{ form.hidden_tag() }}

        <div>
          {{ form.username.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
            </div>
            {{ form.username(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Chá»n tÃªn Ä‘Äƒng nháº­p") }}
          </div>
          {% for error in form.username.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.email.label(class="block text-sm font-semibold text-gray-700
          mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                />
              </svg>
            </div>
            {{ form.email(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Nháº­p email cá»§a báº¡n") }}
          </div>
          {% for error in form.email.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.password.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            {{ form.password(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Táº¡o máº­t kháº©u má»›i") }}
          </div>
          {% for error in form.password.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.password2.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            {{ form.password2(class="pl-10 appearance-none block w-full px-3
            py-3 border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Nháº­p láº¡i máº­t kháº©u") }}
          </div>
          {% for error in form.password2.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        {{ form.submit(class="w-full flex justify-center py-3 px-4 border
        border-transparent rounded-lg shadow-sm text-sm font-medium text-white
        bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2
        focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200")
        }}
      </form>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
      <p class="text-sm text-center text-gray-600">
        ÄÃ£ cÃ³ tÃ i khoáº£n?
        <a
          href="{{ url_for('auth.login') }}"
          class="font-medium text-blue-600 hover:text-blue-500 transition-colors duration-200"
        >
          ÄÄƒng nháº­p
        </a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/auth/login.html
================
{% extends "base.html" %} {% block content %}
<div
  class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100 py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full bg-white shadow-xl rounded-lg overflow-hidden">
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-8">
      <h2 class="text-center text-3xl font-bold text-white">
        ChÃ o má»«ng trá»Ÿ láº¡i!
      </h2>
      <p class="mt-2 text-center text-blue-100">
        ÄÄƒng nháº­p Ä‘á»ƒ quáº£n lÃ½ tÃ i chÃ­nh cá»§a báº¡n
      </p>
    </div>

    <div class="px-6 py-8">
      <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <div class="space-y-6">
          <div>
            {{ form.username.label(class="block text-sm font-semibold
            text-gray-700 mb-2") }}
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
              </div>
              {{ form.username(class="pl-10 appearance-none block w-full px-3
              py-3 border border-gray-300 rounded-lg placeholder-gray-400
              focus:outline-none focus:ring-2 focus:ring-blue-500
              focus:border-blue-500 text-sm", placeholder="Nháº­p tÃªn Ä‘Äƒng nháº­p")
              }}
            </div>
          </div>

          <div>
            {{ form.password.label(class="block text-sm font-semibold
            text-gray-700 mb-2") }}
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  />
                </svg>
              </div>
              {{ form.password(class="pl-10 appearance-none block w-full px-3
              py-3 border border-gray-300 rounded-lg placeholder-gray-400
              focus:outline-none focus:ring-2 focus:ring-blue-500
              focus:border-blue-500 text-sm", placeholder="Nháº­p máº­t kháº©u") }}
            </div>
          </div>

          {{ form.submit(class="w-full flex justify-center py-3 px-4 border
          border-transparent rounded-lg shadow-sm text-sm font-medium text-white
          bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2
          focus:ring-offset-2 focus:ring-blue-500 transition-colors
          duration-200") }}
        </div>
      </form>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
      <p class="text-sm text-center text-gray-600">
        ChÆ°a cÃ³ tÃ i khoáº£n?
        <a
          href="{{ url_for('auth.register') }}"
          class="font-medium text-blue-600 hover:text-blue-500 transition-colors duration-200"
        >
          ÄÄƒng kÃ½ ngay
        </a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/auth/register.html
================
{% extends "base.html" %} {% block content %}
<div
  class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100 py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full bg-white shadow-xl rounded-lg overflow-hidden">
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-8">
      <h2 class="text-center text-3xl font-bold text-white">
        Táº¡o tÃ i khoáº£n má»›i
      </h2>
      <p class="mt-2 text-center text-blue-100">
        Báº¯t Ä‘áº§u quáº£n lÃ½ tÃ i chÃ­nh cá»§a báº¡n
      </p>
    </div>

    <div class="px-6 py-8">
      <form action="" method="post" novalidate class="space-y-6">
        {{ form.hidden_tag() }}

        <div>
          {{ form.username.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
            </div>
            {{ form.username(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Chá»n tÃªn Ä‘Äƒng nháº­p") }}
          </div>
          {% for error in form.username.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.email.label(class="block text-sm font-semibold text-gray-700
          mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                />
              </svg>
            </div>
            {{ form.email(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Nháº­p email cá»§a báº¡n") }}
          </div>
          {% for error in form.email.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.password.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            {{ form.password(class="pl-10 appearance-none block w-full px-3 py-3
            border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Táº¡o máº­t kháº©u má»›i") }}
          </div>
          {% for error in form.password.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          {{ form.password2.label(class="block text-sm font-semibold
          text-gray-700 mb-2") }}
          <div class="relative">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            {{ form.password2(class="pl-10 appearance-none block w-full px-3
            py-3 border border-gray-300 rounded-lg placeholder-gray-400
            focus:outline-none focus:ring-2 focus:ring-blue-500
            focus:border-blue-500 text-sm", placeholder="Nháº­p láº¡i máº­t kháº©u") }}
          </div>
          {% for error in form.password2.errors %}
          <p class="mt-1 text-sm text-red-600">{{ error }}</p>
          {% endfor %}
        </div>

        {{ form.submit(class="w-full flex justify-center py-3 px-4 border
        border-transparent rounded-lg shadow-sm text-sm font-medium text-white
        bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2
        focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200")
        }}
      </form>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
      <p class="text-sm text-center text-gray-600">
        ÄÃ£ cÃ³ tÃ i khoáº£n?
        <a
          href="{{ url_for('auth.login') }}"
          class="font-medium text-blue-600 hover:text-blue-500 transition-colors duration-200"
        >
          ÄÄƒng nháº­p
        </a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/base.html
================
<!-- app/templates/base.html -->
<!DOCTYPE html>
<html lang="vi">
  <!-- Removed js-loading class -->
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>{{ title }} - Money Keeper</title>

    <!-- Favicon & Icons -->
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='img/app-icon.png') }}"
    />
    <link
      rel="apple-touch-icon"
      href="{{ url_for('static', filename='img/app-icon.png') }}"
    />

    <!-- iOS Web App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Money Keeper" />
    <meta name="theme-color" content="#3B82F6" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='img/app-icon.png') }}"
    />
    <link
      rel="apple-touch-startup-image"
      href="{{ url_for('static', filename='img/app-icon.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- Critical CSS -->
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        /* Removed visibility: hidden; */
      }
      #pageLoader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.3s;
      }
      .loader-hidden {
        opacity: 0;
        pointer-events: none; /* Prevent clicks on hidden loader */
      }
      .loader-active {
        opacity: 1;
      }
      /* Removed .js-loading class handling */

      @media (max-width: 768px) {
        html:not(.landing-page),
        body:not(.landing-page) {
          position: fixed;
          width: 100%;
          height: 100%;
          overflow: hidden;
          overscroll-behavior: none;
          -webkit-overflow-scrolling: touch;
        }

        html.landing-page,
        body.landing-page {
          position: relative;
          overflow-y: auto;
          height: auto;
          -webkit-overflow-scrolling: touch;
        }

        main:not(.landing-content) {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 56px; /* Height of bottom nav */
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          padding-bottom: env(safe-area-inset-bottom);
        }

        main.landing-content {
          position: relative;
          overflow: visible;
        }

        @supports (padding: max(0px)) {
          main {
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: max(56px, env(safe-area-inset-bottom));
          }
        }

        main::-webkit-scrollbar {
          display: none;
        }
      }
    </style>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" data-cfasync="false"></script>

    <!-- Load non-critical CSS asynchronously -->
    <link
      rel="preload"
      href="{{ url_for('static', filename='css/styles.css') }}"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="{{ url_for('static', filename='css/styles.css') }}"
    /></noscript>

    <!-- Initialize moment.js -->
    {{ moment.include_moment() }} {{ moment.locale('vi') }}

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Money Keeper" />
  </head>
  <body class="bg-gray-100 font-sans antialiased">
    <!-- Loading Screen -->
    <div id="pageLoader" class="loader-active">
      <div class="flex flex-col items-center">
        <svg
          class="animate-spin h-10 w-10 text-blue-600 mb-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="text-gray-600 text-sm">Äang táº£i...</p>
      </div>
    </div>

    <!-- Noscript tag for users with JavaScript disabled -->
    <noscript>
      <div
        class="fixed inset-0 bg-red-100 border-l-4 border-red-500 text-red-700 p-4"
        role="alert"
      >
        <p class="font-bold">JavaScript Required</p>
        <p>
          This application requires JavaScript to function properly. Please
          enable JavaScript in your browser settings.
        </p>
      </div>
    </noscript>

    <div class="flex flex-col min-h-screen pb-16 md:pb-0">
      <!-- Top Navigation (Desktop) -->
      {% if current_user.is_authenticated %}
      <nav
        class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-md md:block hidden"
      >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <a href="{{ url_for('main.index') }}" class="flex items-center">
              <span class="text-xl font-bold text-white tracking-tight"
                >Money Keeper</span
              >
            </a>

            <div class="ml-6 flex items-center space-x-6">
              {% if current_user.is_authenticated %}
              <a
                href="{{ url_for('main.index') }}"
                class="text-gray-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >Trang chá»§</a
              >
              <a
                href="{{ url_for('main.expenses') }}"
                class="text-gray-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >Chi tiÃªu</a
              >
              <a
                href="{{ url_for('main.wallets') }}"
                class="text-gray-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >VÃ­</a
              >
              <a
                href="{{ url_for('main.budgets') }}"
                class="text-gray-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >NgÃ¢n sÃ¡ch</a
              >
              <a
                href="{{ url_for('main.chat') }}"
                class="text-gray-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >TrÃ² chuyá»‡n</a
              >
              <div class="ml-3 relative">
                <div>
                  <button
                    id="userMenuButton"
                    type="button"
                    class="flex items-center max-w-xs rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    <span class="sr-only">Má»Ÿ menu ngÆ°á»i dÃ¹ng</span>
                    <div
                      class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold"
                    >
                      {{ current_user.username[0].upper() }}
                    </div>
                  </button>
                </div>

                <div
                  id="userDropdown"
                  class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
                >
                  <div class="px-4 py-2 border-b border-gray-100">
                    <p class="text-sm font-medium text-gray-900">
                      {{ current_user.username }}
                    </p>
                    <p class="text-xs text-gray-500">
                      {{ current_user.email }}
                    </p>
                  </div>

                  <a
                    href="{{ url_for('main.notifications') }}"
                    class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >
                    <svg
                      class="mr-3 h-5 w-5 text-gray-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                      ></path>
                    </svg>
                    ThÃ´ng bÃ¡o {% if unread_notifications_count > 0 %}
                    <span
                      class="ml-auto bg-red-100 text-red-600 py-0.5 px-2 rounded-full text-xs"
                      >{{ unread_notifications_count }}</span
                    >
                    {% endif %}
                  </a>

                  <a
                    href="{{ url_for('main.settings') }}"
                    class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >
                    <svg
                      class="mr-3 h-5 w-5 text-gray-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    CÃ i Ä‘áº·t
                  </a>

                  <div class="border-t border-gray-100"></div>

                  <a
                    href="{{ url_for('auth.logout') }}"
                    class="flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-50"
                  >
                    <svg
                      class="mr-3 h-5 w-5 text-red-400"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                      ></path>
                    </svg>
                    ÄÄƒng xuáº¥t
                  </a>
                </div>
              </div>
              {% else %}
              <a
                href="{{ url_for('auth.login') }}"
                class="bg-white text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >ÄÄƒng nháº­p</a
              >
              <a
                href="{{ url_for('auth.register') }}"
                class="bg-white text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >ÄÄƒng kÃ½</a
              >
              {% endif %}
            </div>
          </div>
        </div>
      </nav>
      {% endif %}

      <main
        id="main-content"
        class="flex-1 mx-auto w-full py-10 px-4 sm:px-6 lg:px-8"
      >
        {% include 'includes/flash.html' %} {% block content %}{% endblock %}
      </main>

      <!-- Bottom Navigation (Mobile) -->
      {% if current_user.is_authenticated %}
      <nav
        class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-50 md:hidden"
      >
        <div class="grid grid-cols-5 h-16">
          <a
            href="{{ url_for('main.index') }}"
            class="flex flex-col items-center justify-center relative group"
          >
            <div
              class="absolute -top-5 w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center transform scale-0 group-hover:scale-100 transition-transform {{ 'scale-100' if request.endpoint == 'main.index' }}"
            >
              <svg
                class="h-6 w-6 text-white"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                />
              </svg>
            </div>
            <svg
              class="h-6 w-6 group-hover:hidden {{ 'hidden' if request.endpoint == 'main.index' }}"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            <span class="text-xs mt-1 font-medium">Trang chá»§</span>
          </a>

          <a
            href="{{ url_for('main.expenses') }}"
            class="flex flex-col items-center justify-center relative group"
          >
            <div
              class="absolute -top-5 w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center transform scale-0 group-hover:scale-100 transition-transform {{ 'scale-100' if request.endpoint == 'main.expenses' }}"
            >
              <svg
                class="h-6 w-6 text-white"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <svg
              class="h-6 w-6 group-hover:hidden {{ 'hidden' if request.endpoint == 'main.expenses' }}"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span class="text-xs mt-1 font-medium">Chi tiÃªu</span>
          </a>

          <a
            href="{{ url_for('main.wallets') }}"
            class="flex flex-col items-center justify-center relative group"
          >
            <div
              class="absolute -top-5 w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center transform scale-0 group-hover:scale-100 transition-transform {{ 'scale-100' if request.endpoint == 'main.wallets' }}"
            >
              <svg
                class="h-6 w-6 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 6h18M3 12h18M3 18h18"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 6H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2z"
                />
              </svg>
            </div>
            <svg
              class="h-6 w-6 group-hover:hidden {{ 'hidden' if request.endpoint == 'main.wallets' }}"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 6H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2z"
              />
            </svg>
            <span class="text-xs mt-1 font-medium">VÃ­</span>
          </a>

          <a
            href="{{ url_for('main.budgets') }}"
            class="flex flex-col items-center justify-center relative group"
          >
            <div
              class="absolute -top-5 w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center transform scale-0 group-hover:scale-100 transition-transform {{ 'scale-100' if request.endpoint == 'main.budgets' }}"
            >
              <svg
                class="h-6 w-6 text-white"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <svg
              class="h-6 w-6 group-hover:hidden {{ 'hidden' if request.endpoint == 'main.budgets' }}"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            <span class="text-xs mt-1 font-medium">NgÃ¢n sÃ¡ch</span>
          </a>

          <div class="flex flex-col items-center justify-center relative group">
            <button
              id="mobileMenuButton"
              class="w-full h-full flex flex-col items-center justify-center"
            >
              <div class="h-6 w-6 relative">
                {% if unread_notifications_count > 0 %}
                <span
                  class="absolute -top-1 -right-1 inline-flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-red-500 rounded-full"
                >
                  {{ unread_notifications_count }}
                </span>
                {% endif %}
                <svg
                  class="h-6 w-6 text-gray-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"
                  />
                </svg>
              </div>
              <span class="text-xs mt-1 font-medium">ThÃªm</span>
            </button>

            <div
              id="mobileMenuDropdown"
              class="hidden absolute bottom-full right-0 mb-2 w-48 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5"
            >
              <div class="py-1">
                <div id="webClipButton" class="hidden">
                  <a
                    href="{{ url_for('main.install_ios_app') }}"
                    class="flex items-center px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 transition-colors"
                  >
                    <svg
                      class="mr-3 h-5 w-5 text-blue-500"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        d="M10 1C5.03 1 1 5.03 1 10c0 4.97 4.03 9 9 9s9-4.03 9-9c0-4.97-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7z"
                      />
                      <path d="M10 6v8M6 10h8" />
                    </svg>
                    CÃ i Ä‘áº·t á»©ng dá»¥ng iOS
                  </a>
                </div>

                <a
                  href="{{ url_for('main.chat') }}"
                  class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <svg
                    class="mr-3 h-5 w-5 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                    />
                  </svg>
                  TrÃ² chuyá»‡n AI
                </a>

                <a
                  href="{{ url_for('main.notifications') }}"
                  class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <svg
                    class="mr-3 h-5 w-5 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                    />
                  </svg>
                  ThÃ´ng bÃ¡o {% if unread_notifications_count > 0 %}
                  <span
                    class="ml-auto bg-red-100 text-red-600 py-0.5 px-2 rounded-full text-xs"
                    >{{ unread_notifications_count }}</span
                  >
                  {% endif %}
                </a>

                <a
                  href="{{ url_for('main.settings') }}"
                  class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <svg
                    class="mr-3 h-5 w-5 text-gray-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                  CÃ i Ä‘áº·t
                </a>

                <div class="border-t border-gray-100 my-1"></div>

                <a
                  href="{{ url_for('auth.logout') }}"
                  class="flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-50"
                >
                  <svg
                    class="mr-3 h-5 w-5 text-red-400"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    />
                  </svg>
                  ÄÄƒng xuáº¥t
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
      {% endif %}

      <div class="md:hidden block absolute top-4 right-4">
        <button
          type="button"
          onclick="toggleMobileMenu()"
          class="text-gray-600 hover:text-gray-800 focus:outline-none focus:text-gray-800"
          aria-label="Toggle menu"
        >
          <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
      </div>

      <div
        id="mobile-menu"
        class="hidden md:hidden fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-90 z-50"
      >
        <div class="px-6 py-8">
          <div class="flex justify-end">
            <button
              onclick="toggleMobileMenu()"
              class="text-gray-300 hover:text-white focus:outline-none focus:text-white"
            >
              <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="px-2 pt-2 pb-3 space-y-2 sm:px-3 mt-12">
            {% if current_user.is_authenticated %}
            <a
              href="{{ url_for('main.index') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >Trang chá»§</a
            >
            <a
              href="{{ url_for('main.expenses') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >Chi tiÃªu</a
            >
            <a
              href="{{ url_for('main.wallets') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >VÃ­</a
            >
            <a
              href="{{ url_for('main.budgets') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >NgÃ¢n sÃ¡ch</a
            >
            <a
              href="{{ url_for('main.chat') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >TrÃ² chuyá»‡n</a
            >
            <a
              href="{{ url_for('main.notifications') }}"
              class="text-gray-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >ThÃ´ng bÃ¡o {% if unread_notifications_count > 0 %}
              <span
                class="ml-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full"
                >{{ unread_notifications_count }}</span
              >
              {% endif %}
            </a>
            <a
              href="{{ url_for('auth.logout') }}"
              class="text-white bg-red-500 hover:bg-red-600 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >ÄÄƒng xuáº¥t</a
            >
            {% else %}
            <a
              href="{{ url_for('auth.login') }}"
              class="text-blue-700 bg-white hover:bg-blue-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >ÄÄƒng nháº­p</a
            >
            <a
              href="{{ url_for('auth.register') }}"
              class="text-blue-700 bg-white hover:bg-blue-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200"
              >ÄÄƒng kÃ½</a
            >
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
    <script>
      function toggleMobileMenu() {
        const menu = document.getElementById("mobile-menu");
        menu.classList.toggle("hidden");
      }

      const pageLoader = document.getElementById("pageLoader");

      function showLoader() {
        pageLoader.classList.remove("loader-hidden");
        pageLoader.classList.add("loader-active");
      }

      function hideLoader() {
        pageLoader.classList.add("loader-hidden");
        pageLoader.classList.remove("loader-active");
      }

      // Use 'load' event to ensure everything (including images) is loaded
      window.addEventListener("load", () => {
        hideLoader();
        document.body.classList.add("page-loaded"); // Add a class to indicate page is fully loaded
      });

      window.addEventListener("popstate", () => {
        showLoader(); // Show loader on browser back/forward
      });

      const userMenuButton = document.getElementById("userMenuButton");
      const userDropdown = document.getElementById("userDropdown");

      if (userMenuButton && userDropdown) {
        userMenuButton.addEventListener("click", () => {
          userDropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", (event) => {
          if (
            !userMenuButton.contains(event.target) &&
            !userDropdown.contains(event.target)
          ) {
            userDropdown.classList.add("hidden");
          }
        });
      }
      const mobileMenuButton = document.getElementById("mobileMenuButton");
      const mobileMenuDropdown = document.getElementById("mobileMenuDropdown");

      if (mobileMenuButton && mobileMenuDropdown) {
        mobileMenuButton.addEventListener("click", (e) => {
          e.stopPropagation();
          mobileMenuDropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", (e) => {
          if (
            !mobileMenuDropdown.contains(e.target) &&
            !mobileMenuButton.contains(e.target)
          ) {
            mobileMenuDropdown.classList.add("hidden");
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const isIOS =
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const webClipButton = document.getElementById("webClipButton");

        if (isIOS && !window.navigator.standalone) {
          webClipButton.classList.remove("hidden");
        }
      });

      function showWebClipInstructions() {
        const instructions = `
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50">
              <div class="bg-white rounded-lg max-w-sm w-full p-6">
                <h3 class="text-lg font-semibold mb-4">ThÃªm á»©ng dá»¥ng vÃ o mÃ n hÃ¬nh chÃ­nh</h3>
                <ol class="space-y-3 text-sm text-gray-600 mb-6">
                  <li class="flex items-center">
                    <span class="mr-2">1.</span>
                    Nháº¥n vÃ o nÃºt Chia sáº»
                    <svg class="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                    </svg>
                  </li>
                  <li class="flex items-center">
                    <span class="mr-2">2.</span>
                    Chá»n "ThÃªm vÃ o mÃ n hÃ¬nh chÃ­nh"
                  </li>
                  <li class="flex items-center">
                    <span class="mr-2">3.</span>
                    Nháº¥n "ThÃªm" Ä‘á»ƒ hoÃ n táº¥t
                  </li>
                </ol>
                <button onclick="this.parentElement.parentElement.remove()"
                        class="w-full bg-blue-600 text-white rounded-md py-2 font-medium hover:bg-blue-700">
                  ÄÃ£ hiá»ƒu
                </button>
              </div>
            </div>
          `;
        document.body.insertAdjacentHTML("beforeend", instructions);
      }

      if (window.navigator.standalone) {
        document.body.classList.add("ios-standalone");
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (window.location.pathname === "/") {
          document.documentElement.setAttribute("data-page", "landing");
          document.body.setAttribute("data-page", "landing");
          document.querySelector("main").classList.add("landing-content");
        } else {
          document.documentElement.setAttribute("data-page", "app");
          document.body.setAttribute("data-page", "app");
        }
      });
    </script>
  </body>
</html>

================
File: app/templates/email/budget_alert.html
================
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      .alert {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .header {
        color: #004085;
        margin-bottom: 15px;
      }
      .details {
        margin: 20px 0;
      }
      .button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="header">Cáº£nh bÃ¡o ngÃ¢n sÃ¡ch</h2>

      <div class="alert">
        Chi tiÃªu cá»§a báº¡n trong danh má»¥c <strong>{{ category }}</strong> Ä‘Ã£ Ä‘áº¡t
        <strong>{{ percentage }}%</strong> ngÃ¢n sÃ¡ch.
      </div>

      <div class="details">
        <p>Chi tiáº¿t:</p>
        <ul>
          <li>ÄÃ£ chi: {{ "{:,.0f}".format(amount) }}â‚«</li>
          <li>NgÃ¢n sÃ¡ch: {{ "{:,.0f}".format(budget_amount) }}â‚«</li>
          <li>CÃ²n láº¡i: {{ "{:,.0f}".format(budget_amount - amount) }}â‚«</li>
        </ul>
      </div>

      <p>
        <a href="{{ url_for('main.budgets', _external=True) }}" class="button">
          Xem chi tiáº¿t ngÃ¢n sÃ¡ch
        </a>
      </p>
    </div>
  </body>
</html>

================
File: app/templates/email/unusual_spending.html
================
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      .alert {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .header {
        color: #004085;
        margin-bottom: 15px;
      }
      .details {
        margin: 20px 0;
      }
      .button {
        display: inline-block;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="header">Chi tiÃªu báº¥t thÆ°á»ng</h2>

      <div class="alert">
        Há»‡ thá»‘ng phÃ¡t hiá»‡n má»™t khoáº£n chi tiÃªu báº¥t thÆ°á»ng trong danh má»¥c
        <strong>{{ category }}</strong>.
      </div>

      <div class="details">
        <p>Chi tiáº¿t:</p>
        <ul>
          <li>Sá»‘ tiá»n: {{ "{:,.0f}".format(amount) }}â‚«</li>
          <li>Trung bÃ¬nh thÆ°á»ng: {{ "{:,.0f}".format(average) }}â‚«</li>
        </ul>
      </div>

      <p>
        <a href="{{ url_for('main.expenses', _external=True) }}" class="button">
          Xem lá»‹ch sá»­ chi tiÃªu
        </a>
      </p>
    </div>
  </body>
</html>

================
File: app/templates/includes/flash.html
================
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%}
<div class="flash-messages">
  {% for category, message in messages %}
  <div
    class="mb-4 {{ 'bg-blue-100 border-blue-500 text-blue-700' if category == 'info' else
                                   'bg-green-100 border-green-500 text-green-700' if category == 'success' else
                                   'bg-red-100 border-red-500 text-red-700' if category == 'error' else
                                   'bg-blue-100 border-blue-500 text-blue-700' }} border-l-4 p-4"
    role="alert"
    data-category="{{ category }}"
  >
    <p class="font-medium">{{ message }}</p>
  </div>
  {% endfor %}
</div>
{% endif %} {% endwith %}

================
File: app/templates/includes/loading.html
================
<div
  id="loading"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
>
  <div
    class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"
  ></div>
</div>

<script>
  function showLoading() {
    document.getElementById("loading").classList.remove("hidden");
  }

  function hideLoading() {
    document.getElementById("loading").classList.add("hidden");
  }
</script>

================
File: app/templates/includes/pagination.html
================
{% if pagination is defined and pagination.pages > 1 %}
<div class="mt-4 flex justify-center">
  <div class="inline-flex rounded-md shadow-sm">
    {% if pagination.has_prev %}
    <a
      href="{{ url_for(request.endpoint, page=pagination.prev_num, **kwargs) }}"
      class="px-3 py-2 text-sm font-medium text-blue-600 bg-white border border-gray-300 rounded-l-md hover:bg-gray-100"
    >
      Trang trÆ°á»›c
    </a>
    {% endif %} {% for page in pagination.iter_pages(left_edge=2,
    left_current=2, right_current=3, right_edge=2) %} {% if page %} {% if page
    != pagination.page %}
    <a
      href="{{ url_for(request.endpoint, page=page, **kwargs) }}"
      class="px-3 py-2 text-sm font-medium text-blue-600 bg-white border-t border-b border-gray-300 hover:bg-gray-100"
    >
      {{ page }}
    </a>
    {% else %}
    <span
      class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border-t border-b border-gray-300"
    >
      {{ page }}
    </span>
    {% endif %} {% else %}
    <span
      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border-t border-b border-gray-300"
    >
      ...
    </span>
    {% endif %} {% endfor %} {% if pagination.has_next %}
    <a
      href="{{ url_for(request.endpoint, page=pagination.next_num, **kwargs) }}"
      class="px-3 py-2 text-sm font-medium text-blue-600 bg-white border border-gray-300 rounded-r-md hover:bg-gray-100"
    >
      Trang sau
    </a>
    {% endif %}
  </div>
</div>
{% endif %}

================
File: app/templates/landing.html
================
{% extends "layouts/landing.html" %}
{% block content %}
<div class="landing-content">
  <!-- Hero Section -->
  <div class="relative overflow-hidden">
    <div class="max-w-7xl mx-auto">
      <div
        class="relative z-10 pb-8 bg-gray-50 sm:pb-16 md:pb-20 lg:max-w-2xl lg:w-full lg:pb-28 xl:pb-32"
      >
        <main
          class="mt-10 mx-auto max-w-7xl px-4 sm:mt-12 sm:px-6 lg:mt-16 lg:px-8 xl:mt-20"
        >
          <div class="sm:text-center lg:text-left">
            <h1
              class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl"
            >
              <span class="block">Quáº£n lÃ½ chi tiÃªu</span>
              <span class="block text-green-600">thÃ´ng minh hÆ¡n</span>
            </h1>
            <p
              class="mt-3 text-base text-gray-500 sm:mt-5 sm:text-lg sm:max-w-xl sm:mx-auto md:mt-5 md:text-xl lg:mx-0"
            >
              Money Keeper giÃºp báº¡n theo dÃµi chi tiÃªu, láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch vÃ 
              Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu tÃ i chÃ­nh cá»§a mÃ¬nh má»™t cÃ¡ch dá»… dÃ ng.
            </p>
            <div
              class="mt-5 sm:mt-8 sm:flex sm:justify-center lg:justify-start"
            >
              <div class="rounded-md shadow">
                <a
                  href="{{ url_for('auth.register') }}"
                  class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 md:py-4 md:text-lg md:px-10"
                >
                  Báº¯t Ä‘áº§u miá»…n phÃ­
                </a>
              </div>
              <div class="mt-3 sm:mt-0 sm:ml-3">
                <a
                  href="{{ url_for('auth.login') }}"
                  class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 md:py-4 md:text-lg md:px-10"
                >
                  ÄÄƒng nháº­p
                </a>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Features Section -->
  <div class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          TÃ­nh nÄƒng
        </h2>
        <p
          class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl"
        >
          Quáº£n lÃ½ tÃ i chÃ­nh dá»… dÃ ng hÆ¡n
        </p>
      </div>

      <div class="mt-10">
        <div class="grid grid-cols-1 gap-10 sm:grid-cols-2 lg:grid-cols-3">
          <!-- Feature 1 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Theo dÃµi chi tiÃªu
            </h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Ghi chÃ©p vÃ  phÃ¢n loáº¡i chi tiÃªu hÃ ng ngÃ y má»™t cÃ¡ch dá»… dÃ ng
            </p>
          </div>

          <!-- Feature 2 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch
            </h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Thiáº¿t láº­p vÃ  theo dÃµi ngÃ¢n sÃ¡ch cho tá»«ng danh má»¥c chi tiÃªu
            </p>
          </div>

          <!-- Feature 3 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">Trá»£ lÃ½ AI</h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Nháº­n tÆ° váº¥n vÃ  phÃ¢n tÃ­ch tÃ i chÃ­nh thÃ´ng minh tá»« AI
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Benefits Section -->
  <div class="bg-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          Lá»£i Ã­ch
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Táº¡i sao chá»n Money Keeper?
        </p>
      </div>
      <div class="mt-12 grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Benefit 1: Easy to Use -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Dá»… dÃ ng sá»­ dá»¥ng
          </h3>
          <p class="mt-2 text-base text-gray-500">
            Giao diá»‡n thÃ¢n thiá»‡n, thao tÃ¡c Ä‘Æ¡n giáº£n, phÃ¹ há»£p má»i Ä‘á»‘i tÆ°á»£ng ngÆ°á»i
            dÃ¹ng
          </p>
        </div>

        <!-- Benefit 2: Smart Analysis -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            PhÃ¢n tÃ­ch thÃ´ng minh
          </h3>
          <p class="mt-2 text-base text-gray-500">
            BÃ¡o cÃ¡o chi tiáº¿t, biá»ƒu Ä‘á»“ trá»±c quan vÃ  dá»± Ä‘oÃ¡n xu hÆ°á»›ng chi tiÃªu
          </p>
        </div>

        <!-- Benefit 3: Security -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Báº£o máº­t tuyá»‡t Ä‘á»‘i
          </h3>
          <p class="mt-2 text-base text-gray-500">
            MÃ£ hÃ³a dá»¯ liá»‡u, xÃ¡c thá»±c hai lá»›p vÃ  báº£o vá»‡ thÃ´ng tin cÃ¡ nhÃ¢n
          </p>
        </div>

        <!-- Benefit 4: AI Assistant -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Trá»£ lÃ½ thÃ´ng minh
          </h3>
          <p class="mt-2 text-base text-gray-500">
            TÆ° váº¥n tÃ i chÃ­nh cÃ¡ nhÃ¢n hÃ³a vÃ  gá»£i Ã½ tiáº¿t kiá»‡m tá»« AI
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="bg-green-700">
    <div class="max-w-7xl mx-auto py-12 px-4 sm:py-16 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 gap-8 sm:grid-cols-3 text-center">
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">1,000+</p>
          <p class="mt-2 text-lg text-green-100">NgÆ°á»i dÃ¹ng tin tÆ°á»Ÿng</p>
        </div>
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">100M+</p>
          <p class="mt-2 text-lg text-green-100">Giao dá»‹ch Ä‘Æ°á»£c ghi nháº­n</p>
        </div>
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">4.8/5</p>
          <p class="mt-2 text-lg text-green-100">ÄÃ¡nh giÃ¡ tá»« ngÆ°á»i dÃ¹ng</p>
        </div>
      </div>
    </div>
  </div>

  <!-- How It Works Section -->
  <div class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          HÆ°á»›ng dáº«n
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Báº¯t Ä‘áº§u trong 3 bÆ°á»›c Ä‘Æ¡n giáº£n
        </p>
      </div>
      <div class="mt-12">
        <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
          <!-- Step 1 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">1</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              ÄÄƒng kÃ½ tÃ i khoáº£n
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Táº¡o tÃ i khoáº£n miá»…n phÃ­ vÃ  thiáº¿t láº­p mÃ£ PIN Ä‘á»ƒ báº£o vá»‡ thÃ´ng tin cá»§a
              báº¡n
            </p>
          </div>

          <!-- Step 2 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">2</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Nháº­p thÃ´ng tin chi tiÃªu
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Ghi láº¡i cÃ¡c khoáº£n chi tiÃªu hÃ ng ngÃ y vÃ  phÃ¢n loáº¡i theo danh má»¥c
            </p>
          </div>

          <!-- Step 3 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">3</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Theo dÃµi vÃ  phÃ¢n tÃ­ch
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Xem bÃ¡o cÃ¡o chi tiáº¿t vÃ  nháº­n tÆ° váº¥n tá»« trá»£ lÃ½ AI Ä‘á»ƒ quáº£n lÃ½ tÃ i
              chÃ­nh tá»‘t hÆ¡n
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Testimonials Section -->
  <div class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          ÄÃ¡nh giÃ¡
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          NgÆ°á»i dÃ¹ng nÃ³i gÃ¬ vá» chÃºng tÃ´i
        </p>
      </div>
      <div class="mt-12 grid gap-8 md:grid-cols-3">
        <!-- Testimonial 1 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Tran+Minh+Duc"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">HÃ²n Minh Äá»©c</h4>
              <p class="text-gray-500">Káº¿ toÃ¡n viÃªn</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "LÃ  má»™t káº¿ toÃ¡n viÃªn, tÃ´i ráº¥t áº¥n tÆ°á»£ng vá»›i tÃ­nh nÄƒng phÃ¢n loáº¡i chi
            tiÃªu tá»± Ä‘á»™ng vÃ  bÃ¡o cÃ¡o chi tiáº¿t. Money Keeper giÃºp tÃ´i theo dÃµi tÃ i
            chÃ­nh cÃ¡ nhÃ¢n hiá»‡u quáº£ hÆ¡n nhiá»u."
          </p>
        </div>

        <!-- Testimonial 2 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Nguyen+Thu+Ha"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">Nguyá»…n Thu HÃ </h4>
              <p class="text-gray-500">Sinh viÃªn</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "á»¨ng dá»¥ng ráº¥t phÃ¹ há»£p vá»›i sinh viÃªn nhÆ° mÃ¬nh. Giao diá»‡n Ä‘áº¹p, dá»… sá»­
            dá»¥ng vÃ  Ä‘áº·c biá»‡t lÃ  tÃ­nh nÄƒng nháº¯c nhá»Ÿ chi tiÃªu ráº¥t há»¯u Ã­ch!"
          </p>
        </div>

        <!-- Testimonial 3 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Le+Van+Tuan"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">LÃª VÄƒn Tuáº¥n</h4>
              <p class="text-gray-500">Chá»§ doanh nghiá»‡p</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "Trá»£ lÃ½ AI cá»§a Money Keeper Ä‘Æ°a ra nhá»¯ng gá»£i Ã½ tÃ i chÃ­nh ráº¥t há»¯u
            Ã­ch. TÃ´i Ä‘Ã£ tiáº¿t kiá»‡m Ä‘Æ°á»£c nhiá»u hÆ¡n tá»« khi sá»­ dá»¥ng á»©ng dá»¥ng nÃ y."
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ Section -->
  <div class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          CÃ¢u há»i thÆ°á»ng gáº·p
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Giáº£i Ä‘Ã¡p tháº¯c máº¯c cá»§a báº¡n
        </p>
      </div>
      <div class="mt-12 max-w-3xl mx-auto">
        <div class="space-y-4">
          <!-- FAQ 1 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Money Keeper cÃ³ tÃ­nh phÃ­ khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Money Keeper hoÃ n toÃ n miá»…n phÃ­ cho ngÆ°á»i dÃ¹ng cÃ¡ nhÃ¢n vá»›i Ä‘áº§y Ä‘á»§
              tÃ­nh nÄƒng cÆ¡ báº£n. ChÃºng tÃ´i khÃ´ng cÃ³ phÃ­ áº©n hay yÃªu cáº§u thanh toÃ¡n
              báº¥t ngá».
            </p>
          </div>

          <!-- FAQ 2 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Dá»¯ liá»‡u cá»§a tÃ´i cÃ³ Ä‘Æ°á»£c báº£o máº­t khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              ChÃºng tÃ´i Ã¡p dá»¥ng cÃ¡c biá»‡n phÃ¡p báº£o máº­t cao cáº¥p Ä‘á»ƒ báº£o vá»‡ thÃ´ng
              tin cá»§a báº¡n. Dá»¯ liá»‡u Ä‘Æ°á»£c mÃ£ hÃ³a vÃ  chá»‰ báº¡n má»›i cÃ³ quyá»n truy cáº­p
              vÃ o tÃ i khoáº£n cá»§a mÃ¬nh.
            </p>
          </div>

          <!-- FAQ 3 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              LÃ m tháº¿ nÃ o Ä‘á»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Chá»‰ cáº§n Ä‘Äƒng kÃ½ tÃ i khoáº£n miá»…n phÃ­, thiáº¿t láº­p mÃ£ PIN vÃ  báº¡n cÃ³ thá»ƒ
              báº¯t Ä‘áº§u sá»­ dá»¥ng ngay. ChÃºng tÃ´i cÃ³ hÆ°á»›ng dáº«n chi tiáº¿t vÃ  Ä‘á»™i ngÅ©
              há»— trá»£ sáºµn sÃ ng giÃºp Ä‘á»¡ báº¡n.
            </p>
          </div>

          <!-- FAQ 4 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              TÃ´i cÃ³ thá»ƒ xuáº¥t bÃ¡o cÃ¡o chi tiÃªu khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              CÃ³, báº¡n cÃ³ thá»ƒ xuáº¥t bÃ¡o cÃ¡o chi tiáº¿t theo nhiá»u Ä‘á»‹nh dáº¡ng khÃ¡c
              nhau (PDF, Excel). BÃ¡o cÃ¡o bao gá»“m thá»‘ng kÃª, biá»ƒu Ä‘á»“ vÃ  phÃ¢n tÃ­ch
              chi tiÃªu cá»§a báº¡n.
            </p>
          </div>

          <!-- FAQ 5 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Trá»£ lÃ½ AI hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Trá»£ lÃ½ AI phÃ¢n tÃ­ch máº«u chi tiÃªu cá»§a báº¡n vÃ  Ä‘Æ°a ra cÃ¡c gá»£i Ã½ cÃ¡
              nhÃ¢n hÃ³a Ä‘á»ƒ giÃºp báº¡n tiáº¿t kiá»‡m hiá»‡u quáº£ hÆ¡n. AI cÅ©ng cÃ³ thá»ƒ tráº£
              lá»i cÃ¡c cÃ¢u há»i vá» tÃ i chÃ­nh vÃ  Ä‘Æ°a ra lá»i khuyÃªn phÃ¹ há»£p.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced CTA Section -->
  <div class="bg-green-700">
    <div
      class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:py-16 lg:px-8 lg:flex lg:items-center lg:justify-between"
    >
      <h2 class="text-3xl font-extrabold tracking-tight text-white sm:text-4xl">
        <span class="block">Sáºµn sÃ ng quáº£n lÃ½ tÃ i chÃ­nh thÃ´ng minh?</span>
        <span class="block text-green-200"
          >Báº¯t Ä‘áº§u sá»­ dá»¥ng Money Keeper ngay hÃ´m nay.</span
        >
      </h2>
      <div class="mt-8 flex lg:mt-0 lg:flex-shrink-0">
        <div class="inline-flex rounded-md shadow">
          <a
            href="{{ url_for('auth.register') }}"
            class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-green-700 bg-white hover:bg-green-50"
          >
            ÄÄƒng kÃ½ miá»…n phÃ­
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/layouts/landing.html
================
<!DOCTYPE html>
<html lang="vi" class="landing-page">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }} - Money Keeper</title>

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/app-icon.png') }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/app-icon.png') }}" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    
    <!-- Load Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-y: auto;
            position: relative;
            min-height: 100%;
        }
        
        @media (max-width: 768px) {
            html, body {
                overflow-y: auto;
                position: relative;
                height: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    {% block content %}{% endblock %}
</body>
</html>

================
File: app/templates/main/add_expense.html
================
{% extends "base.html" %} {% block content %}
<div class="pb-32 sm:pb-0">
  <div class="animate__animated animate__fadeIn max-w-lg mx-auto">
    <div
      class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-t-xl p-6"
    >
      <h1 class="text-2xl font-bold flex items-center">
        <svg
          class="w-6 h-6 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
          />
        </svg>
        ThÃªm giao dá»‹ch má»›i
      </h1>
    </div>

    <div class="bg-white rounded-b-xl shadow-lg">
      <form
        method="POST"
        enctype="multipart/form-data"
        class="divide-y divide-gray-200"
      >
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
          {{ form.hidden_tag() }}

          <div
            class="sticky top-0 z-10 bg-white -mx-4 px-4 py-2 sm:static sm:p-0"
          >
            <div class="flex rounded-lg bg-gray-100 p-1">
              <button
                type="button"
                onclick="toggleTransactionType('expense')"
                class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 expense-toggle active"
              >
                Chi tiÃªu
              </button>
              <button
                type="button"
                onclick="toggleTransactionType('income')"
                class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 income-toggle"
              >
                Thu nháº­p
              </button>
            </div>
            {{ form.is_expense(class="hidden") }}
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Chá»n vÃ­</label
            >
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-lg">ðŸ’¼</span>
              </div>
              {{ form.wallet_id(class="pl-10 block w-full rounded-lg
              border-gray-300 focus:ring-green-500 focus:border-green-500 py-3")
              }}
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Sá»‘ tiá»n</label
            >
            <div class="relative rounded-lg shadow-sm">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500">â‚«</span>
              </div>
              {{ form.amount(class="pl-8 pr-12 block w-full text-xl rounded-lg
              border-gray-300 focus:ring-green-500 focus:border-green-500 py-4",
              placeholder="0", inputmode="decimal", pattern="[0-9]*.*[0-9]*",
              step="any") }}
              <button
                type="button"
                onclick="startVoiceInput()"
                class="absolute inset-y-0 right-0 px-4 flex items-center bg-gray-50 rounded-r-lg hover:bg-gray-100"
              >
                <svg
                  class="h-5 w-5 text-gray-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
            <button
              type="button"
              onclick="setAmount(20000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              20,000â‚«
            </button>
            <button
              type="button"
              onclick="setAmount(50000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              50,000â‚«
            </button>
            <button
              type="button"
              onclick="setAmount(100000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              100,000â‚«
            </button>
            <button
              type="button"
              onclick="setAmount(200000)"
              class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center"
            >
              200,000â‚«
            </button>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Danh má»¥c</label
            >
            <div class="grid grid-cols-4 gap-2 sm:grid-cols-4 sm:gap-3">
              {% for value, label in form.category.choices %}
              <button
                type="button"
                onclick="setCategory('{{ value }}')"
                class="category-btn flex flex-col items-center p-2 sm:p-4 rounded-lg border"
              >
                <span class="text-xl sm:text-2xl mb-1 sm:mb-2"
                  >{{ category_icons[value] }}</span
                >
                <span class="text-[10px] sm:text-xs">{{ label }}</span>
              </button>
              {% endfor %}
            </div>
            {{ form.category(class="hidden") }}
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >Ghi chÃº</label
            >
            <div class="relative">
              {{ form.description(class="block w-full rounded-lg border-gray-300
              focus:ring-green-500 focus:border-green-500 py-3", rows="3",
              placeholder="ThÃªm ghi chÃº...", autocapitalize="sentences") }}
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700"
              >HÃ³a Ä‘Æ¡n (tÃ¹y chá»n)</label
            >
            <div
              class="flex justify-center px-6 py-4 border-2 border-gray-300 border-dashed rounded-lg hover:border-green-500 transition-colors"
            >
              <div class="space-y-1 text-center">
                <div class="flex text-sm text-gray-600">
                  <label
                    class="relative cursor-pointer bg-white rounded-md font-medium text-green-600 hover:text-green-500"
                  >
                    <span>Táº£i áº£nh lÃªn</span>
                    {{ form.receipt(class="sr-only", accept="image/*",
                    capture="environment") }}
                  </label>
                </div>
              </div>
            </div>

            <div
              id="receiptPreview"
              class="hidden mt-4 bg-green-50 border border-green-200 rounded-lg p-4"
            >
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <svg
                    class="h-5 w-5 text-green-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-green-800">
                    ÄÃ£ quÃ©t hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng
                  </h3>
                  <div class="mt-2 text-sm text-green-700">
                    <p id="receiptAmount"></p>
                    <p id="receiptDate"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 sm:relative sm:border-t-0 sm:p-6 sm:bg-transparent"
        >
          <div class="flex gap-3 max-w-lg mx-auto">
            <a
              href="{{ url_for('main.expenses') }}"
              class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50"
            >
              Há»§y
            </a>
            {{ form.submit(class="flex-1 py-3 px-4 border border-transparent
            rounded-lg text-white bg-green-600 hover:bg-green-700") }}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function formatMoney(input) {
    let value = input.replace(/\D/g, '');
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function parseMoney(str) {
    return parseInt(str.replace(/\./g, '')) || 0;
  }

  function setAmount(amount) {
    document.getElementById("amount").value = formatMoney(amount.toString());
    document.querySelectorAll(".amount-btn").forEach((btn) => {
      btn.classList.remove("bg-green-100", "text-green-800");
    });
    event.target.classList.add("bg-green-100", "text-green-800");
  }

  document.getElementById('amount').addEventListener('input', function(e) {
    let value = formatMoney(e.target.value);
    e.target.value = value;
  });

  document.querySelector('form').addEventListener('submit', function(e) {
    const amountInput = document.getElementById('amount');
    amountInput.value = parseMoney(amountInput.value);
  });

  function setCategory(category) {
    document.getElementById("category").value = category;
    document.querySelectorAll(".category-btn").forEach((btn) => {
      btn.classList.remove(
        "bg-green-100",
        "text-green-800",
        "border-green-500"
      );
    });
    event.target.classList.add(
      "bg-green-100",
      "text-green-800",
      "border-green-500"
    );
    updateCategoryIcon(category);
  }

  function updateCategoryIcon(category) {
    const icons = {
      food: "ðŸœ",
      transport: "ðŸš—",
      shopping: "ðŸ›ï¸",
      entertainment: "ðŸŽ®",
      bills: "ðŸ“„",
      health: "ðŸ’Š",
      other: "ðŸ“",
    };
    document.getElementById("categoryIcon").textContent =
      icons[category] || "ðŸ“";
  }

  function startVoiceInput() {
    if ("webkitSpeechRecognition" in window) {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "vi-VN";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        const amountMatch = transcript.match(
          /(\d+(\s*nghÃ¬n|\s*triá»‡u|\s*tá»·)?)/i
        );
        if (amountMatch) {
          const amount = convertVietnameseCurrency(amountMatch[0]);
          document.getElementById("amount").value = formatMoney(amount.toString());
        }
      };

      recognition.start();
    } else {
      alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ nháº­p giá»ng nÃ³i");
    }
  }

  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function convertVietnameseCurrency(str) {
    str.toLowerCase().trim();
    let amount = parseFloat(str.replace(/[^\d]/g, ""));

    if (str.includes("nghÃ¬n") || str.includes("ngÃ n")) {
      amount *= 1000;
    } else if (str.includes("triá»‡u")) {
      amount *= 1000000;
    } else if (str.includes("tá»·")) {
      amount *= 1000000000;
    }

    return amount;
  }

  document
    .getElementById("receipt")
    .addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("receipt", file);

      try:
        const response = await fetch("/process_receipt", {
          method: "POST",
          body:formData,
        });

        const data = await response.json();

        if (data.amount) {
          document.getElementById("amount").value = data.amount;
        }

        document.getElementById("receiptPreview").classList.remove("hidden");
        document.getElementById(
          "receiptAmount"
        ).textContent = `Sá»‘ tiá»n: ${new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(data.amount)}`;

        if (data.date) {
          document.getElementById(
            "receiptDate"
          ).textContent = `NgÃ y: ${new Date(data.date).toLocaleDateString(
            "vi-VN"
          )}`;
        }
      } catch (error) {
        console.error("Error processing receipt:", error);
      }
    });

  document
    .getElementById("description")
    .addEventListener("blur", async function (e) {
      const description = e.target.value;
      if (!description) return;

      try:
        const response = await fetch("/ai/suggest_category", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ description: description }),
        });

        const data = await response.json();
        if (data.category) {
          document.getElementById("category").value = data.category;
          showToast("ÄÃ£ tá»± Ä‘á»™ng chá»n danh má»¥c phÃ¹ há»£p ðŸ¤–", "success");
        }
      } catch (error) {
        console.error("Error suggesting category:", error);
      }
    });

  document.getElementById("amount").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value;
  });

  document.getElementById("category").addEventListener("change", function (e) {
    updateCategoryIcon(e.target.value);
  });

  document.addEventListener("DOMContentLoaded", function () {
    updateCategoryIcon(document.getElementById("category").value);
  });

  function toggleTransactionType(type) {
    const isExpense = type === "expense";
    document.getElementById("is_expense").value = isExpense;

    const expenseBtn = document.querySelector(".expense-toggle");
    const incomeBtn = document.querySelector(".income-toggle");

    if (isExpense) {
      expenseBtn.classList.add("bg-green-100", "text-green-800");
      incomeBtn.classList.remove("bg-green-100", "text-green-800");
    } else {
      incomeBtn.classList.add("bg-green-100", "text-green-800");
      expenseBtn.classList.remove("bg-green-100", "text-green-800");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const isExpense = document.getElementById("is_expense").value === "True";
    toggleTransactionType(isExpense ? "expense" : "income");
  });
</script>
{% endblock %}

================
File: app/templates/main/budgets.html
================
{% extends "base.html" %} {% block content %}
<div class="animate__animated animate__fadeIn">
  <div
    class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-10 md:gap-12"
  >
    <!-- Budget Form -->
    <div
      class="bg-white p-6 md:p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-200"
    >
      <h2 class="text-2xl font-semibold mb-8 flex items-center text-blue-700">
        <svg
          class="w-6 h-6 mr-2 text-blue-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
          />
        </svg>
        Thiáº¿t láº­p ngÃ¢n sÃ¡ch má»›i
      </h2>

      <form method="POST" class="space-y-6">
        {{ form.hidden_tag() }}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="col-span-2">
            {{ form.category.label(class="block text-sm font-medium
            text-gray-700 mb-2") }} {{ form.category(class="w-full rounded-md
            border-gray-300 shadow-sm focus:border-blue-500
            focus:ring-blue-500") }} {% for error in form.category.errors %}
            <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="col-span-2">
            {{ form.amount.label(class="block text-sm font-medium text-gray-700
            mb-2") }} {{ form.amount(class="w-full rounded-md border-gray-300
            shadow-sm focus:border-blue-500 focus:ring-blue-500", type="number",
            step="1000") }} {% for error in form.amount.errors %}
            <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
          </div>
          <div>
            {{ form.month.label(class="block text-sm font-medium text-gray-700
            mb-2") }} {{ form.month(class="w-full rounded-md border-gray-300
            shadow-sm focus:border-blue-500 focus:ring-blue-500") }} {% for
            error in form.month.errors %}
            <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
          </div>
          <div>
            {{ form.year.label(class="block text-sm font-medium text-gray-700
            mb-2") }} {{ form.year(class="w-full rounded-md border-gray-300
            shadow-sm focus:border-blue-500 focus:ring-blue-500") }} {% for
            error in form.year.errors %}
            <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
          </div>
        </div>
        <div class="flex justify-end pt-4">
          <!-- Added pt -->
          {{ form.submit(class="bg-gradient-to-r from-blue-500 to-blue-700
          hover:from-blue-600 hover:to-blue-800 text-white font-semibold px-6
          py-2 rounded-md shadow-md transition-all duration-200") }}
          <!-- Added font-semibold, shadow, increased px -->
        </div>
      </form>
    </div>

    <!-- Current Budgets -->
    <div class="space-y-8">
      <h2 class="text-2xl font-semibold flex items-center text-green-700">
        <svg
          class="w-6 h-6 mr-2 text-green-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
          />
        </svg>
        Danh sÃ¡ch ngÃ¢n sÃ¡ch
      </h2>

      {% if budgets %}
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-1">
        {% for budget in budgets %}
        <div
          class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-200 border-b-2 border-gray-100"
        >
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">
                {{ dict(form.category.choices)[budget.category] }}
              </h3>
              <p class="text-sm text-gray-500">
                ThÃ¡ng {{ budget.month }}/{{ budget.year }}
              </p>
            </div>
            <div class="text-right">
              <div class="text-xl font-bold text-gray-900">
                {{ "{:,.0f}".format(budget.amount) }}â‚«
              </div>
              <div class="text-sm text-gray-500">NgÃ¢n sÃ¡ch</div>
            </div>
          </div>

          {% set expenses = current_user.expenses|selectattr('category', 'equalto', budget.category)
                     |selectattr('date.month', 'equalto', budget.month)
                     |selectattr('date.year', 'equalto', budget.year)|list %}
          {% set total_spent = expenses|sum(attribute='amount') %} {% set
          percentage = (total_spent / budget.amount * 100)|round|int %}

          <div class="space-y-3">
            <div class="flex justify-between text-sm text-gray-600">
              <span>ÄÃ£ chi: {{ "{:,.0f}".format(total_spent) }}â‚«</span>
              <span
                class="{{ 'text-red-600 font-medium' if percentage > 100 else 'text-gray-600' }}"
              >
                {{ percentage }}%
              </span>
            </div>

            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-500 {{ 
                'bg-red-500' if percentage >= 100 
                else 'bg-yellow-500' if percentage >= 80 
                else 'bg-green-500' 
              }}"
                style="width: {{ percentage if percentage <= 100 else 100 }}%"
              ></div>
            </div>

            <div
              class="text-sm text-right {{ 
              'text-red-600' if percentage >= 100 
              else 'text-yellow-600' if percentage >= 80 
              else 'text-green-600' 
            }}"
            >
              CÃ²n láº¡i: {{ "{:,.0f}".format(budget.amount - total_spent) }}â‚«
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="bg-white p-8 rounded-xl shadow-md text-center">
        <svg
          class="w-16 h-16 mx-auto text-gray-400 mb-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
          />
        </svg>
        <p class="text-gray-600 font-medium">
          ChÆ°a cÃ³ ngÃ¢n sÃ¡ch nÃ o Ä‘Æ°á»£c thiáº¿t láº­p.
        </p>
        <p class="text-sm text-gray-500 mt-2">
          HÃ£y táº¡o ngÃ¢n sÃ¡ch Ä‘áº§u tiÃªn cá»§a báº¡n!
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/main/chat.html
================
{% extends "base.html" %}

{% block content %}
{% if current_user.is_authenticated %}
<div class="animate__animated animate__fadeIn">
  <!-- Main container with proper desktop height -->
  <div class="fixed inset-0 md:static flex flex-col bg-gray-50 md:h-[85vh] md:mx-auto md:max-w-4xl md:rounded-xl md:shadow-lg">

    <!-- Header -->
    <div class="flex-none bg-white border-b border-gray-200 px-4 py-3 md:rounded-t-xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl font-semibold">
            AI
          </div>
          <div>
            <h2 class="font-semibold text-gray-800">MoneyKeeper AI</h2>
            <p class="text-sm text-gray-500">Trá»£ lÃ½ tÃ i chÃ­nh cá»§a báº¡n</p>
          </div>
        </div>
        <!-- Personality selector -->
        <select id="aiPersonality" onchange="updateSessionPersonality()"
          class="bg-gray-50 border border-gray-200 text-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="friendly" {% if session.personality == 'friendly' %}selected{% endif %}>ThÃ¢n thiá»‡n ðŸ¤—</option>
          <option value="strict" {% if session.personality == 'strict' %}selected{% endif %}>NghiÃªm kháº¯c ðŸ˜¤</option>
          <option value="funny" {% if session.personality == 'funny' %}selected{% endif %}>HÃ i hÆ°á»›c ðŸ˜Ž</option>
        </select>

      </div>
    </div>


      <!-- Chat Messages -->
    <div id="chatMessages" class="flex-1 overflow-y-auto space-y-3 px-4 pt-4 pb-[150px] md:pb-28 custom-scrollbar">
        {% for message in messages %}
        <div class="flex {% if message.is_user %}justify-end{% else %}justify-start{% endif %}">
            <div
                class="{% if message.is_user %}bg-blue-600 text-white rounded-bl-none {% else %}bg-gray-100 text-gray-800 rounded-br-none{% endif %} rounded-2xl px-4 py-2 max-w-[85%] md:max-w-[70%] shadow-sm">
                {{ message.content }}
            </div>
        </div>
        {% endfor %}
    </div>

      <!-- Typing Indicator (moved outside chat messages) -->
    <div id="typingIndicator" class="hidden fixed bottom-[120px] md:bottom-[140px] left-0 right-0 px-4">
        <div class="flex justify-start">
            <div class="bg-white rounded-2xl px-4 py-2 shadow-sm">
                <div class="flex items-center gap-2">
                    <div class="flex gap-1">
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                    </div>
                    <span class="text-sm text-gray-600">MoneyKeeper AI Ä‘ang tráº£ lá»i...</span>
                </div>
            </div>
        </div>
    </div>


    <!-- Fixed bottom container -->
    <div
      class="fixed inset-x-0 bottom-[56px] md:static bg-white border-t border-gray-200 z-50"
    >
      <!-- Quick actions with horizontal scroll -->
      <div
        class="overflow-x-auto flex gap-2 p-2 hide-scrollbar border-b border-gray-100"
      >
       <button
          onclick="askQuestion('PhÃ¢n tÃ­ch chi tiÃªu cá»§a tÃ´i')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          ðŸ“Š PhÃ¢n tÃ­ch chi tiÃªu
        </button>
        <button
          onclick="askQuestion('LÃ m sao Ä‘á»ƒ tiáº¿t kiá»‡m tiá»n')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          ðŸ’° Tiáº¿t kiá»‡m
        </button>
        <button
          onclick="askQuestion('Dá»± Ä‘oÃ¡n chi tiÃªu thÃ¡ng tá»›i')"
          class="whitespace-nowrap bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
        >
          ðŸ”® Dá»± Ä‘oÃ¡n
        </button>
          <!-- New Chat Button -->
        <button onclick="newChatSession()"
          class="whitespace-nowrap bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-green-100 transition-colors">
          + PhiÃªn má»›i
        </button>
      </div>

      <!-- Input form with proper spacing -->
      <form id="chatForm" class="flex items-center gap-2 p-3 bg-white">
        <input
          type="text"
          id="messageInput"
          class="flex-1 border border-gray-300 rounded-full px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Nháº­p tin nháº¯n..."
          autocomplete="off"
        />
        <button
          type="submit"
          class="bg-blue-600 text-white p-2.5 rounded-full hover:bg-blue-700 transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
            />
          </svg>
        </button>
      </form>
    </div>

        <!-- Chat Session List (Dropdown) -->
    <div class="absolute bottom-full right-0 mb-2 w-48 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 overflow-hidden"
        id="sessionList">
        <div class="py-1">
            <button onclick="newChatSession()"
              class="flex w-full items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
              PhiÃªn má»›i
            </button>
            <div class="border-t border-gray-200 my-1"></div>
            {% for s in all_sessions %}
            <a href="#" onclick="switchSession({{ s.id }})"
            class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                PhiÃªn {{ s.id }}  <!-- Basic ID for now; could use a title -->
                <button onclick="deleteSession(event, {{ s.id }})" class="ml-auto text-red-600 hover:text-red-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </a>
            {% endfor %}
        </div>
    </div>
  </div>
</div>

<style>
  /* Improve scrollbar appearance */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px; /* Width of the scrollbar */
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1; /* Track color */
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #888; /* Thumb color */
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #555; /* Thumb color on hover */
  }

  /* Remove rounded corners on opposing sides of message bubbles */
  .user-message {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }

  .ai-message {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
    /* Style for the typing indicator */
    #typingIndicator .animate-bounce {
    animation: bounce 1.2s infinite;
  }
  @keyframes bounce {
      0%,
      100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
      }
      50% {
          transform: translateY(0);
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
      }
  }

    .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

    /* Ensure bottom spacing on mobile */
    @media (max-width: 768px) {
        .fixed.bottom-[70px] {
            bottom: 70px;  /* Space for bottom nav */
            z-index: 50;
        }
        #chatMessages{
            padding-bottom: 160px;
        }
          /* Ensure input is visible on all devices */
        #chatForm {
            padding-bottom: calc(env(safe-area-inset-bottom) + 1rem);
        }
    }

  /* Mobile-specific styles */
    @supports (padding: max(0px)) {
        .pb-safe {
            padding-bottom: max(.5rem, env(safe-area-inset-bottom));
        }
    }

  /* Mobile-specific adjustments */
  @supports (padding: env(safe-area-inset-bottom)) {
    .mb-safe {
      margin-bottom: env(safe-area-inset-bottom);
    }
    @media (max-width: 768px) {
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom);
            bottom: 0;
            margin-bottom: 0;
            background-color: white;
            border-top: 1px solid #e5e7eb;
        }
      #chatMessages {
        margin-bottom: calc(env(safe-area-inset-bottom) + 80px);
      }

    }
  }

    /* Ensure bottom nav doesn't overlap chat input */
    @media (max-width: 768px) {
        .fixed.bottom-0 {
            bottom: calc(env(safe-area-inset-bottom));
        }

        #chatMessages {
            padding-bottom: 120px;
        }
    }

   /* Desktop adjustments */
    @media (min-width: 769px) {
        .fixed.inset-0 {
            position: static;
            height: 85vh;
            margin: 0 auto;
            max-width: 48rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .fixed.bottom-[70px] {
            position: static;
        }
    }

      /* Mobile layout adjustments */
    @media (max-width: 768px) {
        #chatMessages {
            height: calc(100vh - 180px); /* Adjust height to account for header and input */
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
            margin-bottom: 0;
        }

        .fixed.bottom-[56px] {
            bottom: 56px; /* Height of bottom nav */
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
    }

    /* Desktop chat container */
    @media (min-width: 769px) {
        #chatMessages {
            height: calc(85vh - 180px);
            max-height: calc(85vh - 180px);
        }
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      const pageLoader = document.getElementById("pageLoader");
      if (pageLoader) {
        pageLoader.remove();
      }
    });
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const aiPersonality = document.getElementById("aiPersonality");
    const typingIndicator = document.getElementById("typingIndicator");

    let currentSessionId = {{ session.id }}; // Initial session ID

    const socket = io("/chat"); // Connect to the /chat namespace

    // Join room on connect
    socket.on("connect", () => {
      console.log("Connected to websocket");
      joinRoom(currentSessionId);
    });

    // Function to switch to a different chat session
    function switchSession(sessionId) {
        // Leave the current room
        leaveRoom(currentSessionId);

        // Update the current session ID
        currentSessionId = sessionId;

        // Join the new room
        joinRoom(sessionId);

        // Clear current messages
        chatMessages.innerHTML = '';

        // Fetch and display messages for the new session
        fetch(`/api/chat/sessions/${sessionId}/messages`)
        .then(response => response.json())
        .then(data => {
            data.messages.forEach(msg => {
                addMessage(msg.content, msg.user);
            });
            scrollToBottom();
        });
        // Update the selected personality based on new session
        fetch(`/api/chat/sessions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "update", session_id: currentSessionId }),
        })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
              console.log(data)
          }
        });
    }
    function joinRoom(sessionId) {
      socket.emit('join', { room: String(sessionId) });
      console.log(`Joined room: ${sessionId}`);
    }

    function leaveRoom(sessionId) {
        socket.emit('leave', { room: String(sessionId) });
        console.log(`Left room: ${sessionId}`);
    }

    // Handle incoming messages (your messages and AI responses).
    socket.on("message", function (msg) {
      addMessage(msg.data, msg.user);
      scrollToBottom();
    });

    // Sá»­a láº¡i hÃ m xá»­ lÃ½ response
    socket.on("response", function (msg) {
      try {
        if (!msg || !msg.data) {
          console.error("Invalid response message:", msg);
          return;
        }

        // Decode HTML entities náº¿u cáº§n
        const decodedMessage = msg.data
          .replace(/</g, "<")
          .replace(/>/g, ">");

        // ThÃªm message vÃ o UI
        appendResponseMessage(decodedMessage);
        scrollToBottom();

        // Náº¿u Ä‘Ã¢y lÃ  chunk cuá»‘i cÃ¹ng, áº©n typing indicator
        if (msg.done) {
          hideTyping();
        }
      } catch (error) {
        console.error("Error handling response:", error);
        hideTyping();
        addErrorMessage("CÃ³ lá»—i xáº£y ra khi hiá»ƒn thá»‹ tin nháº¯n");
      }
    });

    // Sá»­a láº¡i hÃ m appendResponseMessage
    function appendResponseMessage(messageChunk) {
      let lastMessage = chatMessages.lastElementChild;

      // Náº¿u Ä‘ang cÃ³ typing indicator, láº¥y message trÆ°á»›c Ä‘Ã³
      if (lastMessage && lastMessage.id === "typingIndicator") {
        lastMessage = lastMessage.previousElementSibling;
      }

      // Náº¿u message cuá»‘i cÃ¹ng lÃ  tá»« AI, append vÃ o Ä‘Ã³
      if (lastMessage && !lastMessage.querySelector(".bg-blue-600")) {
        let lastBubble = lastMessage.querySelector("div:last-child");
        if (lastBubble) {
          lastBubble.textContent += messageChunk;
          return;
        }
      }

      // Náº¿u khÃ´ng, táº¡o message má»›i
      addMessage(messageChunk, false);
    }

    // Handle errors from the server
    socket.on("error", function (msg) {
      addErrorMessage(msg.data); // Display error to the user
      hideTyping(); // Hide typing indicator in case of error.
      scrollToBottom();
    });

    // Function to add user messages
    function addMessage(message, isUser) {
      const messageContainer = document.createElement("div");
      messageContainer.classList.add(
        "flex",
        isUser ? "justify-end" : "justify-start",
        "animate__animated",
        "animate__fadeIn"
      );

      const messageBubble = document.createElement("div");
      messageBubble.classList.add(
        isUser ? "bg-blue-600" : "bg-gray-100",  // Use bg-gray-100 for AI
        isUser ? "text-white" : "text-gray-800", // Text color based on sender
        "rounded-2xl",
        "px-4",
        "py-2",
        "max-w-[85%]",
        "md:max-w-[70%]",
        "shadow-sm",
        isUser? "rounded-br-none" : "rounded-bl-none" // Remove the opposite rounded corner
      );

      messageBubble.textContent = message;
      messageContainer.appendChild(messageBubble);
      chatMessages.appendChild(messageContainer);
    }

    // Function to add AI response, appending to the last message if it exists.
    function appendResponseMessage(messageChunk) {
      let lastMessage = chatMessages.lastElementChild;

      // If there's already a message from AI, append to it
      if (lastMessage && !lastMessage.querySelector(".bg-blue-600")) {
        let lastBubble = lastMessage.querySelector("div:last-child");
        if (lastBubble) {
          lastBubble.textContent += messageChunk;
        } else {
          // If no bubble found, create new message
          addMessage(messageChunk, false);
        }
      } else {
        // Create new AI message
        addMessage(messageChunk, false);
      }
    }

    // Function to add error messages to the chat
    function addErrorMessage(message) {
      const messageContainer = document.createElement("div");
      messageContainer.classList.add("flex", "justify-start"); // Error messages on the left

      const messageBubble = document.createElement("div");
      messageBubble.classList.add(
        "bg-red-100",
        "text-red-800",
        "rounded-2xl",
        "px-4",
        "py-2",
        "max-w-[85%]",
        "md:max-w-[70%]",
        "shadow-sm"
      );
      messageBubble.innerText = message;
      messageContainer.appendChild(messageBubble);
      chatMessages.appendChild(messageContainer);
    }

    // Handle form submission.
    document.getElementById("chatForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const message = messageInput.value;
      if (message.trim() !== "") {
        // Don't add message to the UI here, the 'message' event will handle it.
        socket.emit("message", {
          message: message,
          personality: aiPersonality.value,
        });
        messageInput.value = "";
        showTyping();
      }
    });

    function showTyping() {
      // Remove any existing indicator first
      const existingIndicator = document.getElementById("typingIndicator");
      if (existingIndicator) {
        existingIndicator.remove();
      }

      const indicator = document.createElement("div");
      indicator.id = "typingIndicator";
      indicator.classList.add("flex", "justify-start", "mb-4");
      indicator.innerHTML = `
              <div class="bg-white rounded-2xl px-4 py-2 shadow-sm">
                  <div class="flex items-center gap-2">
                      <div class="flex gap-1">
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                          <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                      </div>
                      <span class="text-sm text-gray-600">MoneyKeeper AI Ä‘ang tráº£ lá»i...</span>
                  </div>
              </div>
          `;

      // Find the last user message, or if none, add to the end
      const lastUserMessage = document.querySelector(
        "#chatMessages .flex.justify-end:last-child"
      );

      if (lastUserMessage) {
        // Insert *before* the last user message
        chatMessages.insertBefore(indicator, lastUserMessage.nextSibling);
      } else {
        // If no user messages, add to the end.
        chatMessages.appendChild(indicator);
      }

      scrollToBottom();
    }

    function hideTyping() {
      const existingIndicator = document.getElementById("typingIndicator");
      if (existingIndicator) {
        existingIndicator.remove();
      }
    }

    // Send message on button click (optional, if you have a send button).
    function askQuestion(question) {
      // Don't add message to the UI here, the 'message' event will handle it.
      socket.emit("message", {
        message: question,
        personality: aiPersonality.value,
      });
      showTyping();
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initial scroll on load
    scrollToBottom();

    // --- New Session, Delete Session, and Update Personality ---

    function newChatSession() {
        fetch('/api/chat/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ action: 'new' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.session_id) {
                switchSession(data.session_id);
                // Optionally, refresh the session list
                // fetch('/api/chat/sessions') ...
            }
        });
    }

    function deleteSession(event, sessionId) {
      event.preventDefault();
      event.stopPropagation();
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a phiÃªn trÃ² chuyá»‡n nÃ y?')) {
          fetch('/api/chat/sessions', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ action: 'delete', session_id: sessionId })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Remove the session from the list
                  const sessionElement = event.target.closest('a');
                  if (sessionElement) {
                      sessionElement.remove();
                  }

                  // If the deleted session is the current session, switch to a new one
                  if (currentSessionId === sessionId) {
                      newChatSession(); // Or redirect to a default/recent session
                  }
              }
          });
      }
    }

    function updateSessionPersonality() {
      fetch('/api/chat/sessions', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: "update",
            session_id: currentSessionId,
            personality: aiPersonality.value })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              showToast("ÄÃ£ thay Ä‘á»•i tÃ­nh cÃ¡ch AI.", 'success')
          }
      });
    }
</script>
{% else %}
<div class="text-center py-12">
  <p class="text-lg mb-6 text-gray-700 font-medium">
    Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng chat.
  </p>
  <a
    href="{{ url_for('auth.login') }}"
    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md shadow-md transition-all duration-200 inline-block"
  >
    ÄÄƒng nháº­p
  </a>
</div>
{% endif %}
{% endblock %}

================
File: app/templates/main/edit_expense.html
================
{% extends "base.html" %}
{% block content %}
<div class="animate__animated animate__fadeIn max-w-lg mx-auto">
    <!-- Header Card -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-xl p-6">
        <h1 class="text-2xl font-bold flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Chá»‰nh sá»­a giao dá»‹ch
        </h1>
    </div>

    <!-- Main Form -->
    <div class="bg-white rounded-b-xl shadow-lg p-6">
        <form method="POST" class="space-y-6">
            {{ form.hidden_tag() }}

            <!-- Transaction Type Toggle -->
            <div class="relative mb-6">
                <div class="flex rounded-lg bg-gray-100 p-1">
                    <button type="button" onclick="toggleTransactionType('expense')"
                        class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 expense-toggle {{ 'active' if form.is_expense.data }}">
                        Chi tiÃªu
                    </button>
                    <button type="button" onclick="toggleTransactionType('income')"
                        class="w-1/2 py-3 text-sm font-medium rounded-md transition-colors duration-200 income-toggle {{ 'active' if not form.is_expense.data }}">
                        Thu nháº­p
                    </button>
                </div>
                {{ form.is_expense(class="hidden") }}
            </div>

            <!-- Amount Input -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Sá»‘ tiá»n</label>
                <div class="relative rounded-lg shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500">â‚«</span>
                    </div>
                    {{ form.amount(class="pl-8 pr-12 block w-full text-xl rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 py-4",
                        placeholder="0", inputmode="decimal", pattern="[0-9]*.*[0-9]*", step="any") }}
                </div>
            </div>

            <!-- Quick Amount Buttons -->
            <div class="grid grid-cols-2 gap-2 sm:grid-cols-4">
                <button type="button" onclick="setAmount(20000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    20,000â‚«
                </button>
                <button type="button" onclick="setAmount(50000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    50,000â‚«
                </button>
                <button type="button" onclick="setAmount(100000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    100,000â‚«
                </button>
                <button type="button" onclick="setAmount(200000)"
                    class="amount-btn py-3 text-sm bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors text-center">
                    200,000â‚«
                </button>
            </div>

            <!-- Category Grid -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Danh má»¥c</label>
                <div class="grid grid-cols-3 gap-3 sm:grid-cols-4">
                    {% for value, label in form.category.choices %}
                    <button type="button" onclick="setCategory('{{ value }}')"
                        class="category-btn flex flex-col items-center p-4 rounded-lg border hover:bg-blue-50 transition-all {{ 'bg-blue-50 border-blue-500' if form.category.data == value }}">
                        <span class="text-2xl mb-2">{{ category_icons[value] }}</span>
                        <span class="text-xs">{{ label }}</span>
                    </button>
                    {% endfor %}
                </div>
                {{ form.category(class="hidden") }}
            </div>

            <!-- Description -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Ghi chÃº</label>
                {{ form.description(class="block w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 py-3",
                    rows="3", placeholder="ThÃªm ghi chÃº...", autocapitalize="sentences") }}
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
                <a href="{{ url_for('main.expenses') }}"
                    class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50">
                    Há»§y
                </a>
                {{ form.submit(class="flex-1 py-3 px-4 border border-transparent rounded-lg text-white bg-blue-600 hover:bg-blue-700") }}
            </div>
        </form>
    </div>
</div>

<script>
  function setAmount(amount) {
    document.getElementById("amount").value = amount;
    document.querySelectorAll(".amount-btn").forEach((btn) => {
      btn.classList.remove("bg-blue-100", "text-blue-800");
    });
    event.target.classList.add("bg-blue-100", "text-blue-800");
  }

  function updateCategoryIcon(category) {
    const icons = {
      food: "ðŸœ",
      transport: "ðŸš—",
      shopping: "ðŸ›ï¸",
      entertainment: "ðŸŽ®",
      bills: "ðŸ“„",
      health: "ðŸ’Š",
      other: "ðŸ“",
    };
    document.getElementById("categoryIcon").textContent =
      icons[category] || "ðŸ“";
  }

  // Add input validation
  document.getElementById("amount").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^0-9]/g, "");
    e.target.value = value;
  });

  // Initialize category icon
  document.getElementById("category").addEventListener("change", function (e) {
    updateCategoryIcon(e.target.value);
  });

  // Initialize on load
  document.addEventListener("DOMContentLoaded", function () {
    updateCategoryIcon(document.getElementById("category").value);
  });

  // Format number with commas while typing
  document.getElementById('amount').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
        e.target.value = formatNumber(parseInt(value));
    }
  });

  function toggleTransactionType(type) {
    const isExpense = type === 'expense';
    document.getElementById('is_expense').value = isExpense;
    
    // Toggle active state for buttons
    const expenseBtn = document.querySelector('.expense-toggle');
    const incomeBtn = document.querySelector('.income-toggle');
    
    if (isExpense) {
        expenseBtn.classList.add('bg-blue-100', 'text-blue-800');
        incomeBtn.classList.remove('bg-blue-100', 'text-blue-800');
    } else {
        incomeBtn.classList.add('bg-blue-100', 'text-blue-800');
        expenseBtn.classList.remove('bg-blue-100', 'text-blue-800');
    }
  }

  // Initialize toggle state on page load
  document.addEventListener('DOMContentLoaded', function() {
    const isExpense = document.getElementById('is_expense').value === 'True';
    toggleTransactionType(isExpense ? 'expense' : 'income');
  });

  // Format money with dots
  function formatMoney(input) {
      // Remove existing dots and non-digit characters
      let value = input.replace(/\D/g, '');
      // Format with dots
      return value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Parse money string to number
  function parseMoney(str) {
      return parseInt(str.replace(/\./g, '')) || 0;
  }

  // Add format to amount input
  document.getElementById('amount').addEventListener('input', function(e) {
      let value = formatMoney(e.target.value);
      e.target.value = value;
  });

  // Format initial value
  document.addEventListener('DOMContentLoaded', function() {
      const amountInput = document.getElementById('amount');
      amountInput.value = formatMoney(amountInput.value);
  });

  // Parse before form submit
  document.querySelector('form').addEventListener('submit', function(e) {
      const amountInput = document.getElementById('amount');
      amountInput.value = parseMoney(amountInput.value);
  });
</script>
{% endblock %}

================
File: app/templates/main/edit_wallet.html
================
{% extends "base.html" %} {% block content %}

<!-- Add outer container with padding-bottom for mobile -->
<div class="pb-32 sm:pb-0">  <!-- Added padding-bottom to prevent form cut-off -->
  <div class="animate__animated animate__fadeIn max-w-lg mx-auto">
    <!-- Header Card -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-xl p-4 sm:p-6">
      <h1 class="text-2xl font-bold flex items-center">
        <svg
          class="w-6 h-6 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
          />
        </svg>
        Chá»‰nh sá»­a vÃ­
      </h1>
      <p class="mt-1 text-blue-100">{{ wallet.name }}</p>
    </div>

    <!-- Main Form -->
    <div class="bg-white rounded-b-xl shadow-lg">
      <form method="POST" class="divide-y divide-gray-200">
        <!-- Form Fields Container -->
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
          {{ form.hidden_tag() }}

          <div class="space-y-4">
            <!-- Wallet Name -->
            <div class="space-y-2">
              {{ form.name.label(class="block text-sm font-medium text-gray-700") }}
              {{ form.name(class="mt-1 block w-full rounded-lg border-gray-300
              shadow-sm focus:ring-blue-500 focus:border-blue-500 py-3 text-base") }}
            </div>

            <!-- Balance -->
            <div class="space-y-2">
              {{ form.balance.label(class="block text-sm font-medium text-gray-700")
              }}
              <div class="relative rounded-lg shadow-sm">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <span class="text-gray-500 text-lg">â‚«</span>
                </div>
                {{ form.balance(class="pl-8 block w-full rounded-lg border-gray-300
                focus:ring-blue-500 focus:border-blue-500 py-4 text-lg", placeholder="0",
                inputmode="decimal", pattern="[0-9]*") }}
              </div>
            </div>

            <!-- Description -->
            <div class="space-y-2">
              {{ form.description.label(class="block text-sm font-medium
              text-gray-700") }} {{ form.description(class="mt-1 block w-full
              rounded-lg border-gray-300 shadow-sm focus:ring-blue-500
              focus:border-blue-500", rows="3") }}
            </div>

            <!-- Is Default Toggle -->
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                {{ form.is_default.label(class="block text-sm font-medium
                text-gray-700") }}
                <div class="relative inline-block w-10 mr-2 align-middle">
                  {{ form.is_default(class="mt-1 block rounded-lg border-gray-300
                  shadow-sm focus:ring-blue-500 focus:border-blue-500") }}
                </div>
              </div>
              <p class="text-sm text-gray-500">
                VÃ­ máº·c Ä‘á»‹nh sáº½ Ä‘Æ°á»£c chá»n tá»± Ä‘á»™ng khi thÃªm giao dá»‹ch má»›i
              </p>
            </div>
          </div>
        </div>

        <!-- Action Buttons - Fixed on Mobile -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 sm:relative sm:border-t-0 sm:p-6 sm:bg-transparent">
          <div class="flex gap-3 max-w-lg mx-auto">
            <a href="{{ url_for('main.wallets') }}"
               class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50">
              Há»§y
            </a>
            {{ form.submit(class="flex-1 py-3 px-4 border border-transparent rounded-lg text-white bg-blue-600 hover:bg-blue-700") }}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Format money with dots
function formatMoney(input) {
    // Remove existing dots and non-digit characters
    let value = input.replace(/\D/g, '');
    // Format with dots
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Parse money string to number
function parseMoney(str) {
    return parseInt(str.replace(/\./g, '')) || 0;
}

// Add format to balance input
document.getElementById('balance').addEventListener('input', function(e) {
    let value = formatMoney(e.target.value);
    e.target.value = value;
});

// Format initial value
document.addEventListener('DOMContentLoaded', function() {
    const balanceInput = document.getElementById('balance');
    balanceInput.value = formatMoney(balanceInput.value);
});

// Parse before form submit
document.querySelector('form').addEventListener('submit', function(e) {
    const balanceInput = document.getElementById('balance');
    balanceInput.value = parseMoney(balanceInput.value);
});
</script>
{% endblock %}

================
File: app/templates/main/expenses.html
================
{% extends "base.html" %} {% block content %}
<div class="animate__animated animate__fadeIn">
  <!-- Header Section -->
  <div
    class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl p-6 md:p-8 shadow-lg mb-6"
  >
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
    >
      <div>
        <h1 class="text-2xl md:text-3xl font-bold mb-2">Lá»‹ch sá»­ chi tiÃªu</h1>
        <p class="text-blue-100">
          Theo dÃµi vÃ  quáº£n lÃ½ cÃ¡c khoáº£n chi tiÃªu cá»§a báº¡n
        </p>
      </div>
      <a
        href="{{ url_for('main.add_expense') }}"
        class="inline-flex items-center bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition-colors"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          />
        </svg>
        ThÃªm chi tiÃªu
      </a>
    </div>
  </div>

  <!-- Filters and Actions -->
  <div class="bg-white rounded-xl shadow-md p-4 mb-6">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Category Filter -->
      <div class="col-span-1">
        {{ filter_form.category(class="w-full border border-gray-200 rounded-lg
        px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500") }}
      </div>
      <!-- Date Range (Optional) -->
      <div class="col-span-2 flex gap-4">
        <input
          type="date"
          name="start_date"
          class="flex-1 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        <input
          type="date"
          name="end_date"
          class="flex-1 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>
      <!-- Actions -->
      <div class="col-span-1 flex gap-2">
        <button
          type="submit"
          class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
        >
          Lá»c
        </button>
        <a
          href="{{ url_for('main.export_expenses') }}"
          class="inline-flex items-center justify-center bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
        </a>
      </div>
    </form>
  </div>

  <!-- Expenses List -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    {% if expenses %}
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="text-left p-4 text-sm font-medium text-gray-600">
              NgÃ y
            </th>
            <th class="text-left p-4 text-sm font-medium text-gray-600">
              Danh má»¥c
            </th>
            <th class="text-left p-4 text-sm font-medium text-gray-600">
              MÃ´ táº£
            </th>
            <th class="text-right p-4 text-sm font-medium text-gray-600">
              Sá»‘ tiá»n
            </th>
            <th class="p-4"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for expense in expenses %}
          <tr
            class="hover:bg-gray-50 transition-colors cursor-pointer"
            data-expense-id="{{ expense.id }}"
            ontouchstart="handleTouchStart(event)"
            ontouchend="handleTouchEnd(event)"
          >
            <td class="p-4 text-sm text-gray-600">
              <div>{{ moment(expense.date).format('DD/MM/YYYY') }}</div>
              <div class="text-xs text-gray-400">
                {{ moment(expense.date).fromNow() }}
              </div>
            </td>
            <td class="p-4">
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if expense.category == 'Ä‚n uá»‘ng' %}bg-green-100 text-green-800 {% elif expense.category == 'Di chuyá»ƒn' %}bg-blue-100 text-blue-800 {% elif expense.category == 'Mua sáº¯m' %}bg-purple-100 text-purple-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
              >
                {{ expense.category }}
              </span>
            </td>
            <td class="p-4 text-sm text-gray-600">
              {{ expense.description or "KhÃ´ng cÃ³ mÃ´ táº£" }}
            </td>
            <td
              class="p-4 text-right font-medium {% if expense.amount > 500000 %}text-red-600{% else %}text-gray-900{% endif %}"
            >
              {{ format_currency(expense.amount) }}
            </td>
            <td class="p-4 md:block hidden">
              <!-- Hide on mobile since we'll use double tap -->
              <div class="flex justify-end gap-2">
                <a
                  href="{{ url_for('main.edit_expense', id=expense.id) }}"
                  class="text-gray-400 hover:text-blue-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                    />
                  </svg>
                </a>
                <button
                  onclick="deleteExpense({{ expense.id }})"
                  class="text-gray-400 hover:text-red-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div
      class="flex items-center justify-between px-4 py-3 border-t border-gray-200 bg-gray-50"
    >
      <div class="flex justify-between items-center w-full">
        <div class="text-sm text-gray-700">
          Trang <span class="font-medium">{{ pagination.page }}</span> /
          <span class="font-medium">{{ pagination.pages }}</span>
        </div>
        <div class="flex gap-2">
          {% for page in pagination.iter_pages() %} {% if page %}
          <a
            href="{{ url_for('main.expenses', page=page, **kwargs) }}"
            class="px-3 py-1 rounded-md {% if page == pagination.page %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
          >
            {{ page }}
          </a>
          {% else %}
          <span class="px-3 py-1">...</span>
          {% endif %} {% endfor %}
        </div>
      </div>
    </div>
    {% endif %} {% else %}
    <div class="text-center py-12">
      <svg
        class="mx-auto h-12 w-12 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
        />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">
        ChÆ°a cÃ³ chi tiÃªu nÃ o
      </h3>
      <p class="mt-1 text-sm text-gray-500">
        Báº¯t Ä‘áº§u báº±ng viá»‡c thÃªm chi tiÃªu Ä‘áº§u tiÃªn cá»§a báº¡n.
      </p>
      <div class="mt-6">
        <a
          href="{{ url_for('main.add_expense') }}"
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
          ThÃªm chi tiÃªu
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  let lastTap = 0;
  let tapTimeout;
  const tapDelay = 300; // milliseconds between taps

  function handleTouchStart(event) {
    event.preventDefault(); // Prevent default touch behavior
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;

    clearTimeout(tapTimeout);

    if (tapLength < tapDelay && tapLength > 0) {
      // Double tap detected
      const expenseId = event.currentTarget.dataset.expenseId;
      window.location.href = `/edit_expense/${expenseId}`;
      event.preventDefault();
    } else {
      // Wait for potential second tap
      tapTimeout = setTimeout(() => {
        // Single tap action (optional)
        console.log("Single tap detected");
      }, tapDelay);
    }

    lastTap = currentTime;
  }

  function handleTouchEnd(event) {
    // Prevent default only if it was a double tap
    if (new Date().getTime() - lastTap < tapDelay) {
      event.preventDefault();
    }
  }

  // Add desktop click handler
  document.querySelectorAll("[data-expense-id]").forEach((row) => {
    row.addEventListener("click", (event) => {
      // Only handle click on desktop
      if (window.innerWidth >= 768) {
        const expenseId = event.currentTarget.dataset.expenseId;
        const isActionButton = event.target.closest("button, a");
        if (!isActionButton) {
          window.location.href = `/edit_expense/${expenseId}`;
        }
      }
    });
  });

  // Original delete function
  function deleteExpense(id) {
    event.stopPropagation(); // Prevent row click/tap
    if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khoáº£n chi tiÃªu nÃ y?")) {
      fetch(`/delete_expense/${id}`, {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          }
        });
    }
  }
</script>
{% endblock %}

================
File: app/templates/main/index.html
================
{% extends "base.html" %}
{% block content %}
<div class="animate__animated animate__fadeIn">
  <div class="space-y-8 md:space-y-10">
    <!-- Welcome Section -->
    <div
      class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl p-6 md:p-8 shadow-lg mb-6"
    >
      <div
        class="flex flex-col sm:flex-row items-center sm:items-start sm:justify-between gap-5 md:gap-6"
      >
        <div>
          <h1 class="text-3xl font-bold mb-3">Xin chÃ o! ðŸ‘‹</h1>
          <p class="text-blue-100 text-lg">ChÃ o má»«ng trá»Ÿ láº¡i vá»›i MoneyKeeper</p>
        </div>
        <div class="text-center sm:text-right">
          <p class="text-sm text-blue-200 mb-1">ThÃ¡ng nÃ y</p>
          <p class="text-3xl font-bold">{{ format_currency(total_month) }}</p>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-5 md:gap-6">
      <a
        href="{{ url_for('main.add_expense') }}"
        class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col items-center justify-center text-center space-y-2"
      >
        <div class="bg-green-100 p-4 rounded-full">
          <svg
            class="w-8 h-8 text-green-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
            />
          </svg>
        </div>
        <span class="font-semibold text-gray-800">ThÃªm chi tiÃªu</span>
      </a>
      <a
        href="{{ url_for('main.budgets') }}"
        class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col items-center justify-center text-center space-y-2"
      >
        <div class="bg-purple-100 p-4 rounded-full">
          <svg
            class="w-8 h-8 text-purple-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
        </div>
        <span class="font-semibold text-gray-800">Quáº£n lÃ½ ngÃ¢n sÃ¡ch</span>
      </a>
      <a
        href="{{ url_for('main.chat') }}"
        class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col items-center justify-center text-center space-y-2"
      >
        <div class="bg-blue-100 p-4 rounded-full">
          <svg
            class="w-8 h-8 text-blue-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
            />
          </svg>
        </div>
        <span class="font-semibold text-gray-800">TrÃ² chuyá»‡n vá»›i AI</span>
      </a>
      <a
        href="{{ url_for('main.expenses') }}"
        class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition-shadow flex flex-col items-center justify-center text-center space-y-2"
      >
        <div class="bg-yellow-100 p-4 rounded-full">
          <svg
            class="w-8 h-8 text-yellow-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            />
          </svg>
        </div>
        <span class="font-semibold text-gray-800">Lá»‹ch sá»­ chi tiÃªu</span>
      </a>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
      <!-- Chart and Analysis Section (Full width on mobile) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Chart Card -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
          <h2
            class="text-lg md:text-xl font-semibold mb-4 text-blue-700 flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            Biá»ƒu Ä‘á»“ chi tiÃªu
          </h2>
          <div class="h-[300px] md:h-[400px] relative">
            <canvas id="expenseChart"></canvas>
          </div>
        </div>

        <!-- Analysis Card - Mobile Optimized -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
          <h2 class="text-lg md:text-xl font-semibold mb-4 text-blue-700">
            PhÃ¢n tÃ­ch chi tiÃªu
          </h2>

          <!-- Analysis Grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <!-- Daily Average -->
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-sm text-blue-700 mb-1">
                Chi tiÃªu trung bÃ¬nh/ngÃ y
              </p>
              <p id="dailyAverage" class="text-xl font-semibold text-blue-900">
                <div class="animate-pulse h-4 bg-gray-300 rounded"></div>
              </p>
            </div>

            <!-- Most Expensive Category -->
            <div class="bg-green-50 p-4 rounded-lg">
              <p class="text-sm text-green-700 mb-1">Danh má»¥c chi nhiá»u nháº¥t</p>
              <p
                id="mostExpensiveCategory"
                class="text-xl font-semibold text-green-900"
              >
                <div class="animate-pulse h-4 bg-gray-300 rounded"></div>
              </p>
            </div>

            <!-- Highest Single Expense -->
            <div class="bg-purple-50 p-4 rounded-lg">
              <p class="text-sm text-purple-700 mb-1">Chi tiÃªu lá»›n nháº¥t</p>
              <p id="highestExpense" class="text-xl font-semibold text-purple-900">
                <div class="animate-pulse h-4 bg-gray-300 rounded"></div>
              </p>
            </div>
          </div>

          <!-- Recommendations Section -->
          <div class="mt-6 border-t border-gray-100 pt-4">
            <h3 class="text-base font-medium text-gray-800 mb-3">
              ðŸ’¡ Äá» xuáº¥t cáº£i thiá»‡n
            </h3>
            <ul id="recommendationsList">
                <!-- Initial loading state (optional) -->
              <li class="text-gray-500">Äang táº£i khuyáº¿n nghá»‹...</li>
            </ul>
          </div>

      <!-- Recent Expenses Card -->
      <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-semibold mb-5 text-green-700">
          Chi tiÃªu gáº§n Ä‘Ã¢y
        </h2>
        <div class="space-y-5">
          {% for expense in recent_expenses %}
          <div
            class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors duration-150"
          >
            <div class="flex items-center space-x-4">
              <div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>
              <div>
                <p class="font-medium text-gray-800">{{ expense.category }}</p>
                <p class="text-sm text-gray-500">
                  {{ moment(expense.date).fromNow() }}
                </p>
              </div>
            </div>
            <div class="text-right">
              <p class="font-bold text-gray-900">
                {{ format_currency(expense.amount) }}
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
        <a
          href="{{ url_for('main.expenses') }}"
          class="mt-5 block text-center text-blue-600 hover:text-blue-800 transition-colors duration-200 font-medium"
        >
          Xem táº¥t cáº£ â†’
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        const chartData = {{ chart_data|safe }};

        // Check if we have data to display
        if (chartData.labels.length === 0) {
            // Show "No data" message if there's no data
            const noDataText = ctx.canvas.getContext('2d');
            noDataText.font = '16px Inter';
            noDataText.fillStyle = '#666';
            noDataText.textAlign = 'center';
            noDataText.fillText('ChÆ°a cÃ³ dá»¯ liá»‡u chi tiÃªu', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartData.labels,
                datasets: [{
                    data: chartData.values,
                    backgroundColor: [
                        '#3B82F6',  // blue
                        '#10B981',  // green
                        '#F59E0B',  // yellow
                        '#EF4444',  // red
                        '#8B5CF6', // purple
                        '#EC4899',  // pink
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                family: 'Inter',
                                size: 12
                            },
                            padding: 20,
                            usePointStyle: true,
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                const formattedValue = new Intl.NumberFormat('vi-VN', {
                                    style: 'currency',
                                    currency: 'VND'
                                }).format(value);
                                return `${context.label}: ${formattedValue} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%',
                radius: '90%',
            }
        });
    });

</script>
{% endblock %}

================
File: app/templates/main/landing.html
================
{% extends "layouts/landing.html" %}
{% block content %}
<div class="landing-content">
  <!-- Hero Section -->
  <div class="relative overflow-hidden">
    <div class="max-w-7xl mx-auto">
      <div
        class="relative z-10 pb-8 bg-gray-50 sm:pb-16 md:pb-20 lg:max-w-2xl lg:w-full lg:pb-28 xl:pb-32"
      >
        <main
          class="mt-10 mx-auto max-w-7xl px-4 sm:mt-12 sm:px-6 lg:mt-16 lg:px-8 xl:mt-20"
        >
          <div class="sm:text-center lg:text-left">
            <h1
              class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl"
            >
              <span class="block">Quáº£n lÃ½ chi tiÃªu</span>
              <span class="block text-green-600">thÃ´ng minh hÆ¡n</span>
            </h1>
            <p
              class="mt-3 text-base text-gray-500 sm:mt-5 sm:text-lg sm:max-w-xl sm:mx-auto md:mt-5 md:text-xl lg:mx-0"
            >
              Money Keeper giÃºp báº¡n theo dÃµi chi tiÃªu, láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch vÃ 
              Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu tÃ i chÃ­nh cá»§a mÃ¬nh má»™t cÃ¡ch dá»… dÃ ng.
            </p>
            <div
              class="mt-5 sm:mt-8 sm:flex sm:justify-center lg:justify-start"
            >
              <div class="rounded-md shadow">
                <a
                  href="{{ url_for('auth.register') }}"
                  class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 md:py-4 md:text-lg md:px-10"
                >
                  Báº¯t Ä‘áº§u miá»…n phÃ­
                </a>
              </div>
              <div class="mt-3 sm:mt-0 sm:ml-3">
                <a
                  href="{{ url_for('auth.login') }}"
                  class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 md:py-4 md:text-lg md:px-10"
                >
                  ÄÄƒng nháº­p
                </a>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Features Section -->
  <div class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          TÃ­nh nÄƒng
        </h2>
        <p
          class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl"
        >
          Quáº£n lÃ½ tÃ i chÃ­nh dá»… dÃ ng hÆ¡n
        </p>
      </div>

      <div class="mt-10">
        <div class="grid grid-cols-1 gap-10 sm:grid-cols-2 lg:grid-cols-3">
          <!-- Feature 1 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Theo dÃµi chi tiÃªu
            </h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Ghi chÃ©p vÃ  phÃ¢n loáº¡i chi tiÃªu hÃ ng ngÃ y má»™t cÃ¡ch dá»… dÃ ng
            </p>
          </div>

          <!-- Feature 2 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch
            </h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Thiáº¿t láº­p vÃ  theo dÃµi ngÃ¢n sÃ¡ch cho tá»«ng danh má»¥c chi tiÃªu
            </p>
          </div>

          <!-- Feature 3 -->
          <div class="flex flex-col items-center">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                />
              </svg>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">Trá»£ lÃ½ AI</h3>
            <p class="mt-2 text-base text-gray-500 text-center">
              Nháº­n tÆ° váº¥n vÃ  phÃ¢n tÃ­ch tÃ i chÃ­nh thÃ´ng minh tá»« AI
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Benefits Section -->
  <div class="bg-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          Lá»£i Ã­ch
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Táº¡i sao chá»n Money Keeper?
        </p>
      </div>
      <div class="mt-12 grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Benefit 1: Easy to Use -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Dá»… dÃ ng sá»­ dá»¥ng
          </h3>
          <p class="mt-2 text-base text-gray-500">
            Giao diá»‡n thÃ¢n thiá»‡n, thao tÃ¡c Ä‘Æ¡n giáº£n, phÃ¹ há»£p má»i Ä‘á»‘i tÆ°á»£ng ngÆ°á»i
            dÃ¹ng
          </p>
        </div>

        <!-- Benefit 2: Smart Analysis -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            PhÃ¢n tÃ­ch thÃ´ng minh
          </h3>
          <p class="mt-2 text-base text-gray-500">
            BÃ¡o cÃ¡o chi tiáº¿t, biá»ƒu Ä‘á»“ trá»±c quan vÃ  dá»± Ä‘oÃ¡n xu hÆ°á»›ng chi tiÃªu
          </p>
        </div>

        <!-- Benefit 3: Security -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Báº£o máº­t tuyá»‡t Ä‘á»‘i
          </h3>
          <p class="mt-2 text-base text-gray-500">
            MÃ£ hÃ³a dá»¯ liá»‡u, xÃ¡c thá»±c hai lá»›p vÃ  báº£o vá»‡ thÃ´ng tin cÃ¡ nhÃ¢n
          </p>
        </div>

        <!-- Benefit 4: AI Assistant -->
        <div class="text-center">
          <div
            class="flex items-center justify-center h-16 w-16 mx-auto bg-green-100 rounded-full"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h3 class="mt-4 text-lg font-medium text-gray-900">
            Trá»£ lÃ½ thÃ´ng minh
          </h3>
          <p class="mt-2 text-base text-gray-500">
            TÆ° váº¥n tÃ i chÃ­nh cÃ¡ nhÃ¢n hÃ³a vÃ  gá»£i Ã½ tiáº¿t kiá»‡m tá»« AI
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="bg-green-700">
    <div class="max-w-7xl mx-auto py-12 px-4 sm:py-16 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 gap-8 sm:grid-cols-3 text-center">
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">1,000+</p>
          <p class="mt-2 text-lg text-green-100">NgÆ°á»i dÃ¹ng tin tÆ°á»Ÿng</p>
        </div>
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">100M+</p>
          <p class="mt-2 text-lg text-green-100">Giao dá»‹ch Ä‘Æ°á»£c ghi nháº­n</p>
        </div>
        <div class="bg-green-800 rounded-lg p-8">
          <p class="text-4xl font-extrabold text-white">4.8/5</p>
          <p class="mt-2 text-lg text-green-100">ÄÃ¡nh giÃ¡ tá»« ngÆ°á»i dÃ¹ng</p>
        </div>
      </div>
    </div>
  </div>

  <!-- How It Works Section -->
  <div class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          HÆ°á»›ng dáº«n
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Báº¯t Ä‘áº§u trong 3 bÆ°á»›c Ä‘Æ¡n giáº£n
        </p>
      </div>
      <div class="mt-12">
        <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
          <!-- Step 1 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">1</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              ÄÄƒng kÃ½ tÃ i khoáº£n
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Táº¡o tÃ i khoáº£n miá»…n phÃ­ vÃ  thiáº¿t láº­p mÃ£ PIN Ä‘á»ƒ báº£o vá»‡ thÃ´ng tin cá»§a
              báº¡n
            </p>
          </div>

          <!-- Step 2 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">2</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Nháº­p thÃ´ng tin chi tiÃªu
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Ghi láº¡i cÃ¡c khoáº£n chi tiÃªu hÃ ng ngÃ y vÃ  phÃ¢n loáº¡i theo danh má»¥c
            </p>
          </div>

          <!-- Step 3 -->
          <div class="relative">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-md bg-green-500 text-white"
            >
              <span class="text-lg font-bold">3</span>
            </div>
            <h3 class="mt-4 text-lg font-medium text-gray-900">
              Theo dÃµi vÃ  phÃ¢n tÃ­ch
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Xem bÃ¡o cÃ¡o chi tiáº¿t vÃ  nháº­n tÆ° váº¥n tá»« trá»£ lÃ½ AI Ä‘á»ƒ quáº£n lÃ½ tÃ i
              chÃ­nh tá»‘t hÆ¡n
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Testimonials Section -->
  <div class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          ÄÃ¡nh giÃ¡
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          NgÆ°á»i dÃ¹ng nÃ³i gÃ¬ vá» chÃºng tÃ´i
        </p>
      </div>
      <div class="mt-12 grid gap-8 md:grid-cols-3">
        <!-- Testimonial 1 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Tran+Minh+Duc"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">HÃ²n Minh Äá»©c</h4>
              <p class="text-gray-500">Káº¿ toÃ¡n viÃªn</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "LÃ  má»™t káº¿ toÃ¡n viÃªn, tÃ´i ráº¥t áº¥n tÆ°á»£ng vá»›i tÃ­nh nÄƒng phÃ¢n loáº¡i chi
            tiÃªu tá»± Ä‘á»™ng vÃ  bÃ¡o cÃ¡o chi tiáº¿t. Money Keeper giÃºp tÃ´i theo dÃµi tÃ i
            chÃ­nh cÃ¡ nhÃ¢n hiá»‡u quáº£ hÆ¡n nhiá»u."
          </p>
        </div>

        <!-- Testimonial 2 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Nguyen+Thu+Ha"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">Nguyá»…n Thu HÃ </h4>
              <p class="text-gray-500">Sinh viÃªn</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "á»¨ng dá»¥ng ráº¥t phÃ¹ há»£p vá»›i sinh viÃªn nhÆ° mÃ¬nh. Giao diá»‡n Ä‘áº¹p, dá»… sá»­
            dá»¥ng vÃ  Ä‘áº·c biá»‡t lÃ  tÃ­nh nÄƒng nháº¯c nhá»Ÿ chi tiÃªu ráº¥t há»¯u Ã­ch!"
          </p>
        </div>

        <!-- Testimonial 3 -->
        <div
          class="bg-gray-50 p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"
        >
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <img
                class="h-12 w-12 rounded-full"
                src="https://ui-avatars.com/api/?name=Le+Van+Tuan"
                alt="Avatar"
              />
            </div>
            <div class="ml-4">
              <h4 class="text-lg font-bold text-gray-900">LÃª VÄƒn Tuáº¥n</h4>
              <p class="text-gray-500">Chá»§ doanh nghiá»‡p</p>
            </div>
          </div>
          <p class="mt-4 text-gray-600">
            "Trá»£ lÃ½ AI cá»§a Money Keeper Ä‘Æ°a ra nhá»¯ng gá»£i Ã½ tÃ i chÃ­nh ráº¥t há»¯u
            Ã­ch. TÃ´i Ä‘Ã£ tiáº¿t kiá»‡m Ä‘Æ°á»£c nhiá»u hÆ¡n tá»« khi sá»­ dá»¥ng á»©ng dá»¥ng nÃ y."
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ Section -->
  <div class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2
          class="text-base text-green-600 font-semibold tracking-wide uppercase"
        >
          CÃ¢u há»i thÆ°á»ng gáº·p
        </h2>
        <p class="mt-2 text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Giáº£i Ä‘Ã¡p tháº¯c máº¯c cá»§a báº¡n
        </p>
      </div>
      <div class="mt-12 max-w-3xl mx-auto">
        <div class="space-y-4">
          <!-- FAQ 1 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Money Keeper cÃ³ tÃ­nh phÃ­ khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Money Keeper hoÃ n toÃ n miá»…n phÃ­ cho ngÆ°á»i dÃ¹ng cÃ¡ nhÃ¢n vá»›i Ä‘áº§y Ä‘á»§
              tÃ­nh nÄƒng cÆ¡ báº£n. ChÃºng tÃ´i khÃ´ng cÃ³ phÃ­ áº©n hay yÃªu cáº§u thanh toÃ¡n
              báº¥t ngá».
            </p>
          </div>

          <!-- FAQ 2 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Dá»¯ liá»‡u cá»§a tÃ´i cÃ³ Ä‘Æ°á»£c báº£o máº­t khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              ChÃºng tÃ´i Ã¡p dá»¥ng cÃ¡c biá»‡n phÃ¡p báº£o máº­t cao cáº¥p Ä‘á»ƒ báº£o vá»‡ thÃ´ng
              tin cá»§a báº¡n. Dá»¯ liá»‡u Ä‘Æ°á»£c mÃ£ hÃ³a vÃ  chá»‰ báº¡n má»›i cÃ³ quyá»n truy cáº­p
              vÃ o tÃ i khoáº£n cá»§a mÃ¬nh.
            </p>
          </div>

          <!-- FAQ 3 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              LÃ m tháº¿ nÃ o Ä‘á»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Chá»‰ cáº§n Ä‘Äƒng kÃ½ tÃ i khoáº£n miá»…n phÃ­, thiáº¿t láº­p mÃ£ PIN vÃ  báº¡n cÃ³ thá»ƒ
              báº¯t Ä‘áº§u sá»­ dá»¥ng ngay. ChÃºng tÃ´i cÃ³ hÆ°á»›ng dáº«n chi tiáº¿t vÃ  Ä‘á»™i ngÅ©
              há»— trá»£ sáºµn sÃ ng giÃºp Ä‘á»¡ báº¡n.
            </p>
          </div>

          <!-- FAQ 4 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              TÃ´i cÃ³ thá»ƒ xuáº¥t bÃ¡o cÃ¡o chi tiÃªu khÃ´ng?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              CÃ³, báº¡n cÃ³ thá»ƒ xuáº¥t bÃ¡o cÃ¡o chi tiáº¿t theo nhiá»u Ä‘á»‹nh dáº¡ng khÃ¡c
              nhau (PDF, Excel). BÃ¡o cÃ¡o bao gá»“m thá»‘ng kÃª, biá»ƒu Ä‘á»“ vÃ  phÃ¢n tÃ­ch
              chi tiÃªu cá»§a báº¡n.
            </p>
          </div>

          <!-- FAQ 5 -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900">
              Trá»£ lÃ½ AI hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?
            </h3>
            <p class="mt-2 text-base text-gray-500">
              Trá»£ lÃ½ AI phÃ¢n tÃ­ch máº«u chi tiÃªu cá»§a báº¡n vÃ  Ä‘Æ°a ra cÃ¡c gá»£i Ã½ cÃ¡
              nhÃ¢n hÃ³a Ä‘á»ƒ giÃºp báº¡n tiáº¿t kiá»‡m hiá»‡u quáº£ hÆ¡n. AI cÅ©ng cÃ³ thá»ƒ tráº£
              lá»i cÃ¡c cÃ¢u há»i vá» tÃ i chÃ­nh vÃ  Ä‘Æ°a ra lá»i khuyÃªn phÃ¹ há»£p.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced CTA Section -->
  <div class="bg-green-700">
    <div
      class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:py-16 lg:px-8 lg:flex lg:items-center lg:justify-between"
    >
      <h2 class="text-3xl font-extrabold tracking-tight text-white sm:text-4xl">
        <span class="block">Sáºµn sÃ ng quáº£n lÃ½ tÃ i chÃ­nh thÃ´ng minh?</span>
        <span class="block text-green-200"
          >Báº¯t Ä‘áº§u sá»­ dá»¥ng Money Keeper ngay hÃ´m nay.</span
        >
      </h2>
      <div class="mt-8 flex lg:mt-0 lg:flex-shrink-0">
        <div class="inline-flex rounded-md shadow">
          <a
            href="{{ url_for('auth.register') }}"
            class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-green-700 bg-white hover:bg-green-50"
          >
            ÄÄƒng kÃ½ miá»…n phÃ­
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/main/notifications.html
================
{% extends "base.html" %} {% block content %}
<div class="animate__animated animate__fadeIn">
  <div class="max-w-3xl mx-auto">
    <div
      class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-t-xl overflow-hidden"
    >
      <div class="p-5 md:p-6 border-b border-blue-800">
        <h2
          class="text-xl md:text-2xl font-semibold text-white flex items-center"
        >
          <svg
            class="w-6 h-6 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
            />
          </svg>
          ThÃ´ng bÃ¡o
        </h2>
      </div>
    </div>

    <div class="bg-white rounded-b-xl shadow-md overflow-hidden">
      {% if notifications.items %}
      <ul class="divide-y divide-gray-100">
        {% for notification in notifications.items %}
        <li
          id="notification-{{ notification.id }}"
          class="px-5 py-4 md:py-5 {% if not notification.is_read %}bg-blue-50{% endif %} transition-all duration-200 hover:bg-gray-50"
        >
          <div class="flex justify-between items-start">
            <div class="pr-6">
              <p class="text-gray-800 font-medium">
                {{ notification.message }}
              </p>
              <p class="text-sm text-gray-500 mt-1">
                {{ moment(notification.created_at).fromNow() }}
              </p>
            </div>
            {% if not notification.is_read %}
            <button
              onclick="markAsRead({{ notification.id }})"
              class="text-sm text-blue-600 hover:text-blue-800 transition-colors duration-200"
            >
              ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c
            </button>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>

      {% include "includes/pagination.html" %} {% else %}
      <div class="p-8 md:p-12 text-center">
        <div class="max-w-sm mx-auto">
          <svg
            class="w-16 h-16 mx-auto text-gray-400 mb-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
            />
          </svg>
          <p class="mt-4 text-gray-600 font-medium">KhÃ´ng cÃ³ thÃ´ng bÃ¡o má»›i.</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  async function markAsRead(id) {
    try {
      const response = await fetch(`/notifications/mark_read/${id}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        const notification = document.getElementById(`notification-${id}`);
        notification.classList.remove("bg-blue-50");
        notification.querySelector("button").remove();
      }
    } catch (error) {
      console.error("Error marking notification as read:", error);
    }
  }

  // Check for new budget alerts periodically
  setInterval(async () => {
    try {
      const response = await fetch("/check_budget_alerts");
      const data = await response.json();

      if (data.alerts && data.alerts.length > 0) {
        data.alerts.forEach((alert) => {
          showToast(alert, "warning");
        });
      }
    } catch (error) {
      console.error("Error checking budget alerts:", error);
    }
  }, 300000); // Check every 5 minutes
</script>
{% endblock %}

================
File: app/templates/main/settings.html
================
{% extends "base.html" %} {% block content %}
<div class="animate__animated animate__fadeIn">
  <div class="w-full max-w-lg mx-auto px-4 sm:px-0">
    <!-- Settings Header -->
    <div
      class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-xl p-4 sm:p-6"
    >
      <h1 class="text-xl sm:text-2xl font-bold flex items-center">
        <svg
          class="w-5 h-5 sm:w-6 sm:h-6 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
        CÃ i Ä‘áº·t tÃ i khoáº£n
      </h1>
      <p class="mt-1 text-blue-100 text-sm sm:text-base">
        Quáº£n lÃ½ thÃ´ng tin tÃ i khoáº£n cá»§a báº¡n
      </p>
    </div>

    <!-- Main Settings Card -->
    <div class="bg-white rounded-b-xl shadow-lg p-4 sm:p-6 mb-16 sm:mb-0">
      <div class="space-y-6">
        <!-- Change Password Section -->
        <section class="space-y-4">
          <h3 class="text-base sm:text-lg font-semibold text-gray-800">
            Äá»•i máº­t kháº©u
          </h3>
          <form
            method="POST"
            action="{{ url_for('settings.change_password') }}"
            class="space-y-4"
          >
            {{ form_password.hidden_tag() }}
            <div class="space-y-2">
              {{ form_password.current_password.label(class="block text-sm
              font-medium text-gray-700") }} {{
              form_password.current_password(class="shadow appearance-none
              border rounded-md w-full py-2 px-3 text-gray-700 leading-tight
              focus:outline-none focus:shadow-outline border-gray-300
              focus:ring-blue-500 focus:border-blue-500") }} {% for error in
              form_password.current_password.errors %}
              <p class="text-red-500 text-xs italic">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="space-y-2">
              {{ form_password.new_password.label(class="block text-sm
              font-medium text-gray-700") }} {{
              form_password.new_password(class="shadow appearance-none border
              rounded-md w-full py-2 px-3 text-gray-700 leading-tight
              focus:outline-none focus:shadow-outline border-gray-300
              focus:ring-blue-500 focus:border-blue-500") }} {% for error in
              form_password.new_password.errors %}
              <p class="text-red-500 text-xs italic">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="space-y-2">
              {{ form_password.confirm_new_password.label(class="block text-sm
              font-medium text-gray-700") }} {{
              form_password.confirm_new_password(class="shadow appearance-none
              border rounded-md w-full py-2 px-3 text-gray-700 leading-tight
              focus:outline-none focus:shadow-outline border-gray-300
              focus:ring-blue-500 focus:border-blue-500") }} {% for error in
              form_password.confirm_new_password.errors %}
              <p class="text-red-500 text-xs italic">{{ error }}</p>
              {% endfor %}
            </div>

            <div class="pt-2">
              <button
                type="submit"
                class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Äá»•i máº­t kháº©u
              </button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
</div>
{% endblock %}

================
File: app/templates/main/wallets.html
================
{% extends "base.html" %} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">VÃ­ cá»§a tÃ´i</h1>
    <p class="mt-1 text-sm text-gray-500">
      Quáº£n lÃ½ cÃ¡c vÃ­ tiá»n vÃ  theo dÃµi sá»‘ dÆ°
    </p>
  </div>

  <!-- Total Balance Card - Full width on mobile -->
  <div
    class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg p-4 sm:p-6 mx-4 sm:mx-0 mb-6"
  >
    <p class="text-blue-100 text-sm font-medium">Tá»•ng sá»‘ dÆ°</p>
    <p class="text-white text-3xl font-bold mt-1">
      {{ "{:,.0f}".format(wallets|sum(attribute='balance')) }}â‚«
    </p>
    <p class="text-blue-100 text-sm mt-2">{{ wallets|length }} vÃ­</p>
  </div>

  <!-- Wallets Grid - 1 column on mobile -->
  <div class="grid gap-4 sm:gap-6 px-4 sm:px-0 pb-20 sm:pb-0">
    {% for wallet in wallets %}
    <div
      class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow"
    >
      <div class="p-4 sm:p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <span class="text-2xl">ðŸ’¼</span>
            <h3 class="text-lg font-semibold text-gray-900">
              {{ wallet.name }}
            </h3>
          </div>
          {% if wallet.is_default %}
          <span
            class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded"
            >Máº·c Ä‘á»‹nh</span
          >
          {% endif %}
        </div>

        <div class="mb-4">
          <p class="text-sm text-gray-500 mb-1">Sá»‘ dÆ° hiá»‡n táº¡i</p>
          <p class="text-2xl font-bold text-gray-900">
            {{ "{:,.0f}".format(wallet.balance) }}â‚«
          </p>
        </div>

        {% if wallet.description %}
        <p class="text-sm text-gray-500 mb-4">{{ wallet.description }}</p>
        {% endif %}

        <!-- Actions -->
        <div
          class="flex items-center justify-end space-x-3 border-t border-gray-100 pt-4"
        >
          <a
            href="{{ url_for('main.edit_wallet', id=wallet.id) }}"
            class="text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors"
          >
            Chá»‰nh sá»­a
          </a>
          {% if not wallet.is_default %}
          <form
            action="{{ url_for('main.delete_wallet', id=wallet.id) }}"
            method="POST"
            class="inline"
            onsubmit="return confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a vÃ­ nÃ y?');"
          >
            <button
              type="submit"
              class="text-sm font-medium text-red-600 hover:text-red-700 transition-colors"
            >
              XÃ³a
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Add New Wallet Button - Floating on mobile -->
    <button
      onclick="showAddWalletModal()"
      class="fixed bottom-4 right-4 sm:relative sm:bottom-auto sm:right-auto bg-blue-600 text-white rounded-full p-4 sm:bg-gray-50 sm:text-gray-600 sm:rounded-xl sm:p-6 shadow-lg sm:shadow-none hover:shadow-xl transition-all sm:border-2 sm:border-dashed sm:border-gray-300 sm:hover:border-blue-500"
    >
      <svg
        class="w-6 h-6 sm:hidden"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6v6m0 0v6m0-6h6m-6 0H6"
        />
      </svg>
      <div
        class="hidden sm:flex sm:flex-col sm:items-center sm:justify-center sm:min-h-[200px]"
      >
        <div
          class="rounded-full bg-gray-100 p-3 group-hover:bg-blue-100 transition-colors"
        >
          <svg
            class="w-6 h-6 text-gray-400 group-hover:text-blue-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6v6m0 0v6m0-6h6m-6 0H6"
            />
          </svg>
        </div>
        <span
          class="mt-2 block text-sm font-medium text-gray-600 group-hover:text-blue-600"
        >
          ThÃªm vÃ­ má»›i
        </span>
      </div>
    </button>
  </div>
</div>

<!-- Add Wallet Modal - Full screen on mobile -->
<div
  id="addWalletModal"
  class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 z-50"
>
  <div class="w-full h-full sm:h-auto sm:max-w-md mx-auto sm:mt-16">
    <div class="bg-white h-full sm:h-auto sm:rounded-xl overflow-hidden">
      <div class="bg-blue-600 p-6">
        <h3 class="text-xl font-semibold text-white">ThÃªm vÃ­ má»›i</h3>
      </div>

      <form
        method="POST"
        action="{{ url_for('main.add_wallet') }}"
        class="p-6 space-y-4"
      >
        {{ form.hidden_tag() }}

        <div class="space-y-2">
          {{ form.name.label(class="block text-sm font-medium text-gray-700") }}
          {{ form.name(class="mt-1 block w-full rounded-lg border-gray-300
          shadow-sm focus:ring-blue-500 focus:border-blue-500") }}
        </div>

        <div class="space-y-2">
          {{ form.balance.label(class="block text-sm font-medium text-gray-700")
          }}
          <div class="relative rounded-lg shadow-sm">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <span class="text-gray-500">â‚«</span>
            </div>
            {{ form.balance(class="pl-7 block w-full rounded-lg border-gray-300
            focus:ring-blue-500 focus:border-blue-500", placeholder="0",
            inputmode="decimal", pattern="[0-9]*") }}
          </div>
        </div>

        <div class="space-y-2">
          {{ form.description.label(class="block text-sm font-medium
          text-gray-700") }} {{ form.description(class="mt-1 block w-full
          rounded-lg border-gray-300 shadow-sm focus:ring-blue-500
          focus:border-blue-500", rows="3") }}
        </div>

        <div class="space-y-2">
          {{ form.is_default.label(class="block text-sm font-medium
          text-gray-700") }} {{ form.is_default(class="mt-1 block w-full
          rounded-lg border-gray-300 shadow-sm focus:ring-blue-500
          focus:border-blue-500") }}
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t">
          <button
            type="button"
            onclick="hideAddWalletModal()"
            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Há»§y
          </button>
          {{ form.submit(class="px-4 py-2 border border-transparent rounded-lg
          text-sm font-medium text-white bg-blue-600 hover:bg-blue-700
          focus:outline-none focus:ring-2 focus:ring-offset-2
          focus:ring-blue-500") }}
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function showAddWalletModal() {
    document.getElementById("addWalletModal").classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function hideAddWalletModal() {
    document.getElementById("addWalletModal").classList.add("hidden");
    document.body.style.overflow = "";
  }

  // Format currency input
  document.getElementById("balance").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^\d]/g, "");
    if (value) {
      e.target.value = new Intl.NumberFormat("vi-VN").format(parseInt(value));
    }
  });

  // Close modal when clicking outside
  document
    .getElementById("addWalletModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        hideAddWalletModal();
      }
    });
</script>
{% endblock %}

================
File: app/utils.py
================
from datetime import datetime, timedelta

def format_currency(amount):
    """Format amount to VND currency"""
    return f"{amount:,.0f} â‚«"

def get_date_range(range_type='month'):
    """Get date range for statistics"""
    today = datetime.utcnow()
    if range_type == 'week':
        start_date = today - timedelta(days=today.weekday())
    elif range_type == 'month':
        start_date = today.replace(day=1)
    elif range_type == 'year':
        start_date = today.replace(month=1, day=1)
    else:
        start_date = today
    
    start_date = start_date.replace(hour=0, minute=0, second=0, microsecond=0)
    return start_date, today

def calculate_statistics(expenses, start_date, end_date):
    """Calculate expense statistics for a date range"""
    filtered_expenses = [e for e in expenses if start_date <= e.date <= end_date]
    
    total = sum(e.amount for e in filtered_expenses)
    by_category = {}
    
    for expense in filtered_expenses:
        if expense.category in by_category:
            by_category[expense.category] += expense.amount
        else:
            by_category[expense.category] = expense.amount
    
    return {
        'total': total,
        'by_category': by_category,
        'count': len(filtered_expenses)
    }

================
File: app/utils/__init__.py
================
from datetime import datetime, timedelta, date
from typing import Tuple


def format_currency(amount: float) -> str:
    return f"{amount:,.0f}Ä‘"


def get_date_range(range_type: str) -> Tuple[datetime, datetime]:
    today = date.today()

    if range_type == "week":
        start_date = today - timedelta(days=today.weekday())
        end_date = start_date + timedelta(days=6)
    elif range_type == "month":
        start_date = today.replace(day=1)
        if today.month == 12:
            end_date = today.replace(year=today.year + 1, month=1, day=1) - timedelta(
                days=1
            )
        else:
            end_date = today.replace(month=today.month + 1, day=1) - timedelta(days=1)
    elif range_type == "year":
        start_date = today.replace(month=1, day=1)
        end_date = today.replace(month=12, day=31)
    else:
        start_date = today - timedelta(days=30)
        end_date = today

    return datetime.combine(start_date, datetime.min.time()), datetime.combine(
        end_date, datetime.max.time()
    )


def calculate_statistics(
    expenses: list, start_date: datetime, end_date: datetime
) -> dict:
    filtered_expenses = [e for e in expenses if start_date <= e.date <= end_date]

    total = sum(e.amount for e in filtered_expenses)
    by_category = {}

    for expense in filtered_expenses:
        if expense.category not in by_category:
            by_category[expense.category] = 0
        by_category[expense.category] += expense.amount

    return {"total": total, "count": len(filtered_expenses), "by_category": by_category}

================
File: app/utils/currency.py
================
def convert_vietnamese_currency(amount_str: str, unit: str = None) -> int:
    """Convert Vietnamese currency string to integer value."""
    try:
        amount_str = amount_str.strip().replace(",", "").replace(".", "")
        amount = float(amount_str)

        if not unit:
            return int(amount)

        unit = unit.lower().strip()

        if unit in ["k", "nghÃ¬n", "ngÃ n"]:
            return int(amount * 1000)

        if unit in ["tr", "triá»‡u"]:
            return int(amount * 1000000)

        if unit in ["tá»·", "ty"]:
            return int(amount * 1000000000)

        if unit in ["Ä‘", "d", "Ä‘á»“ng", "vnd", "vnÄ‘"]:
            return int(amount)

        return int(amount)

    except (ValueError, TypeError) as e:
        raise ValueError(f"Invalid currency format: {amount_str} {unit}") from e

================
File: app/utils/email.py
================
# app/utils/email.py
from flask import current_app
from flask_mail import Message
from threading import Thread
from flask import render_template
import logging

logger = logging.getLogger(__name__)


def send_async_email(app, msg):
    with app.app_context():
        try:
            mail = app.extensions.get("mail")
            if mail:
                mail.send(msg)
            else:
                logger.error("Mail extension not initialized")  # Use logger
        except Exception as e:
            logger.exception(f"Error sending email: {e}")  # Use logger with traceback


def send_email(subject, recipient, template, **kwargs):
    try:
        app = current_app._get_current_object()
        msg = Message(
            subject=f"Money Keeper - {subject}",
            recipients=[recipient],
            sender=app.config["MAIL_DEFAULT_SENDER"],
        )
        msg.html = render_template(f"email/{template}.html", **kwargs)

        Thread(target=send_async_email, args=(app, msg)).start()
        return True
    except Exception as e:
        logger.exception(f"Error preparing email: {e}")  # Use logger, include traceback
        return False

================
File: app/utils/export.py
================
import pandas as pd
from io import BytesIO
from datetime import datetime


def export_expenses_to_excel(expenses):
    output = BytesIO()

    # Convert expenses to DataFrame
    data = [
        {
            "NgÃ y": expense.date,
            "Danh má»¥c": expense.category,
            "MÃ´ táº£": expense.description,
            "Sá»‘ tiá»n": expense.amount,
            "VÃ­": expense.wallet.name,  # Include wallet name
        }
        for expense in expenses
    ]

    df = pd.DataFrame(data)

    # Create Excel writer
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        df.to_excel(writer, sheet_name="Chi tiÃªu", index=False)

        # Get workbook and worksheet
        workbook = writer.book
        worksheet = writer.sheets["Chi tiÃªu"]

        # Add formats
        money_format = workbook.add_format({"num_format": "#,##0 â‚«"})
        date_format = workbook.add_format({"num_format": "dd/mm/yyyy hh:mm"})

        # Set column formats and widths
        worksheet.set_column("A:A", 18, date_format)  # Date
        worksheet.set_column("B:B", 15)  # Category
        worksheet.set_column("C:C", 30)  # Description
        worksheet.set_column("D:D", 15, money_format)  # Amount
        worksheet.set_column("E:E", 15)  # Wallet

    output.seek(0)
    return output

================
File: app/utils/notifications.py
================
from app import db
from app.models import Notification, Budget, Expense, User
from datetime import datetime
from app.utils.email import send_email
from flask import current_app
import logging

logger = logging.getLogger(__name__)


class NotificationManager:
    @staticmethod
    def check_budget_alerts(user_id):
        current_month = datetime.utcnow().month
        current_year = datetime.utcnow().year

        budgets = Budget.query.filter_by(
            user_id=user_id, month=current_month, year=current_year
        ).all()

        alerts = []
        for budget in budgets:
            expenses = (
                Expense.query.filter_by(user_id=user_id, category=budget.category)
                .filter(
                    db.extract("month", Expense.date) == current_month,
                    db.extract("year", Expense.date) == current_year,
                )
                .all()
            )

            total_spent = sum(e.amount for e in expenses)
            if budget.amount > 0:  # Prevent division by zero
                percentage = (total_spent / budget.amount) * 100
            else:
                percentage = 0

            if percentage >= 90:
                message = f"Cáº£nh bÃ¡o: Chi tiÃªu danh má»¥c {budget.category} Ä‘Ã£ Ä‘áº¡t {percentage:.1f}% ngÃ¢n sÃ¡ch"
                NotificationManager.create_notification(
                    user_id, "budget_alert", message
                )
                alerts.append(message)
                # Get user object for email
                user = User.query.get(user_id)
                if user:
                    NotificationManager.notify_budget_alert(
                        user, budget.category, percentage, total_spent, budget.amount
                    )

        return alerts

    @staticmethod
    def create_notification(user_id, type, message):
        notification = Notification(user_id=user_id, type=type, message=message)
        db.session.add(notification)
        try:
            db.session.commit()
        except Exception as e:
            db.session.rollback()
            logger.exception(
                f"Error creating notification: {e}"
            )  # Log the full traceback

    @staticmethod
    def mark_as_read(notification_id, user_id):
        notification = Notification.query.filter_by(
            id=notification_id, user_id=user_id
        ).first()

        if not notification:
            raise ValueError(
                f"Notification with id {notification_id} not found for user {user_id}"
            )

        notification.is_read = True
        db.session.commit()

    @staticmethod
    def notify_budget_alert(user, category, percentage, amount, budget_amount):
        message = (
            f"Cáº£nh bÃ¡o: Chi tiÃªu danh má»¥c {category} Ä‘Ã£ Ä‘áº¡t {percentage:.1f}% ngÃ¢n sÃ¡ch"
        )

        NotificationManager.create_notification(user.id, "budget_alert", message)

        if (
            current_app.config.get("NOTIFY_VIA_EMAIL")
            and hasattr(user, "email")
            and user.email
            and "mail" in current_app.extensions
        ):
            try:
                send_email(
                    subject="Cáº£nh bÃ¡o ngÃ¢n sÃ¡ch",
                    recipient=user.email,
                    template="budget_alert",
                    user=user,
                    category=category,
                    percentage=int(
                        round(percentage)
                    ),  # Use integer percentage in email
                    amount=amount,
                    budget_amount=budget_amount,
                )
            except Exception as e:
                logger.exception(f"Failed to send budget alert email: {e}")

    @staticmethod
    def notify_unusual_spending(user, category, amount, average):
        message = f"Chi tiÃªu báº¥t thÆ°á»ng: {amount:,.0f}â‚« cho {category}"

        NotificationManager.create_notification(user.id, "unusual_spending", message)

        if current_app.config["NOTIFY_VIA_EMAIL"]:
            try:
                send_email(
                    subject="Chi tiÃªu báº¥t thÆ°á»ng",
                    recipient=user.email,
                    template="unusual_spending",
                    user=user,
                    category=category,
                    amount=amount,
                    average=average,
                )
            except Exception as e:
                logger.exception(f"Failed to send unusual spending email: {e}")

================
File: app/utils/ocr.py
================
# app/utils/ocr.py
import cv2
import numpy as np
import pytesseract
import re
from datetime import datetime
import logging

logger = logging.getLogger(__name__)


class ReceiptOCR:
    def __init__(self):
        self.amount_pattern = r"(?:tá»•ng tiá»n|tá»•ng cá»™ng|total|thanh toÃ¡n|pháº£i tráº£)[\s:]*(?:VND|â‚«|Ä‘)?\s*([\d,\.]+)"
        # More robust date patterns (including time, and variations)
        self.date_patterns = [
            r"(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})\s*(\d{1,2}:\d{1,2}(?::\d{1,2})?)?",  # DD/MM/YYYY HH:MM:SS
            r"(\d{2,4})[/-](\d{1,2})[/-](\d{1,2})\s*(\d{1,2}:\d{1,2}(?::\d{1,2})?)?",  # YYYY/MM/DD HH:MM:SS
            r"(\d{1,2})\s+(thg|thÃ¡ng)\s+(\d{1,2})\s+(\d{2,4})\s*(\d{1,2}:\d{1,2}(?::\d{1,2})?)?",  # DD thg MM YYYY
            r"(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{2,4})\s*(\d{1,2}:\d{1,2}(?::\d{1,2})?)?",  # English date
        ]

    def process_image(self, image_data):
        try:
            nparr = np.frombuffer(image_data, np.uint8)
            img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
            if img is None:
                return {"error": "Failed to decode image."}

            gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

            # Adaptive thresholding is better for varying lighting
            thresh = cv2.adaptiveThreshold(
                gray, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY, 11, 2
            )
            # Try different preprocessing methods (combine for better results)
            # thresh = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)[1]
            # blur = cv2.GaussianBlur(gray, (3,3), 0)
            # thresh = cv2.threshold(blur, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)[1]

            text = pytesseract.image_to_string(thresh, lang="vie")  # Keep vietnamese

            amount = self._extract_amount(text)
            date = self._extract_date(text)

            return {"amount": amount, "date": date, "text": text}
        except Exception as e:
            logger.exception(f"Error during OCR processing: {e}")
            return {"error": "OCR processing failed."}

    def _extract_amount(self, text):
        text = text.lower()
        matches = re.findall(self.amount_pattern, text)
        if matches:
            amount_str = (
                matches[-1].replace(",", "").replace(".", "")
            )  # Use the LAST match
            try:
                return float(amount_str)
            except ValueError:
                return None
        return None

    def _extract_date(self, text):
        for pattern in self.date_patterns:
            match = re.search(pattern, text, re.IGNORECASE)
            if match:
                try:
                    # Handle different date formats
                    if len(match.groups()) >= 3:  # At least day, month, year
                        day, month, year = (
                            int(match.group(1)),
                            int(match.group(2)),
                            int(match.group(3)),
                        )

                        # Handle 2-digit years
                        if len(str(year)) == 2:
                            year = 2000 + year if year <= 99 else 1900 + year

                        # Handle time (if present)
                        time_str = match.group(4) if len(match.groups()) >= 4 else None
                        if time_str:
                            time_parts = [int(x) for x in time_str.split(":")]
                            hour, minute = time_parts[0], time_parts[1]
                            second = time_parts[2] if len(time_parts) == 3 else 0
                        else:
                            hour, minute, second = 0, 0, 0

                        return datetime(year, month, day, hour, minute, second)
                except ValueError:
                    continue  # Try the next pattern if this one fails
        return None

================
File: babel.cfg
================
[python: app/**.py]
[jinja2: app/**/templates/**.html]
extensions=jinja2.ext.do,jinja2.ext.i18n,jinja2.ext.loopcontrols

================
File: config.py
================
import os
from datetime import timedelta


class Config:
    SECRET_KEY = (
        os.environ.get("SECRET_KEY")
        or "dev-key-please-change-in-production-or-your-balls-will-explore-in-5-4-3-2-1"
    )
    SQLALCHEMY_DATABASE_URI = "sqlite:///moneykeeper.db"
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    PERMANENT_SESSION_LIFETIME = timedelta(minutes=99999)
    BABEL_DEFAULT_LOCALE = "vi"
    LANGUAGES = ["en", "vi"]
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB max file size
    MAIL_SERVER = "smtp.example.com"  # UPDATE WITH YOUR MAIL SERVER
    MAIL_PORT = 587
    MAIL_USE_TLS = True
    MAIL_USERNAME = os.environ.get("MAIL_USERNAME")
    MAIL_PASSWORD = os.environ.get("MAIL_PASSWORD")
    MAIL_DEFAULT_SENDER = os.environ.get(
        "MAIL_DEFAULT_SENDER", "noreply@moneykeeper.com"
    )
    NOTIFY_VIA_EMAIL = True

    AI_MODEL_NAME = "meta-llama/Llama-3.2-3B-Instruct"  # Updated model name


class DevelopmentConfig(Config):
    DEBUG = True


class ProductionConfig(Config):
    DEBUG = False


config = {
    "development": DevelopmentConfig,
    "production": ProductionConfig,
    "default": DevelopmentConfig,
}

================
File: manage.py
================
from flask.cli import FlaskGroup
from app import create_app, db
from app.models import User, Expense, Budget, Notification  # Import all your models!

app = create_app()
cli = FlaskGroup(app)


# Removed init_db, we'll use Flask-Migrate now
# @cli.command("init_db")
# def init_db():
#     """Initialize the database."""
#     db.drop_all()
#     db.create_all()
#     print("Initialized the database.")


@cli.command() # NEW COMMAND TO CREATE FIRST USER (ADMIN)
def create_admin():
    """Creates an admin user."""
    admin = User(username='admin', pin='2011') # SET DEFAULT ADMIN USER
    admin.set_password('SkyLine@@2025') # SET DEFAULT ADMIN PASSWORD
    db.session.add(admin)
    db.session.commit()
    print("Admin user created.")
if __name__ == "__main__":
    cli()

================
File: messages.pot
================
# Translations template for PROJECT.
# Copyright (C) 2025 ORGANIZATION
# This file is distributed under the same license as the PROJECT project.
# FIRST AUTHOR <EMAIL@ADDRESS>, 2025.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: PROJECT VERSION\n"
"Report-Msgid-Bugs-To: EMAIL@ADDRESS\n"
"POT-Creation-Date: 2025-02-19 04:16+0700\n"
"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
"Language-Team: LANGUAGE <LL@li.org>\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=utf-8\n"
"Content-Transfer-Encoding: 8bit\n"
"Generated-By: Babel 2.17.0\n"

#: app/auth/forms.py:19
msgid "Passwords must match"
msgstr ""

#: app/auth/forms.py:26
msgid "Username already exists."
msgstr ""

#: app/auth/routes.py:19
msgid "Invalid username or password"
msgstr ""

#: app/auth/routes.py:26
msgid "Sign In"
msgstr ""

#: app/auth/routes.py:40
msgid "Registration successful. Please login."
msgstr ""

#: app/auth/routes.py:42
msgid "Register"
msgstr ""

#: app/templates/base.html:30
msgid "Dashboard"
msgstr ""

#: app/templates/base.html:33
msgid "Reports"
msgstr ""

#: app/templates/base.html:36
msgid "Data Management"
msgstr ""

#: app/templates/main/dashboard.html:4
msgid "Recent Expenses"
msgstr ""

#: app/templates/main/dashboard.html:11
msgid "No description"
msgstr ""

#: app/templates/main/dashboard.html:23
msgid "No recent expenses"
msgstr ""

#: app/templates/main/dashboard.html:36
msgid "Category Overview"
msgstr ""

#: app/templates/main/dashboard.html:58
msgid "No categories defined"
msgstr ""

#: app/templates/main/dashboard.html:72
msgid "AI Insights"
msgstr ""

#: app/templates/main/dashboard.html:84
msgid "Recommended monthly budget"
msgstr ""

#: app/templates/main/dashboard.html:93
msgid "Spending Trends"
msgstr ""

#: app/templates/main/dashboard.html:99
msgid "Spending Analytics"
msgstr ""

#: app/templates/main/dashboard.html:120 app/templates/main/dashboard.html:172
msgid "Monthly Spending"
msgstr ""

#: app/templates/main/dashboard.html:160
msgid "Spending by Category"
msgstr ""

#: app/templates/main/settings.html:6
msgid "Settings"
msgstr ""

================
File: README.md
================
# Money Keeper - á»¨ng dá»¥ng Quáº£n lÃ½ Chi tiÃªu CÃ¡ nhÃ¢n ThÃ´ng minh

<!-- [![Build Status](https://img.shields.io/badge/build-passing-brightgreen.svg?style=for-the-badge)]() [![Python Version](https://img.shields.io/badge/python-3.7+-blue.svg?style=for-the-badge)](https://www.python.org/downloads/) do chÆ°a cáº§n nÃªn noclue xd -->

[![Flask](https://img.shields.io/badge/flask-%23000.svg?style=for-the-badge&logo=flask&logoColor=white)](https://flask.palletsprojects.com/) [![License](https://img.shields.io/badge/license-MIT-green.svg?style=for-the-badge)](https://opensource.org/licenses/MIT) [![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg?style=for-the-badge)](https://github.com/psf/black)
[![pre-commit](https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit&logoColor=white&style=for-the-badge)](https://github.com/pre-commit/pre-commit)
[![CodeFactor](https://www.codefactor.io/repository/github/catalizcs/moneykeeper/badge?style=for-the-badge)](https://www.codefactor.io/repository/github/catalizcs/moneykeeper)

Money Keeper lÃ  má»™t á»©ng dá»¥ng web giÃºp báº¡n theo dÃµi chi tiÃªu, láº­p ngÃ¢n sÃ¡ch vÃ  Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu tÃ i chÃ­nh má»™t cÃ¡ch dá»… dÃ ng vÃ  hiá»‡u quáº£. á»¨ng dá»¥ng Ä‘Æ°á»£c xÃ¢y dá»±ng vá»›i Python (Flask), SQLite, vÃ  tÃ­ch há»£p AI (LLM cá»¥c bá»™) Ä‘á»ƒ cung cáº¥p cÃ¡c tÃ­nh nÄƒng phÃ¢n tÃ­ch vÃ  gá»£i Ã½ thÃ´ng minh.

## TÃ­nh nÄƒng chÃ­nh

- **Ghi chÃ©p chi tiÃªu:** Ghi láº¡i cÃ¡c khoáº£n chi tiÃªu hÃ ng ngÃ y vÃ  phÃ¢n loáº¡i chÃºng.
- **Quáº£n lÃ½ vÃ­:** Táº¡o vÃ  quáº£n lÃ½ nhiá»u vÃ­ tiá»n (vÃ­ dá»¥: Tiá»n máº·t, TÃ i khoáº£n ngÃ¢n hÃ ng, v.v.).
- **Láº­p ngÃ¢n sÃ¡ch:** Äáº·t ngÃ¢n sÃ¡ch cho tá»«ng danh má»¥c chi tiÃªu.
- **PhÃ¢n tÃ­ch chi tiÃªu:** Nháº­n bÃ¡o cÃ¡o chi tiáº¿t, biá»ƒu Ä‘á»“ trá»±c quan vÃ  phÃ¢n tÃ­ch xu hÆ°á»›ng chi tiÃªu.
- **Trá»£ lÃ½ AI (MoneyKeeper AI):**
  - Tá»± Ä‘á»™ng phÃ¢n loáº¡i chi tiÃªu.
  - Äá» xuáº¥t ngÃ¢n sÃ¡ch.
  - PhÃ¢n tÃ­ch máº«u chi tiÃªu vÃ  Ä‘Æ°a ra lá»i khuyÃªn.
  - Tráº£ lá»i cÃ¡c cÃ¢u há»i liÃªn quan Ä‘áº¿n tÃ i chÃ­nh cÃ¡ nhÃ¢n (báº±ng tiáº¿ng Viá»‡t).
  - CÃ³ nhiá»u "tÃ­nh cÃ¡ch" (thÃ¢n thiá»‡n, nghiÃªm kháº¯c, hÃ i hÆ°á»›c).
- **Báº£o máº­t:** Sá»­ dá»¥ng mÃ£ PIN Ä‘á»ƒ báº£o vá»‡ dá»¯ liá»‡u (LÆ°u Ã½: Pháº§n mÃ´ táº£ cÃ³ nháº¯c Ä‘áº¿n PIN, nhÆ°ng hiá»‡n táº¡i code chÆ°a implement. Oni-chan cáº§n thÃªm tÃ­nh nÄƒng nÃ y).
- **Xuáº¥t/Nháº­p dá»¯ liá»‡u:** Xuáº¥t dá»¯ liá»‡u chi tiÃªu ra file Excel.
- **ThÃ´ng bÃ¡o:** Nháº­n thÃ´ng bÃ¡o khi chi tiÃªu gáº§n vÆ°á»£t quÃ¡ ngÃ¢n sÃ¡ch.
- **Giao diá»‡n:** Thiáº¿t káº¿ responsive, thÃ¢n thiá»‡n vá»›i ngÆ°á»i dÃ¹ng, há»— trá»£ tiáº¿ng Viá»‡t.
- **Single Page Application (SPA):** Tráº£i nghiá»‡m mÆ°á»£t mÃ , khÃ´ng cáº§n táº£i láº¡i trang.
- **PWA:** Há»— trá»£ cÃ i Ä‘áº·t nhÆ° má»™t á»©ng dá»¥ng trÃªn iOS (thÃªm vÃ o mÃ n hÃ¬nh chÃ­nh).
- **OCR:** Há»— trá»£ OCR Ä‘á»ƒ quÃ©t vÃ  tá»± Ä‘iá»n thÃ´ng tin tá»« hÃ³a Ä‘Æ¡n.

## YÃªu cáº§u

- Python 3.7+
- CÃ¡c thÆ° viá»‡n Python (xem file `requirements.txt`)
- Má»™t trÃ¬nh duyá»‡t web hiá»‡n Ä‘áº¡i (Chrome, Firefox, Safari, Edge)
- (TÃ¹y chá»n) CUDA-enabled GPU (Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ xá»­ lÃ½ AI, náº¿u khÃ´ng sáº½ dÃ¹ng CPU)

## CÃ i Ä‘áº·t

1.  **Clone repository:**

    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

    Thay `<repository_url>` báº±ng URL repository cá»§a báº¡n vÃ  `<repository_directory>` báº±ng tÃªn thÆ° má»¥c chá»©a project.

2.  **Táº¡o vÃ  kÃ­ch hoáº¡t virtual environment (tÃ¹y chá»n, nhÆ°ng ráº¥t khuyáº¿n khÃ­ch):**

    ```bash
    python3 -m venv venv
    source venv/bin/activate   # Linux/macOS
    venv\Scripts\activate    # Windows
    ```

3.  **CÃ i Ä‘áº·t dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

4.  **Táº£i model (náº¿u chÆ°a cÃ³):**

    - Táº¡o thÆ° má»¥c `models` á»Ÿ thÆ° má»¥c gá»‘c cá»§a project.
    - Táº£i model vá» vÃ  Ä‘áº·t vÃ o thÆ° má»¥c nÃ y (vÃ­ dá»¥: `models/Llama-3.2-3B-Instruct`)

      ```bash
         mkdir models
         cd models
         git lfs install
         git clone https://huggingface.co/meta-llama/Llama-3.2-3B-Instruct # VÃ­ dá»¥ download model
      ```

5.  **Khá»Ÿi táº¡o database (náº¿u cháº¡y láº§n Ä‘áº§u):**

    ```bash
    flask init-db
    ```

    Hoáº·c náº¿u Ä‘Ã£ cÃ³ dá»¯ liá»‡u

    ```
     flask create-tables
    ```

6.  (Optional) **Táº¡o tÃ i khoáº£n admin:**

    ```bash
    python manage.py create_admin
    ```

    (Sá»­a `manage.py` Ä‘á»ƒ thay Ä‘á»•i username/password máº·c Ä‘á»‹nh)

7.  **Cháº¡y á»©ng dá»¥ng:**

    ```bash
    python run.py
    ```

    á»¨ng dá»¥ng sáº½ cháº¡y trÃªn `http://localhost:8000` (hoáº·c `http://0.0.0.0:8000`).

## Sá»­ dá»¥ng

Truy cáº­p vÃ o localhost:8000 trÃªn trÃ¬nh duyá»‡t.

## Cáº¥u hÃ¬nh

- CÃ¡c tÃ¹y chá»n cáº¥u hÃ¬nh Ä‘Æ°á»£c Ä‘áº·t trong file `config.py`.
- Báº¡n cÃ³ thá»ƒ táº¡o cÃ¡c cáº¥u hÃ¬nh khÃ¡c nhau (vÃ­ dá»¥: `DevelopmentConfig`, `ProductionConfig`) vÃ  chá»n cáº¥u hÃ¬nh báº±ng cÃ¡ch set biáº¿n mÃ´i trÆ°á»ng `FLASK_ENV`. VÃ­ dá»¥:

  ```bash
  export FLASK_ENV=production  # hoáº·c set FLASK_DEBUG=0
  ```

- **Quan trá»ng:** Thay Ä‘á»•i `SECRET_KEY` trong `config.py` khi triá»ƒn khai á»©ng dá»¥ng trÃªn mÃ´i trÆ°á»ng production.

## Triá»ƒn khai (Deployment)

- **KhÃ´ng sá»­ dá»¥ng Werkzeug development server cho production.** Thay vÃ o Ä‘Ã³, hÃ£y sá»­ dá»¥ng má»™t WSGI server nhÆ° Gunicorn hoáº·c uWSGI. VÃ­ dá»¥, vá»›i Gunicorn:

  ```bash
  pip install gunicorn
  gunicorn --workers 4 --bind 0.0.0.0:8000 app:app  # Thay app:app náº¿u cáº§n
  ```

- Cáº¥u hÃ¬nh reverse proxy (vÃ­ dá»¥: Nginx) Ä‘á»ƒ xá»­ lÃ½ cÃ¡c static files vÃ  forward request Ä‘áº¿n Gunicorn.
- CÃ¢n nháº¯c sá»­ dá»¥ng HTTPS.
- Äáº£m báº£o ráº±ng thÆ° má»¥c `models` (chá»©a model AI) cÃ³ thá»ƒ truy cáº­p Ä‘Æ°á»£c bá»Ÿi á»©ng dá»¥ng.

## Contributing

(Pháº§n nÃ y Oni-chan tá»± viáº¿t nhÃ©, hÆ°á»›ng dáº«n cÃ¡ch ngÆ°á»i khÃ¡c cÃ³ thá»ƒ Ä‘Ã³ng gÃ³p cho project cá»§a Oni-chan, vÃ­ dá»¥: quy trÃ¬nh pull request, coding style, v.v.)

- Táº¡o má»™t nhÃ¡nh má»›i tá»« `main` (vÃ­ dá»¥: `feature/new-feature`, `bugfix/fix-bug`).
- Thá»±c hiá»‡n thay Ä‘á»•i trÃªn nhÃ¡nh cá»§a báº¡n.
- Viáº¿t test (náº¿u cÃ³).
- Äáº£m báº£o code tuÃ¢n thá»§ coding style (vÃ­ dá»¥: PEP 8).
- Táº¡o pull request vá» nhÃ¡nh `main`.
- MÃ´ táº£ rÃµ rÃ ng thay Ä‘á»•i cá»§a báº¡n trong pull request.

## License

MIT License

Copyright (c) [2025] [CatalizCS]

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

================
File: repomix.config.json
================
{
  "output": {
    "filePath": "repomix-output.txt",
    "style": "plain",
    "removeComments": false,
    "removeEmptyLines": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "copyToClipboard": false
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDefaultPatterns": true,
    "customPatterns": []
  },
  "security": {
    "enableSecurityCheck": true
  }
}

================
File: requirements.txt
================
# For PyTorch with CUDA support, run:
# pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

Flask
Flask-SQLAlchemy
Flask-Login
Flask-WTF
Flask-Migrate
Flask-Mail
Flask-Moment
flask_socketio
bcrypt
python-dotenv
numpy
pandas
scipy
scikit-learn
pytesseract
opencv-python
Pillow
APScheduler
plotly
XlsxWriter
Flask-Babel
transformers
tiktoken
transformers_stream_generator
einops
optimum[onnxruntime]
email_validator

================
File: run.py
================
from app import create_app, socketio

app = create_app()

print(f"SocketIO async_mode: {socketio.async_mode}")

if __name__ == "__main__":
    socketio.run(app, debug=True, host="0.0.0.0", port=8000, allow_unsafe_werkzeug=True)



================================================================
End of Codebase
================================================================
